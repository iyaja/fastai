<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tutorial - Assemble the data on the pets dataset</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="Welcome to fastai">
    <link rel="preload" href="/fastai/assets/css/0.styles.d03aadf4.css" as="style"><link rel="preload" href="/fastai/assets/js/app.f17b0f11.js" as="script"><link rel="preload" href="/fastai/assets/js/3.7e8af7b4.js" as="script"><link rel="preload" href="/fastai/assets/js/60.c377d394.js" as="script"><link rel="prefetch" href="/fastai/assets/js/10.8521128e.js"><link rel="prefetch" href="/fastai/assets/js/11.287f40d6.js"><link rel="prefetch" href="/fastai/assets/js/12.12842fbd.js"><link rel="prefetch" href="/fastai/assets/js/13.b531fd0e.js"><link rel="prefetch" href="/fastai/assets/js/14.3b85f440.js"><link rel="prefetch" href="/fastai/assets/js/15.015d175e.js"><link rel="prefetch" href="/fastai/assets/js/16.744581ff.js"><link rel="prefetch" href="/fastai/assets/js/17.5ea8f7a5.js"><link rel="prefetch" href="/fastai/assets/js/18.6325a7a3.js"><link rel="prefetch" href="/fastai/assets/js/19.12895d2e.js"><link rel="prefetch" href="/fastai/assets/js/20.421dab5c.js"><link rel="prefetch" href="/fastai/assets/js/21.d0965317.js"><link rel="prefetch" href="/fastai/assets/js/22.d4da69f5.js"><link rel="prefetch" href="/fastai/assets/js/23.eb6f27d0.js"><link rel="prefetch" href="/fastai/assets/js/24.7b39000f.js"><link rel="prefetch" href="/fastai/assets/js/25.4b2ae256.js"><link rel="prefetch" href="/fastai/assets/js/26.ed68ed51.js"><link rel="prefetch" href="/fastai/assets/js/27.fbc2137b.js"><link rel="prefetch" href="/fastai/assets/js/28.6c32e1f5.js"><link rel="prefetch" href="/fastai/assets/js/29.e8f4d3b8.js"><link rel="prefetch" href="/fastai/assets/js/30.f9987fa2.js"><link rel="prefetch" href="/fastai/assets/js/31.10dfab48.js"><link rel="prefetch" href="/fastai/assets/js/32.51ffa228.js"><link rel="prefetch" href="/fastai/assets/js/33.58064d56.js"><link rel="prefetch" href="/fastai/assets/js/34.ee932158.js"><link rel="prefetch" href="/fastai/assets/js/35.13e4d738.js"><link rel="prefetch" href="/fastai/assets/js/36.04e592b7.js"><link rel="prefetch" href="/fastai/assets/js/37.7cafae24.js"><link rel="prefetch" href="/fastai/assets/js/38.29b7b3ca.js"><link rel="prefetch" href="/fastai/assets/js/39.60cf076c.js"><link rel="prefetch" href="/fastai/assets/js/4.6279c390.js"><link rel="prefetch" href="/fastai/assets/js/40.ae925aa6.js"><link rel="prefetch" href="/fastai/assets/js/41.6f007865.js"><link rel="prefetch" href="/fastai/assets/js/42.ccc13ed7.js"><link rel="prefetch" href="/fastai/assets/js/43.2429f884.js"><link rel="prefetch" href="/fastai/assets/js/44.2d4ccb85.js"><link rel="prefetch" href="/fastai/assets/js/45.3c017ace.js"><link rel="prefetch" href="/fastai/assets/js/46.3caf88b0.js"><link rel="prefetch" href="/fastai/assets/js/47.a13286d5.js"><link rel="prefetch" href="/fastai/assets/js/48.551a5021.js"><link rel="prefetch" href="/fastai/assets/js/49.61f2131a.js"><link rel="prefetch" href="/fastai/assets/js/5.93fc1ade.js"><link rel="prefetch" href="/fastai/assets/js/50.372d1f7d.js"><link rel="prefetch" href="/fastai/assets/js/51.ed721b06.js"><link rel="prefetch" href="/fastai/assets/js/52.60718eb7.js"><link rel="prefetch" href="/fastai/assets/js/53.f65e2a2a.js"><link rel="prefetch" href="/fastai/assets/js/54.f9f76813.js"><link rel="prefetch" href="/fastai/assets/js/55.020bc688.js"><link rel="prefetch" href="/fastai/assets/js/56.c4856fc6.js"><link rel="prefetch" href="/fastai/assets/js/57.e115d83b.js"><link rel="prefetch" href="/fastai/assets/js/58.e58e0027.js"><link rel="prefetch" href="/fastai/assets/js/59.886eb077.js"><link rel="prefetch" href="/fastai/assets/js/6.5fa76b7a.js"><link rel="prefetch" href="/fastai/assets/js/61.d6a10937.js"><link rel="prefetch" href="/fastai/assets/js/62.3f1bbe72.js"><link rel="prefetch" href="/fastai/assets/js/63.ea143add.js"><link rel="prefetch" href="/fastai/assets/js/64.4abe956e.js"><link rel="prefetch" href="/fastai/assets/js/65.f1204af6.js"><link rel="prefetch" href="/fastai/assets/js/66.e5904312.js"><link rel="prefetch" href="/fastai/assets/js/67.72451568.js"><link rel="prefetch" href="/fastai/assets/js/68.f4b4d8e2.js"><link rel="prefetch" href="/fastai/assets/js/69.2ef62d06.js"><link rel="prefetch" href="/fastai/assets/js/7.3e251b44.js"><link rel="prefetch" href="/fastai/assets/js/70.892242aa.js"><link rel="prefetch" href="/fastai/assets/js/71.348a11dd.js"><link rel="prefetch" href="/fastai/assets/js/72.735683a9.js"><link rel="prefetch" href="/fastai/assets/js/73.61a8ce4c.js"><link rel="prefetch" href="/fastai/assets/js/74.cec16c32.js"><link rel="prefetch" href="/fastai/assets/js/75.c261240c.js"><link rel="prefetch" href="/fastai/assets/js/76.d69068d6.js"><link rel="prefetch" href="/fastai/assets/js/8.c3d5d69d.js"><link rel="prefetch" href="/fastai/assets/js/9.ffbd18f1.js"><link rel="prefetch" href="/fastai/assets/js/vendors~docsearch.f5584d80.js">
    <link rel="stylesheet" href="/fastai/assets/css/0.styles.d03aadf4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fastai/" class="home-link router-link-active"><img src="https://images.exxactcorp.com/CMS/landing-page/resource-center/supported-software/logo/Deep-Learning/fastai-logo.png" alt="" class="logo"> <!----></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow down"></span></button> <button type="button" aria-label="Getting Started" class="mobile-dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><!----> <a href="/fastai/quick_start.html" class="nav-link">
  Quick Start
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tutorials" class="dropdown-title"><span class="title">Tutorials</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tutorials" class="mobile-dropdown-title"><span class="title">Tutorials</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tutorial/overview.html" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><h4>
          Beginners
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/vision.html" class="nav-link">
  Vision Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/text.html" class="nav-link">
  Text Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/tabular.html" class="nav-link">
  Tabular Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/colab.html" class="nav-link">
  Colab Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Intermediate
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/datablock.html" class="nav-link">
  Data Block Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/imagenette.html" class="nav-link">
  Imagenette Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/pets.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Pets Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/transformers.html" class="nav-link">
  Transformers Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/wikitext.html" class="nav-link">
  Wikitext Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Advanced
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/siamese.html" class="nav-link">
  Siamese Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/dev-setup.html" class="nav-link">
  Developer Guide
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Training" class="dropdown-title"><span class="title">Training</span> <span class="arrow down"></span></button> <button type="button" aria-label="Training" class="mobile-dropdown-title"><span class="title">Training</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/training/learner.html" class="nav-link">
  Training Loop
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/optimizer.html" class="nav-link">
  Optimizer
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/metrics.html" class="nav-link">
  Metrics
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/interpret.html" class="nav-link">
  Interpretation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/distributed.html" class="nav-link">
  Distributed
</a></li><li class="dropdown-item"><h4>
          Callbacks
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/callback/core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/schedule.html" class="nav-link">
  Schedulers
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/hook.html" class="nav-link">
  Hooks and callbacks
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/fp16.html" class="nav-link">
  Mixed precision
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/mixup.html" class="nav-link">
  Mixup
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/cutmix.html" class="nav-link">
  Cutmix
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/tracker.html" class="nav-link">
  Tracker
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/training.html" class="nav-link">
  Training
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/rnn.html" class="nav-link">
  RNN
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/data.html" class="nav-link">
  Data
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/progress.html" class="nav-link">
  Progress
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Data" class="dropdown-title"><span class="title">Data</span> <span class="arrow down"></span></button> <button type="button" aria-label="Data" class="mobile-dropdown-title"><span class="title">Data</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/data/block.html" class="nav-link">
  Data Blocks
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/transforms.html" class="nav-link">
  Data Transforms
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/external.html" class="nav-link">
  Data External
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/core.html" class="nav-link">
  Data Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/load.html" class="nav-link">
  DataLoaders
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Core" class="dropdown-title"><span class="title">Core</span> <span class="arrow down"></span></button> <button type="button" aria-label="Core" class="mobile-dropdown-title"><span class="title">Core</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/torch_core.html" class="nav-link">
  PyTorch Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/layers.html" class="nav-link">
  Layers
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/vision/learner.html" class="nav-link">
  Vision Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/augment.html" class="nav-link">
  Vision Data Augmentation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/data.html" class="nav-link">
  Vision Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/core.html" class="nav-link">
  Vision Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/utils.html" class="nav-link">
  Vision Utils
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/widgets.html" class="nav-link">
  Vision Widgets
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/vision/models.xresnet.html" class="nav-link">
  XResNet
</a></li><li class="dropdown-subitem"><a href="/fastai/vision/models.unet.html" class="nav-link">
  UNet
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Text" class="dropdown-title"><span class="title">Text</span> <span class="arrow down"></span></button> <button type="button" aria-label="Text" class="mobile-dropdown-title"><span class="title">Text</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/text/core.html" class="nav-link">
  Text Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/data.html" class="nav-link">
  Text Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/learner.html" class="nav-link">
  Text Learner
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/text/models.core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.awdlstm.html" class="nav-link">
  AWD LSTM
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.qrnn.html" class="nav-link">
  QRNN
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tabular/core.html" class="nav-link">
  Tabular Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/data.html" class="nav-link">
  Tabular Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/learner.html" class="nav-link">
  Tabular Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/model.html" class="nav-link">
  Tabular Model
</a></li><li class="dropdown-item"><!----> <a href="/fastai/collab.html" class="nav-link">
  Collab
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Medical" class="dropdown-title"><span class="title">Medical</span> <span class="arrow down"></span></button> <button type="button" aria-label="Medical" class="mobile-dropdown-title"><span class="title">Medical</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/medical/imaging.html" class="nav-link">
  Medical imagery
</a></li><li class="dropdown-item"><!----> <a href="/fastai/medical/text.html" class="nav-link">
  Medical text
</a></li></ul></div></div> <a href="https://github.com/fastai/fastai" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow down"></span></button> <button type="button" aria-label="Getting Started" class="mobile-dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><!----> <a href="/fastai/quick_start.html" class="nav-link">
  Quick Start
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tutorials" class="dropdown-title"><span class="title">Tutorials</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tutorials" class="mobile-dropdown-title"><span class="title">Tutorials</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tutorial/overview.html" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><h4>
          Beginners
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/vision.html" class="nav-link">
  Vision Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/text.html" class="nav-link">
  Text Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/tabular.html" class="nav-link">
  Tabular Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/colab.html" class="nav-link">
  Colab Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Intermediate
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/datablock.html" class="nav-link">
  Data Block Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/imagenette.html" class="nav-link">
  Imagenette Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/pets.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Pets Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/transformers.html" class="nav-link">
  Transformers Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/wikitext.html" class="nav-link">
  Wikitext Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Advanced
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/siamese.html" class="nav-link">
  Siamese Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/dev-setup.html" class="nav-link">
  Developer Guide
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Training" class="dropdown-title"><span class="title">Training</span> <span class="arrow down"></span></button> <button type="button" aria-label="Training" class="mobile-dropdown-title"><span class="title">Training</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/training/learner.html" class="nav-link">
  Training Loop
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/optimizer.html" class="nav-link">
  Optimizer
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/metrics.html" class="nav-link">
  Metrics
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/interpret.html" class="nav-link">
  Interpretation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/distributed.html" class="nav-link">
  Distributed
</a></li><li class="dropdown-item"><h4>
          Callbacks
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/callback/core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/schedule.html" class="nav-link">
  Schedulers
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/hook.html" class="nav-link">
  Hooks and callbacks
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/fp16.html" class="nav-link">
  Mixed precision
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/mixup.html" class="nav-link">
  Mixup
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/cutmix.html" class="nav-link">
  Cutmix
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/tracker.html" class="nav-link">
  Tracker
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/training.html" class="nav-link">
  Training
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/rnn.html" class="nav-link">
  RNN
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/data.html" class="nav-link">
  Data
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/progress.html" class="nav-link">
  Progress
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Data" class="dropdown-title"><span class="title">Data</span> <span class="arrow down"></span></button> <button type="button" aria-label="Data" class="mobile-dropdown-title"><span class="title">Data</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/data/block.html" class="nav-link">
  Data Blocks
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/transforms.html" class="nav-link">
  Data Transforms
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/external.html" class="nav-link">
  Data External
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/core.html" class="nav-link">
  Data Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/load.html" class="nav-link">
  DataLoaders
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Core" class="dropdown-title"><span class="title">Core</span> <span class="arrow down"></span></button> <button type="button" aria-label="Core" class="mobile-dropdown-title"><span class="title">Core</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/torch_core.html" class="nav-link">
  PyTorch Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/layers.html" class="nav-link">
  Layers
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/vision/learner.html" class="nav-link">
  Vision Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/augment.html" class="nav-link">
  Vision Data Augmentation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/data.html" class="nav-link">
  Vision Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/core.html" class="nav-link">
  Vision Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/utils.html" class="nav-link">
  Vision Utils
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/widgets.html" class="nav-link">
  Vision Widgets
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/vision/models.xresnet.html" class="nav-link">
  XResNet
</a></li><li class="dropdown-subitem"><a href="/fastai/vision/models.unet.html" class="nav-link">
  UNet
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Text" class="dropdown-title"><span class="title">Text</span> <span class="arrow down"></span></button> <button type="button" aria-label="Text" class="mobile-dropdown-title"><span class="title">Text</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/text/core.html" class="nav-link">
  Text Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/data.html" class="nav-link">
  Text Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/learner.html" class="nav-link">
  Text Learner
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/text/models.core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.awdlstm.html" class="nav-link">
  AWD LSTM
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.qrnn.html" class="nav-link">
  QRNN
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tabular/core.html" class="nav-link">
  Tabular Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/data.html" class="nav-link">
  Tabular Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/learner.html" class="nav-link">
  Tabular Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/model.html" class="nav-link">
  Tabular Model
</a></li><li class="dropdown-item"><!----> <a href="/fastai/collab.html" class="nav-link">
  Collab
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Medical" class="dropdown-title"><span class="title">Medical</span> <span class="arrow down"></span></button> <button type="button" aria-label="Medical" class="mobile-dropdown-title"><span class="title">Medical</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/medical/imaging.html" class="nav-link">
  Medical imagery
</a></li><li class="dropdown-item"><!----> <a href="/fastai/medical/text.html" class="nav-link">
  Medical text
</a></li></ul></div></div> <a href="https://github.com/fastai/fastai" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Tutorial - Assemble the data on the pets dataset</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fastai/tutorial/pets.html#overview" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/fastai/tutorial/pets.html#processing-data" class="sidebar-link">Processing data</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fastai/tutorial/pets.html#transform" class="sidebar-link">Transform</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/pets.html#pipeline" class="sidebar-link">Pipeline</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/pets.html#creating-your-own-transform" class="sidebar-link">Creating your own Transform</a></li></ul></li><li><a href="/fastai/tutorial/pets.html#loading-the-pets-dataset-using-only-transform" class="sidebar-link">Loading the pets dataset using only Transform</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fastai/tutorial/pets.html#using-decodes-for-showing-processed-data" class="sidebar-link">Using decodes for showing processed data</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/pets.html#setting-up-the-internal-state-with-a-setups" class="sidebar-link">Setting up the internal state with a setups</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/pets.html#combining-our-transform-with-data-augmentation-in-a-pipeline" class="sidebar-link">Combining our Transform](https://fastcore.fast.ai/transform#Transform) with data augmentation in a [Pipeline.</a></li></ul></li><li><a href="/fastai/tutorial/pets.html#tfmdlists-and-datasets" class="sidebar-link">TfmdLists](/data.core.html#TfmdLists) and [Datasets</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fastai/tutorial/pets.html#one-pipeline-makes-a-tfmdlists" class="sidebar-link">One pipeline makes a TfmdLists</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/pets.html#traning-and-validation-set" class="sidebar-link">Traning and validation set</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/pets.html#getting-to-dataloaders" class="sidebar-link">Getting to DataLoaders</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/pets.html#using-datasets" class="sidebar-link">Using Datasets</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/pets.html#segmentation" class="sidebar-link">Segmentation</a></li></ul></li><li><a href="/fastai/tutorial/pets.html#adding-a-test-dataloader-for-inference" class="sidebar-link">Adding a test dataloader for inference</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tutorial-assemble-the-data-on-the-pets-dataset"><a href="#tutorial-assemble-the-data-on-the-pets-dataset" class="header-anchor">#</a> Tutorial - Assemble the data on the pets dataset</h1> <blockquote><p>Using <code>Datasets</code>, <code>Pipeline</code>, <code>TfmdLists</code> and <code>Transform</code> in computer vision</p></blockquote> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>In this tutorial, we look in depth at the middle level API for collecting data in computer vision. First we will see how to use:</p> <ul><li><a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to process the data</li> <li><a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to composes transforms</li></ul> <p>Those are just functions with added functionality. For dataset processing, we will look in a second part at</p> <ul><li><a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a> to apply one <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> of <code>Tranform</code>s on a collection of items</li> <li><a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a> to apply several <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> of <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s on a collection of items in parallel and produce tuples</li></ul> <p>The general rule is to use <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a> when your transforms will output the tuple (input,target) and <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a> when you build separate <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s for each of your input(s)/target(s).</p> <p>After this tutorial, you might be interested by the <a href="http://docs.fast.ai/tutorial.siamese" target="_blank" rel="noopener noreferrer">siamese tutorial<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that goes even more in depth in the data APIs, showing you how to write your custom types and how to customize the behavior of <code>show_batch</code> and <code>show_results</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastai<span class="token punctuation">.</span>vision<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
</code></pre></div><h2 id="processing-data"><a href="#processing-data" class="header-anchor">#</a> Processing data</h2> <p>Cleaning and processing data is one of the most time-consuming things in machine learning, which is why fastai tries to help you as much as it can. At its core, preparing the data for your model can be formalized as a sequence of transformations you apply to some raw items. For instance, in a classic image classification problem, we start with filenames. We have to open the corresponding images, resize them, convert them to tensors, maybe apply some kind of data augmentation, before we are ready to batch them. And that's just for the inputs of our model, for the targets, we need to extract the label of our filename and convert it to an integer.</p> <p>This process needs to be somewhat reversible, because we often want to inspect our data to double check what we feed the model actually makes sense. That's why fastai represents all those operations by <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s, which you can sometimes undo with a <code>decode</code> method.</p> <h3 id="transform"><a href="#transform" class="header-anchor">#</a> Transform</h3> <p>First we'll have a look at the basic steps using a single MNIST image. We'll start with a filename, and see step by step how it can be converted in to a labelled image that can be displayed and used for modeling. We use the usual <a href="/fastai/data.external.html#untar_data"><code>untar_data</code></a> to download our dataset (if necessary) and get all the image files:</p> <div class="language-python extra-class"><pre class="language-python"><code>source <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>MNIST_TINY<span class="token punctuation">)</span><span class="token operator">/</span><span class="token string">'train'</span>
items <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>source<span class="token punctuation">)</span>
fn <span class="token operator">=</span> items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> fn
</code></pre></div><div class="language- extra-class"><pre><code>Path('/home/sgugger/.fastai/data/mnist_tiny/train/3/7861.png')
</code></pre></div><p>We'll look at each <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> needed in turn. Here's how we can open an image file:</p> <div class="language-python extra-class"><pre class="language-python"><code>img <span class="token operator">=</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span> img
</code></pre></div><p><img src="output_10_0.png" alt="png"></p> <p>Then we can convert it to a <code>C*H*W</code> tensor (for channel x height x width, which is the convention in PyTorch):</p> <div class="language-python extra-class"><pre class="language-python"><code>tconv <span class="token operator">=</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span>
img <span class="token operator">=</span> tconv<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
img<span class="token punctuation">.</span>shape<span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>(torch.Size([3, 28, 28]), fastai.torch_core.TensorImage)
</code></pre></div><p>Now that's done, we can create our labels. First extracting the text label:</p> <div class="language-python extra-class"><pre class="language-python"><code>lbl <span class="token operator">=</span> parent_label<span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span> lbl
</code></pre></div><div class="language- extra-class"><pre><code>'3'
</code></pre></div><p>And then converting to an int for modeling:</p> <div class="language-python extra-class"><pre class="language-python"><code>tcat <span class="token operator">=</span> Categorize<span class="token punctuation">(</span>vocab<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'7'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
lbl <span class="token operator">=</span> tcat<span class="token punctuation">(</span>lbl<span class="token punctuation">)</span><span class="token punctuation">;</span> lbl
</code></pre></div><div class="language- extra-class"><pre><code>TensorCategory(0)
</code></pre></div><p>We use <code>decode</code> to reverse transforms for display. Reversing the <a href="/fastai/data.transforms.html#Categorize"><code>Categorize</code></a> transform result in a class name we can display:</p> <div class="language-python extra-class"><pre class="language-python"><code>lbld <span class="token operator">=</span> tcat<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>lbl<span class="token punctuation">)</span>
lbld
</code></pre></div><div class="language- extra-class"><pre><code>'3'
</code></pre></div><h3 id="pipeline"><a href="#pipeline" class="header-anchor">#</a> Pipeline</h3> <p>We can compose our image steps using <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>pipe <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">,</span>tconv<span class="token punctuation">]</span><span class="token punctuation">)</span>
img <span class="token operator">=</span> pipe<span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
img<span class="token punctuation">.</span>shape
</code></pre></div><div class="language- extra-class"><pre><code>torch.Size([3, 28, 28])
</code></pre></div><p>A <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> can decode and show an item.</p> <div class="language-python extra-class"><pre class="language-python"><code>pipe<span class="token punctuation">.</span>show<span class="token punctuation">(</span>img<span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'Greys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="output_23_0.png" alt="png"></p> <p>The show method works behind the scenes with types. Transforms will make sure the type of an element they receive is preserved. Here <a href="/fastai/vision.core.html#PILImage.create"><code>PILImage.create</code></a> returns a <a href="/fastai/vision.core.html#PILImage"><code>PILImage</code></a>, which knows how to show itself. <code>tconv</code> converts it to a <a href="/fastai/torch_core.html#TensorImage"><code>TensorImage</code></a>, which also knows how to show itself.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token builtin">type</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>fastai.torch_core.TensorImage
</code></pre></div><p>Those types are also used to enable different behaviors depending on the input received (for instance you don't do data augmentation the same way on an image, a segmentation mask or a bounding box).</p> <h3 id="creating-your-own-transform"><a href="#creating-your-own-transform" class="header-anchor">#</a> Creating your own <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h3> <p>Creating your own <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is way easier than you think. In fact, each time you have passed a label function to the data block API or to <a href="/fastai/vision.data.html#ImageDataLoaders.from_name_func"><code>ImageDataLoaders.from_name_func</code></a>, you have created a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> without knowing it. At its base, a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is just a function. Let's show how you can easily add a transform by implementing one that wraps a data augmentation from the <a href="https://github.com/albumentations-team/albumentations" target="_blank" rel="noopener noreferrer">albumentations library<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>First things first, you will need to install the albumentations library. Uncomment the following cell to do so if needed:</p> <div class="language-python extra-class"><pre class="language-python"><code>
</code></pre></div><p>Then it's going to be easier to see the result of the transform on a color image bigger than the mnist one we had before, so let's load something from the PETS dataset.</p> <div class="language-python extra-class"><pre class="language-python"><code>source <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>PETS<span class="token punctuation">)</span>
items <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>source<span class="token operator">/</span><span class="token string">&quot;images&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>We can still open it with <code>PILIlmage.create</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>img <span class="token operator">=</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
img
</code></pre></div><p><img src="output_33_0.png" alt="png"></p> <p>We will show how to wrap one transform, but you can as easily wrap any set of transforms you wrapped in a <code>Compose</code> method. Here let's do some <code>ShiftScaleRotate</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> albumentations <span class="token keyword">import</span> ShiftScaleRotate
</code></pre></div><p>The albumentations transform work on numpy images, so we just convert our <a href="/fastai/vision.core.html#PILImage"><code>PILImage</code></a> to a numpy array before wrapping it back in <a href="/fastai/vision.core.html#PILImage.create"><code>PILImage.create</code></a> (this function takes filenames as well as arrays or tensors).</p> <div class="language-python extra-class"><pre class="language-python"><code>aug <span class="token operator">=</span> ShiftScaleRotate<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">aug_tfm</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    np_img <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    aug_img <span class="token operator">=</span> aug<span class="token punctuation">(</span>image<span class="token operator">=</span>np_img<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>aug_img<span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>aug_tfm<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
</code></pre></div><p><img src="output_38_0.png" alt="png"></p> <p>We can pass this function each time a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is expected and the fastai library will automatically do the conversion. That's because you can directly pass such a function to create a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>tfm <span class="token operator">=</span> Transform<span class="token punctuation">(</span>aug_tfm<span class="token punctuation">)</span>
</code></pre></div><p>If you have some state in your transform, you might want to create a subclass of <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. In that case, the function you want to apply should be written in the <code>encodes</code> method (the same way you implement <code>forward</code> for PyTorch module):</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">AlbumentationsTransform</span><span class="token punctuation">(</span>Transform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> aug<span class="token punctuation">)</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>aug <span class="token operator">=</span> aug
    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">:</span> PILImage<span class="token punctuation">)</span><span class="token punctuation">:</span>
        aug_img <span class="token operator">=</span> self<span class="token punctuation">.</span>aug<span class="token punctuation">(</span>image<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>aug_img<span class="token punctuation">)</span>
</code></pre></div><p>We also added a type annotation: this will make sure this transform is only applied to <a href="/fastai/vision.core.html#PILImage"><code>PILImage</code></a>s and their subclasses. For any other object, it won't do anything. You can also write as many <code>encodes</code> method you want with different type-annotations and the <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> will properly dispatch the objects it receives.</p> <p>This is because in practice, the transform is often applied as an <code>item_tfms</code> (or a <code>batch_tfms</code>) that you pass in the data block API. Those items are a tuple of objects of different types, and the transform may have different behaviors on each part of the tuple.</p> <p>Let's check here how this works:</p> <div class="language-python extra-class"><pre class="language-python"><code>tfm <span class="token operator">=</span> AlbumentationsTransform<span class="token punctuation">(</span>ShiftScaleRotate<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
a<span class="token punctuation">,</span>b <span class="token operator">=</span> tfm<span class="token punctuation">(</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
show_image<span class="token punctuation">(</span>a<span class="token punctuation">,</span> title<span class="token operator">=</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="output_44_0.png" alt="png"></p> <p>The transform was applied over the tuple <code>(img, &quot;dog&quot;)</code>. <code>img</code> is a <a href="/fastai/vision.core.html#PILImage"><code>PILImage</code></a>, so it applied the <code>encodes</code> method we wrote. <code>&quot;dog&quot;</code> is a string, so the transform did nothing to it.</p> <p>Sometimes however, you need your transform to take your tuple as whole: for instance albumentations is applied simultaneously on images and segmentation masks. In this case you need to subclass <code>ItemTransfrom</code> instead of <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Let's see how this works:</p> <div class="language-python extra-class"><pre class="language-python"><code>cv_source <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>CAMVID_TINY<span class="token punctuation">)</span>
cv_items <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>cv_source<span class="token operator">/</span><span class="token string">'images'</span><span class="token punctuation">)</span>
img <span class="token operator">=</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>cv_items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
mask <span class="token operator">=</span> PILMask<span class="token punctuation">.</span>create<span class="token punctuation">(</span>cv_source<span class="token operator">/</span><span class="token string">'labels'</span><span class="token operator">/</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>cv_items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>stem<span class="token punctuation">}</span></span><span class="token string">_P</span><span class="token interpolation"><span class="token punctuation">{</span>cv_items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>suffix<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
ax <span class="token operator">=</span> img<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
ax <span class="token operator">=</span> mask<span class="token punctuation">.</span>show<span class="token punctuation">(</span>ctx<span class="token operator">=</span>ax<span class="token punctuation">)</span>
</code></pre></div><p><img src="output_46_0.png" alt="png"></p> <p>We then write a subclass of <a href="https://fastcore.fast.ai/transform#ItemTransform" target="_blank" rel="noopener noreferrer"><code>ItemTransform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that can wrap any albumentations augmentation transform, but only for a segmentation problem:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SegmentationAlbumentationsTransform</span><span class="token punctuation">(</span>ItemTransform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> aug<span class="token punctuation">)</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>aug <span class="token operator">=</span> aug
    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img<span class="token punctuation">,</span>mask <span class="token operator">=</span> x
        aug <span class="token operator">=</span> self<span class="token punctuation">.</span>aug<span class="token punctuation">(</span>image<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>aug<span class="token punctuation">[</span><span class="token string">&quot;image&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PILMask<span class="token punctuation">.</span>create<span class="token punctuation">(</span>aug<span class="token punctuation">[</span><span class="token string">&quot;mask&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>And we can check how it gets applied on the tuple <code>(img, mask)</code>. This means you can pass it as an <code>item_tfms</code> in any segmentation problem.</p> <div class="language-python extra-class"><pre class="language-python"><code>tfm <span class="token operator">=</span> SegmentationAlbumentationsTransform<span class="token punctuation">(</span>ShiftScaleRotate<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
a<span class="token punctuation">,</span>b <span class="token operator">=</span> tfm<span class="token punctuation">(</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">)</span>
ax <span class="token operator">=</span> a<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
ax <span class="token operator">=</span> b<span class="token punctuation">.</span>show<span class="token punctuation">(</span>ctx<span class="token operator">=</span>ax<span class="token punctuation">)</span>
</code></pre></div><p><img src="output_50_0.png" alt="png"></p> <p>There is more you can implement in a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>: you can reverse it's behavior by adding a <code>decodes</code> and <code>setup</code> some state, we'll look at this in the next section:</p> <h2 id="loading-the-pets-dataset-using-only-transform"><a href="#loading-the-pets-dataset-using-only-transform" class="header-anchor">#</a> Loading the pets dataset using only <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h2> <p>Let's see how to use <code>fastai.data</code> to process the Pets dataset. If you are used to writing your own PyTorch <code>Dataset</code>s, what will feel more natural is to write everything in one <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. We use <em>source</em> to refer to the underlying source of our data (e.g. a directory on disk, a database connection, a network connection, etc). Then we grab the items.</p> <div class="language-python extra-class"><pre class="language-python"><code>source <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>PETS<span class="token punctuation">)</span><span class="token operator">/</span><span class="token string">&quot;images&quot;</span>
items <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>source<span class="token punctuation">)</span>
</code></pre></div><p>We'll use this function to create consistently sized tensors from image files:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">resized_image</span><span class="token punctuation">(</span>fn<span class="token punctuation">:</span>Path<span class="token punctuation">,</span> sz<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Convert image to tensor for modeling</span>
    <span class="token keyword">return</span> tensor<span class="token punctuation">(</span>array<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">.</span>
</code></pre></div><p>Before we can create a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, we need a type that knows how to show itself (if we want to use the show method). Here we define a <code>TitledImage</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">TitledImage</span><span class="token punctuation">(</span>fastuple<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ctx<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span> show_titled_image<span class="token punctuation">(</span>self<span class="token punctuation">,</span> ctx<span class="token operator">=</span>ctx<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
</code></pre></div><p>Let's check it works:</p> <div class="language-python extra-class"><pre class="language-python"><code>img <span class="token operator">=</span> resized_image<span class="token punctuation">(</span>items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
TitledImage<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token string">'test title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_60_0.png" alt="png"></p> <h3 id="using-decodes-for-showing-processed-data"><a href="#using-decodes-for-showing-processed-data" class="header-anchor">#</a> Using decodes for showing processed data</h3> <p>To decode data for showing purposes (like de-normalizing an image or converting back an index to its corresponding class), we implement a <code>decodes</code> method inside a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">PetTfm</span><span class="token punctuation">(</span>Transform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vocab<span class="token punctuation">,</span> o2i<span class="token punctuation">,</span> lblr<span class="token punctuation">)</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>vocab<span class="token punctuation">,</span>self<span class="token punctuation">.</span>o2i<span class="token punctuation">,</span>self<span class="token punctuation">.</span>lblr <span class="token operator">=</span> vocab<span class="token punctuation">,</span>o2i<span class="token punctuation">,</span>lblr
    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token punctuation">[</span>resized_image<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>o2i<span class="token punctuation">[</span>self<span class="token punctuation">.</span>lblr<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token keyword">def</span> <span class="token function">decodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> TitledImage<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>vocab<span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>The <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> opens and resizes the images on one side, label it and convert that label to an index using <code>o2i</code> on the other side. Inside the <code>decodes</code> method, we decode the index using the <code>vocab</code>. The image is left as is (we can't really show a filename!).</p> <p>To use this <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, we need a label function. Here we use a regex on the <code>name</code> attribute of our filenames:</p> <div class="language-python extra-class"><pre class="language-python"><code>labeller <span class="token operator">=</span> using_attr<span class="token punctuation">(</span>RegexLabeller<span class="token punctuation">(</span>pat <span class="token operator">=</span> <span class="token string">r'^(.*)_\d+.jpg$'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>
</code></pre></div><p>Then we gather all the possible labels, uniqueify them and ask for the two correspondences (vocab and o2i) using <code>bidir=True</code>. We can then use them to build our pet transform.</p> <div class="language-python extra-class"><pre class="language-python"><code>vals <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span>labeller<span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">)</span>
vocab<span class="token punctuation">,</span>o2i <span class="token operator">=</span> uniqueify<span class="token punctuation">(</span>vals<span class="token punctuation">,</span> sort<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> bidir<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
pets <span class="token operator">=</span> PetTfm<span class="token punctuation">(</span>vocab<span class="token punctuation">,</span>o2i<span class="token punctuation">,</span>labeller<span class="token punctuation">)</span>
</code></pre></div><p>We can check how it's applied to a filename:</p> <div class="language-python extra-class"><pre class="language-python"><code>x<span class="token punctuation">,</span>y <span class="token operator">=</span> pets<span class="token punctuation">(</span>items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
x<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>y
</code></pre></div><div class="language- extra-class"><pre><code>(torch.Size([3, 128, 128]), 36)
</code></pre></div><p>And we can decode our transformed version and show it:</p> <div class="language-python extra-class"><pre class="language-python"><code>dec <span class="token operator">=</span> pets<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span>
dec<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_71_0.png" alt="png"></p> <p>Note that like <code>__call__</code> and <code>encodes</code>, we implemented a <code>decodes</code> method but we actually call <code>decode</code> on our <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Also note that our <code>decodes</code> method received the two objects (x and y). We said in the previous section <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> dispatch over tuples (for the encoding as well as the decodeing) but here it took our two elements as a whole and did not try to decode x and y separately. Why is that? It's because we pass a list <code>[x,y]</code> to decodes. <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s dispatch over tuples, but tuples only. And as we saw as well, to prevent a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> from dispatching over a tuple, we just have to make it an <a href="https://fastcore.fast.ai/transform#ItemTransform" target="_blank" rel="noopener noreferrer"><code>ItemTransform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">PetTfm</span><span class="token punctuation">(</span>ItemTransform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vocab<span class="token punctuation">,</span> o2i<span class="token punctuation">,</span> lblr<span class="token punctuation">)</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>vocab<span class="token punctuation">,</span>self<span class="token punctuation">.</span>o2i<span class="token punctuation">,</span>self<span class="token punctuation">.</span>lblr <span class="token operator">=</span> vocab<span class="token punctuation">,</span>o2i<span class="token punctuation">,</span>lblr
    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>resized_image<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>o2i<span class="token punctuation">[</span>self<span class="token punctuation">.</span>lblr<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">decodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> TitledImage<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>vocab<span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dec <span class="token operator">=</span> pets<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>pets<span class="token punctuation">(</span>items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
dec<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_74_0.png" alt="png"></p> <h3 id="setting-up-the-internal-state-with-a-setups"><a href="#setting-up-the-internal-state-with-a-setups" class="header-anchor">#</a> Setting up the internal state with a setups</h3> <p>We can now let's make our <a href="https://fastcore.fast.ai/transform#ItemTransform" target="_blank" rel="noopener noreferrer"><code>ItemTransform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> automatically state its state form the data. This way, when we combine together our <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> with the data, it will automatically get setup without having to do anything. This is very easy to do: just copy the lines we had before to build the categories inside the transform in a <code>setups</code> method:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">PetTfm</span><span class="token punctuation">(</span>ItemTransform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">setups</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>labeller <span class="token operator">=</span> using_attr<span class="token punctuation">(</span>RegexLabeller<span class="token punctuation">(</span>pat <span class="token operator">=</span> <span class="token string">r'^(.*)_\d+.jpg$'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>
        vals <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>labeller<span class="token punctuation">,</span> items<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>vocab<span class="token punctuation">,</span>self<span class="token punctuation">.</span>o2i <span class="token operator">=</span> uniqueify<span class="token punctuation">(</span>vals<span class="token punctuation">,</span> sort<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> bidir<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>resized_image<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>o2i<span class="token punctuation">[</span>self<span class="token punctuation">.</span>labeller<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">decodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> TitledImage<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>vocab<span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>Now we can create our <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, call its setup, and it will be ready to be used:</p> <div class="language-python extra-class"><pre class="language-python"><code>pets <span class="token operator">=</span> PetTfm<span class="token punctuation">(</span><span class="token punctuation">)</span>
pets<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>items<span class="token punctuation">)</span>
x<span class="token punctuation">,</span>y <span class="token operator">=</span> pets<span class="token punctuation">(</span>items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
x<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> y
</code></pre></div><div class="language- extra-class"><pre><code>(torch.Size([3, 128, 128]), 36)
</code></pre></div><p>And like before, there is no problem to decode it:</p> <div class="language-python extra-class"><pre class="language-python"><code>dec <span class="token operator">=</span> pets<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
dec<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_81_0.png" alt="png"></p> <h3 id="combining-our-transform-with-data-augmentation-in-a-pipeline"><a href="#combining-our-transform-with-data-augmentation-in-a-pipeline" class="header-anchor">#</a> Combining our <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> with data augmentation in a <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</h3> <p>We can take advantage of fastai's data augmentation transforms if we give the right type to our elements. Instead of returning a standard <code>PIL.Image</code>, if our transform returns the fastai type <a href="/fastai/vision.core.html#PILImage"><code>PILImage</code></a>, we can then use any fastai's transform with it. Let's just return a <a href="/fastai/vision.core.html#PILImage"><code>PILImage</code></a> for our first element:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">PetTfm</span><span class="token punctuation">(</span>ItemTransform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">setups</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>labeller <span class="token operator">=</span> using_attr<span class="token punctuation">(</span>RegexLabeller<span class="token punctuation">(</span>pat <span class="token operator">=</span> <span class="token string">r'^(.*)_\d+.jpg$'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>
        vals <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>labeller<span class="token punctuation">,</span> items<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>vocab<span class="token punctuation">,</span>self<span class="token punctuation">.</span>o2i <span class="token operator">=</span> uniqueify<span class="token punctuation">(</span>vals<span class="token punctuation">,</span> sort<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> bidir<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>o2i<span class="token punctuation">[</span>self<span class="token punctuation">.</span>labeller<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">decodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> TitledImage<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>vocab<span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>We can then combine that transform with <a href="/fastai/data.transforms.html#ToTensor"><code>ToTensor</code></a>, <a href="/fastai/vision.augment.html#Resize"><code>Resize</code></a> or <a href="/fastai/vision.augment.html#FlipItem"><code>FlipItem</code></a> to randomly flip our image in a <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>tfms <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span>PetTfm<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FlipItem<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>Calling <code>setup</code> on a <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> will set each transform in order:</p> <div class="language-python extra-class"><pre class="language-python"><code>tfms<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>items<span class="token punctuation">)</span>
</code></pre></div><p>To check the setup was done properly, we want to see if we did build the vocab. One cool trick of <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is that when asking for an attribute, it will look through each of its <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s for that attribute and give you the result (or the list of results if the attribute is in multiple transforms):</p> <div class="language-python extra-class"><pre class="language-python"><code>tfms<span class="token punctuation">.</span>vocab
</code></pre></div><div class="language- extra-class"><pre><code>(#37) ['Abyssinian','Bengal','Birman','Bombay','British_Shorthair','Egyptian_Mau','Maine_Coon','Persian','Ragdoll','Russian_Blue'...]
</code></pre></div><p>Then we can call our pipeline:</p> <div class="language-python extra-class"><pre class="language-python"><code>x<span class="token punctuation">,</span>y <span class="token operator">=</span> tfms<span class="token punctuation">(</span>items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
x<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>y
</code></pre></div><div class="language- extra-class"><pre><code>(torch.Size([3, 224, 224]), 36)
</code></pre></div><p>We can see <a href="/fastai/data.transforms.html#ToTensor"><code>ToTensor</code></a> and <a href="/fastai/vision.augment.html#Resize"><code>Resize</code></a> were applied to the first element of our tuple (which was of type <a href="/fastai/vision.core.html#PILImage"><code>PILImage</code></a>) but not the second. We can even have a look at our element to check the flip was also applied:</p> <div class="language-python extra-class"><pre class="language-python"><code>tfms<span class="token punctuation">.</span>show<span class="token punctuation">(</span>tfms<span class="token punctuation">(</span>items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_94_0.png" alt="png"></p> <p><a href="https://fastcore.fast.ai/transform#Pipeline.show" target="_blank" rel="noopener noreferrer"><code>Pipeline.show</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> will call decode on each <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> until it gets a type that knows how to show itself. The library considers a tuple as knowing how to show itself if all its parts have a <code>show</code> method. Here it does not happen before reaching <code>PetTfm</code> since the second part of our tuple is an int. But after decoding the original <code>PetTfm</code>, we get a <code>TitledImage</code> which has a <code>show</code> method.</p> <p>It's a good point to note that the <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s of the <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> are sorted by their internal <code>order</code> attribute (with a default of <code>order=0</code>). You can always check the order in which the transforms are in a <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> by looking at its representation:</p> <div class="language-python extra-class"><pre class="language-python"><code>tfms
</code></pre></div><div class="language- extra-class"><pre><code>Pipeline: PetTfm -&gt; FlipItem -&gt; Resize -&gt; ToTensor
</code></pre></div><p>Even if we define <code>tfms</code> with <a href="/fastai/vision.augment.html#Resize"><code>Resize</code></a> before <a href="/fastai/vision.augment.html#FlipItem"><code>FlipItem</code></a>, we can see they have been reordered because we have:</p> <div class="language-python extra-class"><pre class="language-python"><code>FlipItem<span class="token punctuation">.</span>order<span class="token punctuation">,</span>Resize<span class="token punctuation">.</span>order
</code></pre></div><div class="language- extra-class"><pre><code>(0, 1)
</code></pre></div><p>To customize the order of a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, just set <code>order = ...</code> before the <code>__init__</code> (it's a class attribute). Let's make <code>PetTfm</code> of order -5 to be sure it's always run first:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">PetTfm</span><span class="token punctuation">(</span>ItemTransform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    order <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">5</span>
    <span class="token keyword">def</span> <span class="token function">setups</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>labeller <span class="token operator">=</span> using_attr<span class="token punctuation">(</span>RegexLabeller<span class="token punctuation">(</span>pat <span class="token operator">=</span> <span class="token string">r'^(.*)_\d+.jpg$'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>
        vals <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>labeller<span class="token punctuation">,</span> items<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>vocab<span class="token punctuation">,</span>self<span class="token punctuation">.</span>o2i <span class="token operator">=</span> uniqueify<span class="token punctuation">(</span>vals<span class="token punctuation">,</span> sort<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> bidir<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>o2i<span class="token punctuation">[</span>self<span class="token punctuation">.</span>labeller<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">decodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> TitledImage<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>vocab<span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>Then we can mess up the order of the transforms in our <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> but it will fix itself:</p> <div class="language-python extra-class"><pre class="language-python"><code>tfms <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span>Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PetTfm<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FlipItem<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
tfms
</code></pre></div><div class="language- extra-class"><pre><code>Pipeline: PetTfm -&gt; FlipItem -&gt; Resize -&gt; ToTensor
</code></pre></div><p>Now that we have a good <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> of transforms, let's add it to a list of filenames to build our dataset. A <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> combined with a collection is a <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a> in fastai.</p> <h2 id="tfmdlists-and-datasets"><a href="#tfmdlists-and-datasets" class="header-anchor">#</a> <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a> and <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a></h2> <p>The main difference between <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a> and <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a> is the number of <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s you have: <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a> take one <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to transform a list (like we currently have) whereas <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a> combines several <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s in parallel to create a tuple from one set of raw items, for instance a tuple (input, target).</p> <h3 id="one-pipeline-makes-a-tfmdlists"><a href="#one-pipeline-makes-a-tfmdlists" class="header-anchor">#</a> One pipeline makes a <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a></h3> <p>Creating a <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a> just requires a list of items and a list of transforms that will be combined in a <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>tls <span class="token operator">=</span> TfmdLists<span class="token punctuation">(</span>items<span class="token punctuation">,</span> <span class="token punctuation">[</span>Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PetTfm<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FlipItem<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
x<span class="token punctuation">,</span>y <span class="token operator">=</span> tls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
x<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>y
</code></pre></div><div class="language- extra-class"><pre><code>(torch.Size([3, 224, 224]), 36)
</code></pre></div><p>We did not need to pass anything to <code>PetTfm</code> thanks to our setup method: the <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> was automatically setup on the <code>items</code> during the initialization, so <code>PetTfm</code> has created its vocab like before:</p> <div class="language-python extra-class"><pre class="language-python"><code>tls<span class="token punctuation">.</span>vocab
</code></pre></div><div class="language- extra-class"><pre><code>(#37) ['Abyssinian','Bengal','Birman','Bombay','British_Shorthair','Egyptian_Mau','Maine_Coon','Persian','Ragdoll','Russian_Blue'...]
</code></pre></div><p>We can ask the <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a> to show the items we got:</p> <div class="language-python extra-class"><pre class="language-python"><code>tls<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_112_0.png" alt="png"></p> <p>Or we have a shortcut with <a href="/fastai/data.core.html#show_at"><code>show_at</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>show_at<span class="token punctuation">(</span>tls<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_114_0.png" alt="png"></p> <h3 id="traning-and-validation-set"><a href="#traning-and-validation-set" class="header-anchor">#</a> Traning and validation set</h3> <p><a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a> has an 's' in its name because it can represent several transformed lists: your training and validation sets. To use that functionality, we just need to pass <code>splits</code> to the initialization. <code>splits</code> should be a list of lists of indices (one list per set). To help create splits, we can use all the <em>splitters</em> of the fastai library:</p> <div class="language-python extra-class"><pre class="language-python"><code>splits <span class="token operator">=</span> RandomSplitter<span class="token punctuation">(</span>seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>
splits
</code></pre></div><div class="language- extra-class"><pre><code>((#5912) [5643,5317,5806,3460,613,5456,2968,3741,10,4908...],
 (#1478) [4512,4290,5770,706,2200,4320,6450,501,1290,6435...])
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>tls <span class="token operator">=</span> TfmdLists<span class="token punctuation">(</span>items<span class="token punctuation">,</span> <span class="token punctuation">[</span>Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PetTfm<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FlipItem<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> splits<span class="token operator">=</span>splits<span class="token punctuation">)</span>
</code></pre></div><p>Then your <code>tls</code> get a train and valid attributes (it also had them before, but the valid was empty and the train contained everything).</p> <div class="language-python extra-class"><pre class="language-python"><code>show_at<span class="token punctuation">(</span>tls<span class="token punctuation">.</span>train<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_120_0.png" alt="png"></p> <p>An interesting thing is that unless you pass <code>train_setup=False</code>, your transforms are setup on the training set only (which is best practices): the <code>items</code> received by <code>setups</code> are just the elements of the training set.</p> <h3 id="getting-to-dataloaders"><a href="#getting-to-dataloaders" class="header-anchor">#</a> Getting to <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a></h3> <p>From a <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a>, getting a <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> object is very easy, you just have to call the <code>dataloaders</code> method:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> tls<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>bs<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span>
</code></pre></div><p>And <code>show_batch</code> will just <em>work</em>:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_126_0.png" alt="png"></p> <p>You can even add augmentation transforms, since we have a proper fastai typed image. Just remember to add the <a href="/fastai/data.transforms.html#IntToFloatTensor"><code>IntToFloatTensor</code></a>  transform that deals with the conversion of int to float (augmentation transforms of fastai on the GPU require float tensors). When calling <a href="/fastai/data.core.html#TfmdLists.dataloaders"><code>TfmdLists.dataloaders</code></a>, you pass the <code>batch_tfms</code> to <code>after_batch</code> (and potential new <code>item_tfms</code> to <code>after_item</code>):</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> tls<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>bs<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> after_batch<span class="token operator">=</span><span class="token punctuation">[</span>IntToFloatTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>aug_transforms<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_128_0.png" alt="png"></p> <h3 id="using-datasets"><a href="#using-datasets" class="header-anchor">#</a> Using <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a></h3> <p><a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a> applies a list of list of transforms (or list of <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s) lazily to items of a collection, creating one output per list of transforms/<a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. This makes it easier for us to separate out steps of a process, so that we can re-use them and modify the process more easily. This is what lays the foundation of the data block API: we can easily mix and match types as inputs or outputs as they are associated to certain pipelines of transforms.</p> <p>For instacnce, let's write our own <code>ImageResizer</code> transform with two different implementations for images or masks:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">ImageResizer</span><span class="token punctuation">(</span>Transform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    order<span class="token operator">=</span><span class="token number">1</span>
    <span class="token string">&quot;Resize image to `size` using `resample`&quot;</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> size<span class="token punctuation">,</span> resample<span class="token operator">=</span>Image<span class="token punctuation">.</span>BILINEAR<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> is_listy<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span> size<span class="token operator">=</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>size<span class="token punctuation">,</span>self<span class="token punctuation">.</span>resample <span class="token operator">=</span> <span class="token punctuation">(</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>resample

    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> o<span class="token punctuation">:</span>PILImage<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> o<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>size<span class="token operator">=</span>self<span class="token punctuation">.</span>size<span class="token punctuation">,</span> resample<span class="token operator">=</span>self<span class="token punctuation">.</span>resample<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> o<span class="token punctuation">:</span>PILMask<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword">return</span> o<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>size<span class="token operator">=</span>self<span class="token punctuation">.</span>size<span class="token punctuation">,</span> resample<span class="token operator">=</span>Image<span class="token punctuation">.</span>NEAREST<span class="token punctuation">)</span>
</code></pre></div><p>Specifying the type-annotations makes it so that our transform does nothing to thigns that are neither <a href="/fastai/vision.core.html#PILImage"><code>PILImage</code></a> or <a href="/fastai/vision.core.html#PILMask"><code>PILMask</code></a>, and resize images with <code>self.resample</code>, masks with the nearest neighbor interpolation. To create a <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a>, we then pass two pipelines of transforms, one for the input and one for the target:</p> <div class="language-python extra-class"><pre class="language-python"><code>tfms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">,</span> ImageResizer<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IntToFloatTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>labeller<span class="token punctuation">,</span> Categorize<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
dsets <span class="token operator">=</span> Datasets<span class="token punctuation">(</span>items<span class="token punctuation">,</span> tfms<span class="token punctuation">)</span>
</code></pre></div><p>We can check that inputs and outputs have the right types:</p> <div class="language-python extra-class"><pre class="language-python"><code>t <span class="token operator">=</span> dsets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token builtin">type</span><span class="token punctuation">(</span>t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span>t<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>(fastai.torch_core.TensorImage, fastai.torch_core.TensorCategory)
</code></pre></div><p>We can decode and show using <code>dsets</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>x<span class="token punctuation">,</span>y <span class="token operator">=</span> dsets<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
x<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>y
</code></pre></div><div class="language- extra-class"><pre><code>(torch.Size([3, 128, 128]), 'yorkshire_terrier')
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dsets<span class="token punctuation">.</span>show<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="output_138_0.png" alt="png"></p> <p>And we can pass our train/validation split like in <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>dsets <span class="token operator">=</span> Datasets<span class="token punctuation">(</span>items<span class="token punctuation">,</span> tfms<span class="token punctuation">,</span> splits<span class="token operator">=</span>splits<span class="token punctuation">)</span>
</code></pre></div><p>But we are not using the fact that <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s dispatch over tuples here. <code>ImageResizer</code>, <a href="/fastai/data.transforms.html#ToTensor"><code>ToTensor</code></a> and <a href="/fastai/data.transforms.html#IntToFloatTensor"><code>IntToFloatTensor</code></a> could be passed as transforms over the tuple. This is done in <code>.dataloaders</code> by passing them to <code>after_item</code>. They won't do anything to the category but will only be applied to the inputs.</p> <div class="language-python extra-class"><pre class="language-python"><code>tfms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>labeller<span class="token punctuation">,</span> Categorize<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
dsets <span class="token operator">=</span> Datasets<span class="token punctuation">(</span>items<span class="token punctuation">,</span> tfms<span class="token punctuation">,</span> splits<span class="token operator">=</span>splits<span class="token punctuation">)</span>
dls <span class="token operator">=</span> dsets<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>bs<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> after_item<span class="token operator">=</span><span class="token punctuation">[</span>ImageResizer<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IntToFloatTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>And we can check it works with <code>show_batch</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_144_0.png" alt="png"></p> <p>If we just wanted to build one <a href="/fastai/data.load.html#DataLoader"><code>DataLoader</code></a> from our <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a> (or the previous <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a>), you can pass it directly to <a href="/fastai/data.core.html#TfmdDL"><code>TfmdDL</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>dsets <span class="token operator">=</span> Datasets<span class="token punctuation">(</span>items<span class="token punctuation">,</span> tfms<span class="token punctuation">)</span>
dl <span class="token operator">=</span> TfmdDL<span class="token punctuation">(</span>dsets<span class="token punctuation">,</span> bs<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> after_item<span class="token operator">=</span><span class="token punctuation">[</span>ImageResizer<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IntToFloatTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="segmentation"><a href="#segmentation" class="header-anchor">#</a> Segmentation</h3> <p>By using the same transforms in <code>after_item</code> but a different kind of targets (here segmentation masks), the targets are automatically processed as they should with the type-dispatch system.</p> <div class="language-python extra-class"><pre class="language-python"><code>cv_source <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>CAMVID_TINY<span class="token punctuation">)</span>
cv_items <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>cv_source<span class="token operator">/</span><span class="token string">'images'</span><span class="token punctuation">)</span>
cv_splitter <span class="token operator">=</span> RandomSplitter<span class="token punctuation">(</span>seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
cv_split <span class="token operator">=</span> cv_splitter<span class="token punctuation">(</span>cv_items<span class="token punctuation">)</span>
cv_label <span class="token operator">=</span> <span class="token keyword">lambda</span> o<span class="token punctuation">:</span> cv_source<span class="token operator">/</span><span class="token string">'labels'</span><span class="token operator">/</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>o<span class="token punctuation">.</span>stem<span class="token punctuation">}</span></span><span class="token string">_P</span><span class="token interpolation"><span class="token punctuation">{</span>o<span class="token punctuation">.</span>suffix<span class="token punctuation">}</span></span><span class="token string">'</span></span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>tfms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>cv_label<span class="token punctuation">,</span> PILMask<span class="token punctuation">.</span>create<span class="token punctuation">]</span><span class="token punctuation">]</span>
cv_dsets <span class="token operator">=</span> Datasets<span class="token punctuation">(</span>cv_items<span class="token punctuation">,</span> tfms<span class="token punctuation">,</span> splits<span class="token operator">=</span>cv_split<span class="token punctuation">)</span>
dls <span class="token operator">=</span> cv_dsets<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>bs<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> after_item<span class="token operator">=</span><span class="token punctuation">[</span>ImageResizer<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IntToFloatTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>/opt/conda/conda-bld/pytorch_1585984269458/work/aten/src/ATen/native/BinaryOps.cpp:66: UserWarning: Integer division of tensors using div or / is deprecated, and in a future release div will perform true division as in Python 3. Use true_divide or floor_divide (// in Python) instead.
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span>max_n<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_151_0.png" alt="png"></p> <p>If we want to use the augmentation transform we created before, we just need to add one thing to it: we want it to be applied on the training set only, not the validation set. To do this, we specify it should only be applied on a specific <code>idx</code> of our splits by adding <code>split_idx=0</code> (0 is for the training set, 1 for the validation set):</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SegmentationAlbumentationsTransform</span><span class="token punctuation">(</span>ItemTransform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    split_idx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> aug<span class="token punctuation">)</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>aug <span class="token operator">=</span> aug
    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img<span class="token punctuation">,</span>mask <span class="token operator">=</span> x
        aug <span class="token operator">=</span> self<span class="token punctuation">.</span>aug<span class="token punctuation">(</span>image<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>aug<span class="token punctuation">[</span><span class="token string">&quot;image&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PILMask<span class="token punctuation">.</span>create<span class="token punctuation">(</span>aug<span class="token punctuation">[</span><span class="token string">&quot;mask&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>And we can check how it gets applied on the tuple <code>(img, mask)</code>. This means you can pass it as an <code>item_tfms</code> in any segmentation problem.</p> <div class="language-python extra-class"><pre class="language-python"><code>cv_dsets <span class="token operator">=</span> Datasets<span class="token punctuation">(</span>cv_items<span class="token punctuation">,</span> tfms<span class="token punctuation">,</span> splits<span class="token operator">=</span>cv_split<span class="token punctuation">)</span>
dls <span class="token operator">=</span> cv_dsets<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>bs<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> after_item<span class="token operator">=</span><span class="token punctuation">[</span>ImageResizer<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IntToFloatTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                                              SegmentationAlbumentationsTransform<span class="token punctuation">(</span>ShiftScaleRotate<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span>max_n<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_156_0.png" alt="png"></p> <h2 id="adding-a-test-dataloader-for-inference"><a href="#adding-a-test-dataloader-for-inference" class="header-anchor">#</a> Adding a test dataloader for inference</h2> <p>Let's take back our pets dataset...</p> <div class="language-python extra-class"><pre class="language-python"><code>tfms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>labeller<span class="token punctuation">,</span> Categorize<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
dsets <span class="token operator">=</span> Datasets<span class="token punctuation">(</span>items<span class="token punctuation">,</span> tfms<span class="token punctuation">,</span> splits<span class="token operator">=</span>splits<span class="token punctuation">)</span>
dls <span class="token operator">=</span> dsets<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>bs<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> after_item<span class="token operator">=</span><span class="token punctuation">[</span>ImageResizer<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IntToFloatTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>...and imagine we have some new files to classify.</p> <div class="language-python extra-class"><pre class="language-python"><code>path <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>PETS<span class="token punctuation">)</span>
tst_files <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">&quot;images&quot;</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token builtin">len</span><span class="token punctuation">(</span>tst_files<span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>7390
</code></pre></div><p>We can create a dataloader that takes those files and applies the same transforms as the validation set with <a href="/fastai/data.core.html#DataLoaders.test_dl"><code>DataLoaders.test_dl</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>tst_dl <span class="token operator">=</span> dls<span class="token punctuation">.</span>test_dl<span class="token punctuation">(</span>tst_files<span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>tst_dl<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span>max_n<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_165_0.png" alt="png"></p> <p><strong>Extra:</strong><br>
You can call <code>learn.get_preds</code> passing this newly created dataloaders to make predictions on our new images!<br>
What is really cool is that after you finished training your model, you can save it with <code>learn.export</code>, this is also going to save all the transforms that need to be applied to your data. In inference time you just need to load your learner with <a href="/fastai/learner.html#load_learner"><code>load_learner</code></a> and you can immediately create a dataloader with <code>test_dl</code> to use it to generate new predictions!</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/fastai/assets/js/app.f17b0f11.js" defer></script><script src="/fastai/assets/js/3.7e8af7b4.js" defer></script><script src="/fastai/assets/js/60.c377d394.js" defer></script>
  </body>
</html>
