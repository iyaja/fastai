<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tutorial - Using fastai on a custom new task</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="Welcome to fastai">
    <link rel="preload" href="/fastai/assets/css/0.styles.d03aadf4.css" as="style"><link rel="preload" href="/fastai/assets/js/app.f17b0f11.js" as="script"><link rel="preload" href="/fastai/assets/js/3.7e8af7b4.js" as="script"><link rel="preload" href="/fastai/assets/js/61.d6a10937.js" as="script"><link rel="prefetch" href="/fastai/assets/js/10.8521128e.js"><link rel="prefetch" href="/fastai/assets/js/11.287f40d6.js"><link rel="prefetch" href="/fastai/assets/js/12.12842fbd.js"><link rel="prefetch" href="/fastai/assets/js/13.b531fd0e.js"><link rel="prefetch" href="/fastai/assets/js/14.3b85f440.js"><link rel="prefetch" href="/fastai/assets/js/15.015d175e.js"><link rel="prefetch" href="/fastai/assets/js/16.744581ff.js"><link rel="prefetch" href="/fastai/assets/js/17.5ea8f7a5.js"><link rel="prefetch" href="/fastai/assets/js/18.6325a7a3.js"><link rel="prefetch" href="/fastai/assets/js/19.12895d2e.js"><link rel="prefetch" href="/fastai/assets/js/20.421dab5c.js"><link rel="prefetch" href="/fastai/assets/js/21.d0965317.js"><link rel="prefetch" href="/fastai/assets/js/22.d4da69f5.js"><link rel="prefetch" href="/fastai/assets/js/23.eb6f27d0.js"><link rel="prefetch" href="/fastai/assets/js/24.7b39000f.js"><link rel="prefetch" href="/fastai/assets/js/25.4b2ae256.js"><link rel="prefetch" href="/fastai/assets/js/26.ed68ed51.js"><link rel="prefetch" href="/fastai/assets/js/27.fbc2137b.js"><link rel="prefetch" href="/fastai/assets/js/28.6c32e1f5.js"><link rel="prefetch" href="/fastai/assets/js/29.e8f4d3b8.js"><link rel="prefetch" href="/fastai/assets/js/30.f9987fa2.js"><link rel="prefetch" href="/fastai/assets/js/31.10dfab48.js"><link rel="prefetch" href="/fastai/assets/js/32.51ffa228.js"><link rel="prefetch" href="/fastai/assets/js/33.58064d56.js"><link rel="prefetch" href="/fastai/assets/js/34.ee932158.js"><link rel="prefetch" href="/fastai/assets/js/35.13e4d738.js"><link rel="prefetch" href="/fastai/assets/js/36.04e592b7.js"><link rel="prefetch" href="/fastai/assets/js/37.7cafae24.js"><link rel="prefetch" href="/fastai/assets/js/38.29b7b3ca.js"><link rel="prefetch" href="/fastai/assets/js/39.60cf076c.js"><link rel="prefetch" href="/fastai/assets/js/4.6279c390.js"><link rel="prefetch" href="/fastai/assets/js/40.ae925aa6.js"><link rel="prefetch" href="/fastai/assets/js/41.6f007865.js"><link rel="prefetch" href="/fastai/assets/js/42.ccc13ed7.js"><link rel="prefetch" href="/fastai/assets/js/43.2429f884.js"><link rel="prefetch" href="/fastai/assets/js/44.2d4ccb85.js"><link rel="prefetch" href="/fastai/assets/js/45.3c017ace.js"><link rel="prefetch" href="/fastai/assets/js/46.3caf88b0.js"><link rel="prefetch" href="/fastai/assets/js/47.a13286d5.js"><link rel="prefetch" href="/fastai/assets/js/48.551a5021.js"><link rel="prefetch" href="/fastai/assets/js/49.61f2131a.js"><link rel="prefetch" href="/fastai/assets/js/5.93fc1ade.js"><link rel="prefetch" href="/fastai/assets/js/50.372d1f7d.js"><link rel="prefetch" href="/fastai/assets/js/51.ed721b06.js"><link rel="prefetch" href="/fastai/assets/js/52.60718eb7.js"><link rel="prefetch" href="/fastai/assets/js/53.f65e2a2a.js"><link rel="prefetch" href="/fastai/assets/js/54.f9f76813.js"><link rel="prefetch" href="/fastai/assets/js/55.020bc688.js"><link rel="prefetch" href="/fastai/assets/js/56.c4856fc6.js"><link rel="prefetch" href="/fastai/assets/js/57.e115d83b.js"><link rel="prefetch" href="/fastai/assets/js/58.e58e0027.js"><link rel="prefetch" href="/fastai/assets/js/59.886eb077.js"><link rel="prefetch" href="/fastai/assets/js/6.5fa76b7a.js"><link rel="prefetch" href="/fastai/assets/js/60.c377d394.js"><link rel="prefetch" href="/fastai/assets/js/62.3f1bbe72.js"><link rel="prefetch" href="/fastai/assets/js/63.ea143add.js"><link rel="prefetch" href="/fastai/assets/js/64.4abe956e.js"><link rel="prefetch" href="/fastai/assets/js/65.f1204af6.js"><link rel="prefetch" href="/fastai/assets/js/66.e5904312.js"><link rel="prefetch" href="/fastai/assets/js/67.72451568.js"><link rel="prefetch" href="/fastai/assets/js/68.f4b4d8e2.js"><link rel="prefetch" href="/fastai/assets/js/69.2ef62d06.js"><link rel="prefetch" href="/fastai/assets/js/7.3e251b44.js"><link rel="prefetch" href="/fastai/assets/js/70.892242aa.js"><link rel="prefetch" href="/fastai/assets/js/71.348a11dd.js"><link rel="prefetch" href="/fastai/assets/js/72.735683a9.js"><link rel="prefetch" href="/fastai/assets/js/73.61a8ce4c.js"><link rel="prefetch" href="/fastai/assets/js/74.cec16c32.js"><link rel="prefetch" href="/fastai/assets/js/75.c261240c.js"><link rel="prefetch" href="/fastai/assets/js/76.d69068d6.js"><link rel="prefetch" href="/fastai/assets/js/8.c3d5d69d.js"><link rel="prefetch" href="/fastai/assets/js/9.ffbd18f1.js"><link rel="prefetch" href="/fastai/assets/js/vendors~docsearch.f5584d80.js">
    <link rel="stylesheet" href="/fastai/assets/css/0.styles.d03aadf4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fastai/" class="home-link router-link-active"><img src="https://images.exxactcorp.com/CMS/landing-page/resource-center/supported-software/logo/Deep-Learning/fastai-logo.png" alt="" class="logo"> <!----></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow down"></span></button> <button type="button" aria-label="Getting Started" class="mobile-dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><!----> <a href="/fastai/quick_start.html" class="nav-link">
  Quick Start
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tutorials" class="dropdown-title"><span class="title">Tutorials</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tutorials" class="mobile-dropdown-title"><span class="title">Tutorials</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tutorial/overview.html" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><h4>
          Beginners
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/vision.html" class="nav-link">
  Vision Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/text.html" class="nav-link">
  Text Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/tabular.html" class="nav-link">
  Tabular Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/colab.html" class="nav-link">
  Colab Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Intermediate
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/datablock.html" class="nav-link">
  Data Block Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/imagenette.html" class="nav-link">
  Imagenette Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/pets.html" class="nav-link">
  Pets Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/transformers.html" class="nav-link">
  Transformers Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/wikitext.html" class="nav-link">
  Wikitext Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Advanced
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/siamese.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Siamese Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/dev-setup.html" class="nav-link">
  Developer Guide
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Training" class="dropdown-title"><span class="title">Training</span> <span class="arrow down"></span></button> <button type="button" aria-label="Training" class="mobile-dropdown-title"><span class="title">Training</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/training/learner.html" class="nav-link">
  Training Loop
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/optimizer.html" class="nav-link">
  Optimizer
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/metrics.html" class="nav-link">
  Metrics
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/interpret.html" class="nav-link">
  Interpretation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/distributed.html" class="nav-link">
  Distributed
</a></li><li class="dropdown-item"><h4>
          Callbacks
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/callback/core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/schedule.html" class="nav-link">
  Schedulers
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/hook.html" class="nav-link">
  Hooks and callbacks
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/fp16.html" class="nav-link">
  Mixed precision
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/mixup.html" class="nav-link">
  Mixup
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/cutmix.html" class="nav-link">
  Cutmix
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/tracker.html" class="nav-link">
  Tracker
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/training.html" class="nav-link">
  Training
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/rnn.html" class="nav-link">
  RNN
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/data.html" class="nav-link">
  Data
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/progress.html" class="nav-link">
  Progress
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Data" class="dropdown-title"><span class="title">Data</span> <span class="arrow down"></span></button> <button type="button" aria-label="Data" class="mobile-dropdown-title"><span class="title">Data</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/data/block.html" class="nav-link">
  Data Blocks
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/transforms.html" class="nav-link">
  Data Transforms
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/external.html" class="nav-link">
  Data External
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/core.html" class="nav-link">
  Data Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/load.html" class="nav-link">
  DataLoaders
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Core" class="dropdown-title"><span class="title">Core</span> <span class="arrow down"></span></button> <button type="button" aria-label="Core" class="mobile-dropdown-title"><span class="title">Core</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/torch_core.html" class="nav-link">
  PyTorch Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/layers.html" class="nav-link">
  Layers
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/vision/learner.html" class="nav-link">
  Vision Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/augment.html" class="nav-link">
  Vision Data Augmentation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/data.html" class="nav-link">
  Vision Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/core.html" class="nav-link">
  Vision Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/utils.html" class="nav-link">
  Vision Utils
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/widgets.html" class="nav-link">
  Vision Widgets
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/vision/models.xresnet.html" class="nav-link">
  XResNet
</a></li><li class="dropdown-subitem"><a href="/fastai/vision/models.unet.html" class="nav-link">
  UNet
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Text" class="dropdown-title"><span class="title">Text</span> <span class="arrow down"></span></button> <button type="button" aria-label="Text" class="mobile-dropdown-title"><span class="title">Text</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/text/core.html" class="nav-link">
  Text Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/data.html" class="nav-link">
  Text Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/learner.html" class="nav-link">
  Text Learner
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/text/models.core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.awdlstm.html" class="nav-link">
  AWD LSTM
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.qrnn.html" class="nav-link">
  QRNN
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tabular/core.html" class="nav-link">
  Tabular Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/data.html" class="nav-link">
  Tabular Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/learner.html" class="nav-link">
  Tabular Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/model.html" class="nav-link">
  Tabular Model
</a></li><li class="dropdown-item"><!----> <a href="/fastai/collab.html" class="nav-link">
  Collab
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Medical" class="dropdown-title"><span class="title">Medical</span> <span class="arrow down"></span></button> <button type="button" aria-label="Medical" class="mobile-dropdown-title"><span class="title">Medical</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/medical/imaging.html" class="nav-link">
  Medical imagery
</a></li><li class="dropdown-item"><!----> <a href="/fastai/medical/text.html" class="nav-link">
  Medical text
</a></li></ul></div></div> <a href="https://github.com/fastai/fastai" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow down"></span></button> <button type="button" aria-label="Getting Started" class="mobile-dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><!----> <a href="/fastai/quick_start.html" class="nav-link">
  Quick Start
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tutorials" class="dropdown-title"><span class="title">Tutorials</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tutorials" class="mobile-dropdown-title"><span class="title">Tutorials</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tutorial/overview.html" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><h4>
          Beginners
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/vision.html" class="nav-link">
  Vision Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/text.html" class="nav-link">
  Text Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/tabular.html" class="nav-link">
  Tabular Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/colab.html" class="nav-link">
  Colab Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Intermediate
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/datablock.html" class="nav-link">
  Data Block Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/imagenette.html" class="nav-link">
  Imagenette Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/pets.html" class="nav-link">
  Pets Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/transformers.html" class="nav-link">
  Transformers Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/wikitext.html" class="nav-link">
  Wikitext Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Advanced
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/siamese.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Siamese Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/dev-setup.html" class="nav-link">
  Developer Guide
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Training" class="dropdown-title"><span class="title">Training</span> <span class="arrow down"></span></button> <button type="button" aria-label="Training" class="mobile-dropdown-title"><span class="title">Training</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/training/learner.html" class="nav-link">
  Training Loop
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/optimizer.html" class="nav-link">
  Optimizer
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/metrics.html" class="nav-link">
  Metrics
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/interpret.html" class="nav-link">
  Interpretation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/distributed.html" class="nav-link">
  Distributed
</a></li><li class="dropdown-item"><h4>
          Callbacks
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/callback/core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/schedule.html" class="nav-link">
  Schedulers
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/hook.html" class="nav-link">
  Hooks and callbacks
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/fp16.html" class="nav-link">
  Mixed precision
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/mixup.html" class="nav-link">
  Mixup
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/cutmix.html" class="nav-link">
  Cutmix
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/tracker.html" class="nav-link">
  Tracker
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/training.html" class="nav-link">
  Training
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/rnn.html" class="nav-link">
  RNN
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/data.html" class="nav-link">
  Data
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/progress.html" class="nav-link">
  Progress
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Data" class="dropdown-title"><span class="title">Data</span> <span class="arrow down"></span></button> <button type="button" aria-label="Data" class="mobile-dropdown-title"><span class="title">Data</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/data/block.html" class="nav-link">
  Data Blocks
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/transforms.html" class="nav-link">
  Data Transforms
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/external.html" class="nav-link">
  Data External
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/core.html" class="nav-link">
  Data Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/load.html" class="nav-link">
  DataLoaders
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Core" class="dropdown-title"><span class="title">Core</span> <span class="arrow down"></span></button> <button type="button" aria-label="Core" class="mobile-dropdown-title"><span class="title">Core</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/torch_core.html" class="nav-link">
  PyTorch Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/layers.html" class="nav-link">
  Layers
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/vision/learner.html" class="nav-link">
  Vision Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/augment.html" class="nav-link">
  Vision Data Augmentation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/data.html" class="nav-link">
  Vision Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/core.html" class="nav-link">
  Vision Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/utils.html" class="nav-link">
  Vision Utils
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/widgets.html" class="nav-link">
  Vision Widgets
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/vision/models.xresnet.html" class="nav-link">
  XResNet
</a></li><li class="dropdown-subitem"><a href="/fastai/vision/models.unet.html" class="nav-link">
  UNet
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Text" class="dropdown-title"><span class="title">Text</span> <span class="arrow down"></span></button> <button type="button" aria-label="Text" class="mobile-dropdown-title"><span class="title">Text</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/text/core.html" class="nav-link">
  Text Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/data.html" class="nav-link">
  Text Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/learner.html" class="nav-link">
  Text Learner
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/text/models.core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.awdlstm.html" class="nav-link">
  AWD LSTM
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.qrnn.html" class="nav-link">
  QRNN
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tabular/core.html" class="nav-link">
  Tabular Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/data.html" class="nav-link">
  Tabular Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/learner.html" class="nav-link">
  Tabular Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/model.html" class="nav-link">
  Tabular Model
</a></li><li class="dropdown-item"><!----> <a href="/fastai/collab.html" class="nav-link">
  Collab
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Medical" class="dropdown-title"><span class="title">Medical</span> <span class="arrow down"></span></button> <button type="button" aria-label="Medical" class="mobile-dropdown-title"><span class="title">Medical</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/medical/imaging.html" class="nav-link">
  Medical imagery
</a></li><li class="dropdown-item"><!----> <a href="/fastai/medical/text.html" class="nav-link">
  Medical text
</a></li></ul></div></div> <a href="https://github.com/fastai/fastai" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Tutorial - Using fastai on a custom new task</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fastai/tutorial/siamese.html#preparing-the-data" class="sidebar-link">Preparing the data</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fastai/tutorial/siamese.html#purely-in-pytorch" class="sidebar-link">Purely in PyTorch</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/siamese.html#using-the-mid-level-api" class="sidebar-link">Using the mid-level API</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/siamese.html#making-show-work" class="sidebar-link">Making show work</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/siamese.html#writing-your-custom-data-block" class="sidebar-link">Writing your custom data block</a></li></ul></li><li><a href="/fastai/tutorial/siamese.html#training-a-model" class="sidebar-link">Training a model</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fastai/tutorial/siamese.html#the-model" class="sidebar-link">The model</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/siamese.html#train-the-model" class="sidebar-link">Train the model</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/siamese.html#making-show-results-work" class="sidebar-link">Making show_results work</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/siamese.html#patch-in-a-siampredict-method-to-learner-to-automatically-show-images-and-prediction" class="sidebar-link">Patch in a siampredict method to Learner, to automatically show images and prediction</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tutorial-using-fastai-on-a-custom-new-task"><a href="#tutorial-using-fastai-on-a-custom-new-task" class="header-anchor">#</a> Tutorial - Using fastai on a custom new task</h1> <blockquote><p>How to use the mid-level API for data collection, model creation and training</p></blockquote> <p>In this tutorial, we will see how to deal with a new type of task using the middle layer of the fastai library. The example we will use is a Siamese network, that takes two images and determine if they are of the same class or not. In particular we will see:</p> <ul><li>how to quickly get <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> from a standard PyTorch <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a></li> <li>how to adapt this in a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to get some of the show features of fastai</li> <li>how to add some new behavior to <code>show_batch</code>/<code>show_results</code> for a custom task</li> <li>how to write a custom <a href="/fastai/data.block.html#DataBlock"><code>DataBlock</code></a></li> <li>how to create your own model from a pretrained model</li> <li>how to pass along a custom <code>splitter</code> to <a href="/fastai/learner.html#Learner"><code>Learner</code></a> to take advantage of transfer learning</li></ul> <h2 id="preparing-the-data"><a href="#preparing-the-data" class="header-anchor">#</a> Preparing the data</h2> <p>To make our data ready for training a model, we need to create a <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> object in fastai. It is just a wrapper around a training <a href="/fastai/data.load.html#DataLoader"><code>DataLoader</code></a> and a validation <a href="/fastai/data.load.html#DataLoader"><code>DataLoader</code></a>, so if you already have your own PyTorch dataloaders, you can create such an object directly.</p> <p>Here we don't have anything ready yet. Usually, when using PyTorch, the first step is to create a <code>Dataset</code> that is then wrapped inside a <a href="/fastai/data.load.html#DataLoader"><code>DataLoader</code></a>. We will do this first, then see how to change this <code>Dataset</code> into a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that will let us take advantage of fastai's functionality for showing a batch or using data augmentation on the GPU. Lastly we will see how we can customize the data block API and create our own new <a href="/fastai/data.block.html#TransformBlock"><code>TransformBlock</code></a>.</p> <h3 id="purely-in-pytorch"><a href="#purely-in-pytorch" class="header-anchor">#</a> Purely in PyTorch</h3> <p>To begin with, we will only use PyTorch and PIL to create a <code>Dataset</code> and see how to get this inside fastai. The only helper functions from fastai we will use are <a href="/fastai/data.external.html#untar_data"><code>untar_data</code></a> (to download and untar the dataset) and <a href="/fastai/data.transforms.html#get_image_files"><code>get_image_files</code></a> (that looks for all images in a folder recursively). Here, we will use the <a href="https://www.robots.ox.ac.uk/~vgg/data/pets/" target="_blank" rel="noopener noreferrer">Oxford-IIIT Pet Dataset<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastai<span class="token punctuation">.</span>data<span class="token punctuation">.</span>external <span class="token keyword">import</span> untar_data<span class="token punctuation">,</span>URLs
<span class="token keyword">from</span> fastai<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> get_image_files
</code></pre></div><p><a href="/fastai/data.external.html#untar_data"><code>untar_data</code></a> returns a <code>pathlib.Path</code> object with the location of the decompressed dataset, and in this case, all the images are in an images subfolder:</p> <div class="language-python extra-class"><pre class="language-python"><code>path <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>PETS<span class="token punctuation">)</span>
files <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">&quot;images&quot;</span><span class="token punctuation">)</span>
files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>Path('/home/yijin/data/oxford-iiit-pet/images/Abyssinian_140.jpg')
</code></pre></div><p>We can open the first image with PIL and have a look at it:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> PIL
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>img <span class="token operator">=</span> PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
img
</code></pre></div><p><img src="output_11_0.png" alt="png"></p> <p>Let's wrap all the standard preprocessing (resize, conversion to tensor, dividing by 255 and reordering of the channels) in one helper function:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> torch
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">open_image</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    img <span class="token operator">=</span> PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    t <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255.0</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>open_image<span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shape
</code></pre></div><div class="language- extra-class"><pre><code>torch.Size([3, 224, 224])
</code></pre></div><p>We can see the label of our image is in the filename, before the last <code>_</code> and some number. We can then use a regex expression to create a label function:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> re
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">label_func</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r'^(.*)_\d+.jpg$'</span><span class="token punctuation">,</span> fname<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

label_func<span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>'Abyssinian'
</code></pre></div><p>Now lets gather all unique labels:</p> <div class="language-python extra-class"><pre class="language-python"><code>labels <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>label_func<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token builtin">len</span><span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>37
</code></pre></div><p>So we have 37 different breeds of pets. To create our Siamese datasets, we will need to create tuple of images for inputs and the target will be <code>True</code> if the images are of the same class, <code>False</code> otherwise. It will be useful to have a mapping from class to list of filenames of that class, to quickly pick a random image for any class.</p> <div class="language-python extra-class"><pre class="language-python"><code>lbl2files <span class="token operator">=</span> <span class="token punctuation">{</span>l<span class="token punctuation">:</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> files <span class="token keyword">if</span> label_func<span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">==</span> l<span class="token punctuation">]</span> <span class="token keyword">for</span> l <span class="token keyword">in</span> labels<span class="token punctuation">}</span>
</code></pre></div><p>Now we are ready to create our datasets. For the training set, we will go through all our training filenames for the first image, then pick randomly:</p> <ul><li>a filename of the same class for the second image (with probability 0.5)</li> <li>a filename of a different class for the second image (with probability 0.5)</li></ul> <p>We will go through that random draw each time we access an item, to have as many samples as possible. For the validation set however, we will fix that random draw once and for all (otherwise we will validate on a different dataset at each epoch).</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> random
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SiameseDataset</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> files<span class="token punctuation">,</span> is_valid<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>files<span class="token punctuation">,</span>self<span class="token punctuation">.</span>is_valid <span class="token operator">=</span> files<span class="token punctuation">,</span>is_valid
        <span class="token keyword">if</span> is_valid<span class="token punctuation">:</span> self<span class="token punctuation">.</span>files2 <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_draw<span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> files<span class="token punctuation">]</span>
        
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>
        file1 <span class="token operator">=</span> self<span class="token punctuation">.</span>files<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token punctuation">(</span>file2<span class="token punctuation">,</span>same<span class="token punctuation">)</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>files2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_valid <span class="token keyword">else</span> self<span class="token punctuation">.</span>_draw<span class="token punctuation">(</span>file1<span class="token punctuation">)</span>
        img1<span class="token punctuation">,</span>img2 <span class="token operator">=</span> open_image<span class="token punctuation">(</span>file1<span class="token punctuation">)</span><span class="token punctuation">,</span>open_image<span class="token punctuation">(</span>file2<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>img1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>same<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>files<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">_draw</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        same <span class="token operator">=</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span>
        cls <span class="token operator">=</span> label_func<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> same<span class="token punctuation">:</span> cls <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span>l <span class="token keyword">for</span> l <span class="token keyword">in</span> labels <span class="token keyword">if</span> l <span class="token operator">!=</span> cls<span class="token punctuation">]</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>lbl2files<span class="token punctuation">[</span>cls<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>same
</code></pre></div><p>We just need to split our filenames between a training and validation set to use it.</p> <div class="language-python extra-class"><pre class="language-python"><code>idxs <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>permutation<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
cut <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.8</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span>
train_files <span class="token operator">=</span> files<span class="token punctuation">[</span>idxs<span class="token punctuation">[</span><span class="token punctuation">:</span>cut<span class="token punctuation">]</span><span class="token punctuation">]</span>
valid_files <span class="token operator">=</span> files<span class="token punctuation">[</span>idxs<span class="token punctuation">[</span>cut<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre></div><p>We can then use it to create datasets.</p> <div class="language-python extra-class"><pre class="language-python"><code>train_ds <span class="token operator">=</span> SiameseDataset<span class="token punctuation">(</span>train_files<span class="token punctuation">)</span>
valid_ds <span class="token operator">=</span> SiameseDataset<span class="token punctuation">(</span>valid_files<span class="token punctuation">,</span> is_valid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre></div><p>All of the above would be different for your custom problem, the main point is that as soon as you have some <code>Dataset</code>s, you can create a fastai's <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> with the following factory method:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastai<span class="token punctuation">.</span>data<span class="token punctuation">.</span>core <span class="token keyword">import</span> DataLoaders
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> DataLoaders<span class="token punctuation">.</span>from_dsets<span class="token punctuation">(</span>train_ds<span class="token punctuation">,</span> valid_ds<span class="token punctuation">)</span>
</code></pre></div><p>You can then use this <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> object in a <a href="/fastai/learner.html#Learner"><code>Learner</code></a> and start training. Most methods that don't rely on showing something (e.g. <a href="/fastai/data.core.html#DataLoaders.show_batch"><code>DataLoaders.show_batch</code></a> and <a href="/fastai/learner.html#Learner.show_results"><code>Learner.show_results</code></a> for instance) should work. For instance, you can get and inspect a batch with:</p> <div class="language-python extra-class"><pre class="language-python"><code>b <span class="token operator">=</span> dls<span class="token punctuation">.</span>one_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>If you want to use the GPU, you can just write:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> dls<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Now, what is a bit annoying is that we have to rewrite everything that is already in fastai if we want to normalize our images, or apply data augmentation. With minimal changes to the code we wrote, we can still access all of that and get all the show method to work as a cherry on the top. Let's see how.</p> <h3 id="using-the-mid-level-api"><a href="#using-the-mid-level-api" class="header-anchor">#</a> Using the mid-level API</h3> <p>When you have a custom dataset like before, you can easily convert it into a fastai <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> by just changing the <code>__getitem__</code> function to <code>encodes</code>. In general, a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> in fastai calls the <code>encodes</code> method when you apply it on an item (a bit like PyTorch modules call <code>forward</code> when applied on something) so this will transform your python dataset in a function that transforms integer to your data.</p> <p>If you then return a tuple (or a subclass of a tuple), and use fastai's semantic type, you can then apply any other fastai's transform on your data and it will be dispatched properly. Let's see how that works:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastai<span class="token punctuation">.</span>vision<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SiameseTransform</span><span class="token punctuation">(</span>Transform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> files<span class="token punctuation">,</span> is_valid<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>files<span class="token punctuation">,</span>self<span class="token punctuation">.</span>is_valid <span class="token operator">=</span> files<span class="token punctuation">,</span>is_valid
        <span class="token keyword">if</span> is_valid<span class="token punctuation">:</span> self<span class="token punctuation">.</span>files2 <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_draw<span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> files<span class="token punctuation">]</span>
        
    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>
        file1 <span class="token operator">=</span> self<span class="token punctuation">.</span>files<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token punctuation">(</span>file2<span class="token punctuation">,</span>same<span class="token punctuation">)</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>files2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_valid <span class="token keyword">else</span> self<span class="token punctuation">.</span>_draw<span class="token punctuation">(</span>file1<span class="token punctuation">)</span>
        img1<span class="token punctuation">,</span>img2 <span class="token operator">=</span> open_image<span class="token punctuation">(</span>file1<span class="token punctuation">)</span><span class="token punctuation">,</span>open_image<span class="token punctuation">(</span>file2<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>TensorImage<span class="token punctuation">(</span>img1<span class="token punctuation">)</span><span class="token punctuation">,</span> TensorImage<span class="token punctuation">(</span>img2<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>same<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">_draw</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        same <span class="token operator">=</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span>
        cls <span class="token operator">=</span> label_func<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> same<span class="token punctuation">:</span> cls <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span>l <span class="token keyword">for</span> l <span class="token keyword">in</span> labels <span class="token keyword">if</span> l <span class="token operator">!=</span> cls<span class="token punctuation">]</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>lbl2files<span class="token punctuation">[</span>cls<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>same
</code></pre></div><p>So three things changed:</p> <ul><li>the <code>__len__</code> disappeared, we won't need it</li> <li><code>__getitem___</code> became <code>encodes</code></li> <li>we return <a href="/fastai/torch_core.html#TensorImage"><code>TensorImage</code></a> for our images</li></ul> <p>How do we build a dataset with this? We will use <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a>. It's just an object that lazily applies a collection of <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s on a list. Here since our transform takes integers, we will pass simple ranges for this list.</p> <div class="language-python extra-class"><pre class="language-python"><code>train_tl<span class="token operator">=</span> TfmdLists<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train_files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SiameseTransform<span class="token punctuation">(</span>train_files<span class="token punctuation">)</span><span class="token punctuation">)</span>
valid_tl<span class="token operator">=</span> TfmdLists<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>valid_files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SiameseTransform<span class="token punctuation">(</span>valid_files<span class="token punctuation">,</span> is_valid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Then, when we create a <a href="/fastai/data.load.html#DataLoader"><code>DataLoader</code></a>, we can add any transform we like. fastai replaces the PyTorch <a href="/fastai/data.load.html#DataLoader"><code>DataLoader</code></a> with its own version that has more hooks (but is fully compatible with PyTorch). The transforms we would like to be applied to items should be passed to <code>after_item</code>, the one we would like to be applied on a batch of data should be passed to <code>after_batch</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> DataLoaders<span class="token punctuation">.</span>from_dsets<span class="token punctuation">(</span>train_tl<span class="token punctuation">,</span> valid_tl<span class="token punctuation">,</span> 
                             after_batch<span class="token operator">=</span><span class="token punctuation">[</span>Normalize<span class="token punctuation">.</span>from_stats<span class="token punctuation">(</span><span class="token operator">*</span>imagenet_stats<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>aug_transforms<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
dls <span class="token operator">=</span> dls<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>So with little change, we can use fastai normalization and data augmentation. If we are ready to do a bit more additional coding, we can even get the show behavior to work properly.</p> <h3 id="making-show-work"><a href="#making-show-work" class="header-anchor">#</a> Making show work</h3> <p>The show methods in fastai all rely on some types being able to show themselves. Additionally, some transforms that need to be reversed for showing purposes (like changing a category to an index, or normalizing) have a <code>decodes</code> method to undo what their encodes did. In general, fastai will call those decodes method until it arrives at a type that knows how to show itself, then call the show method on this type.</p> <p>So to make this work, let's first create a new type with a show method!</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SiameseImage</span><span class="token punctuation">(</span>fastuple<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ctx<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span> 
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
            img1<span class="token punctuation">,</span>img2<span class="token punctuation">,</span>similarity <span class="token operator">=</span> self
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            img1<span class="token punctuation">,</span>img2 <span class="token operator">=</span> self
            similarity <span class="token operator">=</span> <span class="token string">'Undetermined'</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> img2<span class="token punctuation">.</span>size <span class="token operator">!=</span> img1<span class="token punctuation">.</span>size<span class="token punctuation">:</span> img2 <span class="token operator">=</span> img2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img1<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
            t1<span class="token punctuation">,</span>t2 <span class="token operator">=</span> tensor<span class="token punctuation">(</span>img1<span class="token punctuation">)</span><span class="token punctuation">,</span>tensor<span class="token punctuation">(</span>img2<span class="token punctuation">)</span>
            t1<span class="token punctuation">,</span>t2 <span class="token operator">=</span> t1<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>t2<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span> t1<span class="token punctuation">,</span>t2 <span class="token operator">=</span> img1<span class="token punctuation">,</span>img2
        line <span class="token operator">=</span> t1<span class="token punctuation">.</span>new_zeros<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> show_image<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>t1<span class="token punctuation">,</span>line<span class="token punctuation">,</span>t2<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> title<span class="token operator">=</span>similarity<span class="token punctuation">,</span> ctx<span class="token operator">=</span>ctx<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
</code></pre></div><p>There is bit of code in the first part of the test that you can ignore, it's mostly to make the show method work on PIL Image as well as tensors. The main stuff happens in the last two lines: we create a black line of 10 pixels and show the tensor with our two images concatenated, with the black line in the middle. In general, <code>ctx</code> represents the object where we will show our thing. In this case, it could be a given matplotlib axis.</p> <p>Let's see an example:</p> <div class="language-python extra-class"><pre class="language-python"><code>img <span class="token operator">=</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
img1 <span class="token operator">=</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> SiameseImage<span class="token punctuation">(</span>img<span class="token punctuation">,</span> img1<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="output_51_0.png" alt="png"></p> <p>Note that we used the fastai type <a href="/fastai/vision.core.html#PILImage"><code>PILImage</code></a> instead of a PIL.Image. That is to get access to fastai's transforms. For instance, we can use <a href="/fastai/vision.augment.html#Resize"><code>Resize</code></a> and <a href="/fastai/data.transforms.html#ToTensor"><code>ToTensor</code></a> directly on our <code>SiamesImage</code>. Since it subclasses tuple, those transforms are dispatched and applied to the part that make sense (the <a href="/fastai/vision.core.html#PILImage"><code>PILImage</code></a>s, not the bool).</p> <div class="language-python extra-class"><pre class="language-python"><code>tst <span class="token operator">=</span> Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
tst <span class="token operator">=</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tst<span class="token punctuation">)</span>
tst<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="output_53_0.png" alt="png"></p> <p>Now let's rewrite a bit our previous transform. Instead of taking integers, we can take files directly for instance. Also, in fastai, splits are usually handled by helper functions that return two lists of integers (the ones in the training set and the ones in the validation set), so let's adapt a bit the code from before to have the validation images drawn once and for all:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SiameseTransform</span><span class="token punctuation">(</span>Transform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> files<span class="token punctuation">,</span> splits<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token punctuation">{</span>f<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_draw<span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> files<span class="token punctuation">[</span>splits<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        
    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        f2<span class="token punctuation">,</span>same <span class="token operator">=</span> self<span class="token punctuation">.</span>valid<span class="token punctuation">.</span>get<span class="token punctuation">(</span>f<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_draw<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span>
        img1<span class="token punctuation">,</span>img2 <span class="token operator">=</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>f2<span class="token punctuation">)</span>
        <span class="token keyword">return</span> SiameseImage<span class="token punctuation">(</span>img1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> same<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">_draw</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        same <span class="token operator">=</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span>
        cls <span class="token operator">=</span> label_func<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> same<span class="token punctuation">:</span> cls <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>L<span class="token punctuation">(</span>l <span class="token keyword">for</span> l <span class="token keyword">in</span> labels <span class="token keyword">if</span> l <span class="token operator">!=</span> cls<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>lbl2files<span class="token punctuation">[</span>cls<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>same
</code></pre></div><p>Then we create our splits using a <a href="/fastai/data.transforms.html#RandomSplitter"><code>RandomSplitter</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>splits <span class="token operator">=</span> RandomSplitter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>
tfm <span class="token operator">=</span> SiameseTransform<span class="token punctuation">(</span>files<span class="token punctuation">,</span> splits<span class="token punctuation">)</span>
</code></pre></div><p>And we can pass those splits to <a href="/fastai/data.core.html#TfmdLists"><code>TfmdLists</code></a>, which will then create the validation and the training set for us.</p> <div class="language-python extra-class"><pre class="language-python"><code>tls <span class="token operator">=</span> TfmdLists<span class="token punctuation">(</span>files<span class="token punctuation">,</span> tfm<span class="token punctuation">,</span> splits<span class="token operator">=</span>splits<span class="token punctuation">)</span>
</code></pre></div><p>We can now use methods like <a href="/fastai/data.core.html#show_at"><code>show_at</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>show_at<span class="token punctuation">(</span>tls<span class="token punctuation">.</span>valid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fbe84434950&gt;
</code></pre></div><p><img src="output_61_1.png" alt="png"></p> <p>And we can create a <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> like before, by adding our custom transforms for <code>after_item</code> and <code>after_batch</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> tls<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>after_item<span class="token operator">=</span><span class="token punctuation">[</span>Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      after_batch<span class="token operator">=</span><span class="token punctuation">[</span>IntToFloatTensor<span class="token punctuation">,</span> Normalize<span class="token punctuation">.</span>from_stats<span class="token punctuation">(</span><span class="token operator">*</span>imagenet_stats<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>If we try just now, <code>show_batch</code> will not quite work: the default behavior relies on some data build using data blocks, and we used one big transform for everything. In consequence, instead of having an input with a certain type and an output of a certain type, we have one big type for the whole data. If we look at a batch, we can see that the fastai library has propagated that type for us through every transform and batching operation:</p> <div class="language-python extra-class"><pre class="language-python"><code>b <span class="token operator">=</span> dls<span class="token punctuation">.</span>one_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">type</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>__main__.SiameseImage
</code></pre></div><p>When we call <code>show_batch</code>, the fastai library will realize the batch as a whole has a show method, so it must know how to show itself. It will send that batch directly to the type-dispatched function <code>show_batch</code>. The signature of this function is the following:</p> <div class="language-python extra-class"><pre class="language-python"><code>show_batch<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> samples<span class="token punctuation">,</span> ctxs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
</code></pre></div><p>where the kwargs are specific to the application (here we will have <code>nrows</code>, <code>ncols</code> and <code>figsize</code> for instance). In our case, the batch will be sent as a whole to <code>x</code> and <code>y</code> and <code>samples</code> will be <code>None</code> (those arguments are used when the batch does not have a type that knows how to show itself, see the next section).</p> <p>To write our custom <code>show_batch</code> we just need to use the type annotation on <code>x</code> like this:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@typedispatch</span>
<span class="token keyword">def</span> <span class="token function">show_batch</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span>SiameseImage<span class="token punctuation">,</span> y<span class="token punctuation">,</span> samples<span class="token punctuation">,</span> ctxs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> max_n<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> nrows<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> ncols<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> figsize <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> figsize <span class="token operator">=</span> <span class="token punctuation">(</span>ncols<span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span> max_n<span class="token operator">//</span>ncols <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ctxs <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> ctxs <span class="token operator">=</span> get_grid<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> max_n<span class="token punctuation">)</span><span class="token punctuation">,</span> nrows<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> ncols<span class="token operator">=</span>ncols<span class="token punctuation">,</span> figsize<span class="token operator">=</span>figsize<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span>ctx <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>ctxs<span class="token punctuation">)</span><span class="token punctuation">:</span> SiameseImage<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Not similar'</span><span class="token punctuation">,</span><span class="token string">'Similar'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span>ctx<span class="token operator">=</span>ctx<span class="token punctuation">)</span>
</code></pre></div><p>We will see in the next section that the behavior is different when we have a batch that does not have a show method (which is the case most of the time, only the input and target of the batch have those show methods). In that case, the arguments <code>y</code> and <code>samples</code> are useful. Here, everything is in <code>x</code>, because since the batch knows how to show itself as a whole, it is sent as a whole.</p> <p>Here, we create a list of matplotlib axis with the utility function <a href="/fastai/vision.data.html#get_grid"><code>get_grid</code></a> then pass it along to all <code>SiameseImage.show</code>. Let's see how this looks in practice:</p> <div class="language-python extra-class"><pre class="language-python"><code>b <span class="token operator">=</span> dls<span class="token punctuation">.</span>one_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>_types
</code></pre></div><div class="language- extra-class"><pre><code>{__main__.SiameseImage: [fastai.torch_core.TensorImage,
  fastai.torch_core.TensorImage,
  torch.Tensor]}
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_71_0.png" alt="png"></p> <p>And we will see in the training section it's as easy to make a custom <code>show_results</code>. Now let's see how we could have written our own data block.</p> <h3 id="writing-your-custom-data-block"><a href="#writing-your-custom-data-block" class="header-anchor">#</a> Writing your custom data block</h3> <p>The siamese problem is just a particular case of problem with our inputs being a tuple of images and our target being a category. If the type &quot;tuple of images&quot; comes again in other problems with a different target, it might be useful to create a custom block for it, to be able to leverage the power of the data block API.</p> <p><strong>NB:</strong> if your problem only has one particular setup and you don't need the modular aspect for various targets, what we did before is perfectly fine and you should look no further.</p> <p>Let's create a type to represent our tuple of two images:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">ImageTuple</span><span class="token punctuation">(</span>fastuple<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> fns<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token builtin">tuple</span><span class="token punctuation">(</span>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> fns<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ctx<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span> 
        t1<span class="token punctuation">,</span>t2 <span class="token operator">=</span> self
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> Tensor<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>t2<span class="token punctuation">,</span> Tensor<span class="token punctuation">)</span> <span class="token keyword">or</span> t1<span class="token punctuation">.</span>shape <span class="token operator">!=</span> t2<span class="token punctuation">.</span>shape<span class="token punctuation">:</span> <span class="token keyword">return</span> ctx
        line <span class="token operator">=</span> t1<span class="token punctuation">.</span>new_zeros<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> show_image<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>t1<span class="token punctuation">,</span>line<span class="token punctuation">,</span>t2<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>ctx<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
</code></pre></div><p>Since it's a subclass of <a href="https://fastcore.fast.ai/utils#fastuple" target="_blank" rel="noopener noreferrer"><code>fastuple</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s will be applied over each part of the tuple. For instance <a href="/fastai/data.transforms.html#ToTensor"><code>ToTensor</code></a> will convert this <code>ImageTuple</code> to a tuple of <a href="/fastai/torch_core.html#TensorImage"><code>TensorImage</code></a>s:</p> <div class="language-python extra-class"><pre class="language-python"><code>img <span class="token operator">=</span> ImageTuple<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> files<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
tst <span class="token operator">=</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
<span class="token builtin">type</span><span class="token punctuation">(</span>tst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span>tst<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>(fastai.torch_core.TensorImage, fastai.torch_core.TensorImage)
</code></pre></div><p>In the show method, we did not bother with non-tensor elements this time (we could copy and paste the same code as before). Showing assumes we have a resize transform and that we convert the images to tensors in our procesing pipeline:</p> <div class="language-python extra-class"><pre class="language-python"><code>img1 <span class="token operator">=</span> Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
tst <span class="token operator">=</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>img1<span class="token punctuation">)</span>
tst<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="output_79_0.png" alt="png"></p> <p>We can now define a block associated to <code>ImageTuple</code> that we will use in the data block API. A block is basically a set of default transforms, here we specify how to create the <code>ImageTuple</code> and the <a href="/fastai/data.transforms.html#IntToFloatTensor"><code>IntToFloatTensor</code></a> transform necessary for image preprocessing:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">ImageTupleBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> TransformBlock<span class="token punctuation">(</span>type_tfms<span class="token operator">=</span>ImageTuple<span class="token punctuation">.</span>create<span class="token punctuation">,</span> batch_tfms<span class="token operator">=</span>IntToFloatTensor<span class="token punctuation">)</span>
</code></pre></div><p>To gather our data with the data block API we will use the following functions:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">draw_other</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
    same <span class="token operator">=</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span>
    cls <span class="token operator">=</span> label_func<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> same<span class="token punctuation">:</span> cls <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>L<span class="token punctuation">(</span>l <span class="token keyword">for</span> l <span class="token keyword">in</span> labels <span class="token keyword">if</span> l <span class="token operator">!=</span> cls<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">return</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>lbl2files<span class="token punctuation">[</span>cls<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>same
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_tuple_files</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    files <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>f<span class="token punctuation">,</span> <span class="token operator">*</span>draw_other<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> files<span class="token punctuation">]</span>
</code></pre></div><p>And we are ready to define our block:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_x</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">get_y</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>siamese <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>
    blocks<span class="token operator">=</span><span class="token punctuation">(</span>ImageTupleBlock<span class="token punctuation">,</span> CategoryBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_items<span class="token operator">=</span>get_tuple_files<span class="token punctuation">,</span>
    get_x<span class="token operator">=</span>get_x<span class="token punctuation">,</span> get_y<span class="token operator">=</span>get_y<span class="token punctuation">,</span>
    splitter<span class="token operator">=</span>RandomSplitter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    item_tfms<span class="token operator">=</span>Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    batch_tfms<span class="token operator">=</span><span class="token punctuation">[</span>Normalize<span class="token punctuation">.</span>from_stats<span class="token punctuation">(</span><span class="token operator">*</span>imagenet_stats<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> siamese<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">&quot;images&quot;</span><span class="token punctuation">,</span> path<span class="token operator">=</span>path<span class="token punctuation">)</span>
</code></pre></div><p>We can check the types of the elements in one batch with the <a href="https://fastcore.fast.ai/dispatch#explode_types" target="_blank" rel="noopener noreferrer"><code>explode_types</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> method. Here we have a tuple with one <code>ImageTuple</code> of two <a href="/fastai/torch_core.html#TensorImage"><code>TensorImage</code></a>s and one <a href="/fastai/torch_core.html#TensorCategory"><code>TensorCategory</code></a>. The transform properly kept the types of everything even after collating the samples together!</p> <div class="language-python extra-class"><pre class="language-python"><code>b <span class="token operator">=</span> dls<span class="token punctuation">.</span>one_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
explode_types<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>{tuple: [{__main__.ImageTuple: [fastai.torch_core.TensorImage,
    fastai.torch_core.TensorImage]},
  fastai.torch_core.TensorCategory]}
</code></pre></div><p>The <code>show_batch</code> method here works out of the box, but to customize how things are organized, we can define a dispatched <code>show_batch</code> function. Here the whole batch is just a tuple, so doesn't have a show method. The fastai library will dispatch on the first part of the tuple (x) and second part of the tuple (y), the actual samples being in the <code>samples</code> variable.</p> <p>Here we only dispatch on the <code>x</code> (which means this method will be used for <code>x</code>s that are <code>ImageTuple</code> and any <code>y</code>s), but we could have custom behaviors depending on the targets.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@typedispatch</span>
<span class="token keyword">def</span> <span class="token function">show_batch</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span>ImageTuple<span class="token punctuation">,</span> y<span class="token punctuation">,</span> samples<span class="token punctuation">,</span> ctxs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> max_n<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> nrows<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> ncols<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> figsize <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> figsize <span class="token operator">=</span> <span class="token punctuation">(</span>ncols<span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span> max_n<span class="token operator">//</span>ncols <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ctxs <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> ctxs <span class="token operator">=</span> get_grid<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>samples<span class="token punctuation">)</span><span class="token punctuation">,</span> max_n<span class="token punctuation">)</span><span class="token punctuation">,</span> nrows<span class="token operator">=</span>nrows<span class="token punctuation">,</span> ncols<span class="token operator">=</span>ncols<span class="token punctuation">,</span> figsize<span class="token operator">=</span>figsize<span class="token punctuation">)</span>
    ctxs <span class="token operator">=</span> show_batch<span class="token punctuation">[</span><span class="token builtin">object</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> samples<span class="token punctuation">,</span> ctxs<span class="token operator">=</span>ctxs<span class="token punctuation">,</span> max_n<span class="token operator">=</span>max_n<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ctxs
</code></pre></div><p>As a sidenote, <code>x</code>and <code>y</code> are not actually used (all that needs to be shown is in the <code>samples</code> list). They are only passed along for type-dispatching because they carry the types of our inputs and targets.</p> <p>We can now have a look:</p> <div class="language-python extra-class"><pre class="language-python"><code>b <span class="token operator">=</span> dls<span class="token punctuation">.</span>one_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_95_0.png" alt="png"></p> <h2 id="training-a-model"><a href="#training-a-model" class="header-anchor">#</a> Training a model</h2> <h3 id="the-model"><a href="#the-model" class="header-anchor">#</a> The model</h3> <p>We are now at the stage where we can train a model on this data. We will use a very simple approach: take the body of a pretrained model and make the two images pass through it. Then build a head the usual way, with just twice as many features. The model in itself can be written like this:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SiameseModel</span><span class="token punctuation">(</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> encoder<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>encoder<span class="token punctuation">,</span>self<span class="token punctuation">.</span>head <span class="token operator">=</span> encoder<span class="token punctuation">,</span>head
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ftrs <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>encoder<span class="token punctuation">(</span>x1<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>encoder<span class="token punctuation">(</span>x2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>head<span class="token punctuation">(</span>ftrs<span class="token punctuation">)</span>
</code></pre></div><p>For our encoder, we use the fastai function <a href="/fastai/vision.learner.html#create_body"><code>create_body</code></a>. It takes an architecture and an index where to cut it. By default it will use the pretrained version of the model we pick. If we want to check where fastai usually cuts the model, we can have a look at the <a href="/fastai/vision.learner.html#model_meta"><code>model_meta</code></a> dictionary:</p> <div class="language-python extra-class"><pre class="language-python"><code>model_meta<span class="token punctuation">[</span>resnet34<span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>{'cut': -2,
 'split': &lt;function fastai.vision.learner._resnet_split(m)&gt;,
 'stats': ([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])}
</code></pre></div><p>So we need to cut at -2:</p> <div class="language-python extra-class"><pre class="language-python"><code>encoder <span class="token operator">=</span> create_body<span class="token punctuation">(</span>resnet34<span class="token punctuation">,</span> cut<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><p>Let's have a look at the last block of this encoder:</p> <div class="language-python extra-class"><pre class="language-python"><code>encoder<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>Sequential(
  (0): BasicBlock(
    (conv1): Conv2d(256, 512, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
    (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu): ReLU(inplace=True)
    (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
    (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (downsample): Sequential(
      (0): Conv2d(256, 512, kernel_size=(1, 1), stride=(2, 2), bias=False)
      (1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    )
  )
  (1): BasicBlock(
    (conv1): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
    (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu): ReLU(inplace=True)
    (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
    (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  )
  (2): BasicBlock(
    (conv1): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
    (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu): ReLU(inplace=True)
    (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
    (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  )
)
</code></pre></div><p>It ends up with 512 features, so for our custom head, we will need to multiply this by 4 (i.e. 2*2): 2 because we have two images concatenated, and another 2 because of the fastai concat-pool trick (we concatenate the average pool and the max pool of the features). The <a href="/fastai/vision.learner.html#create_head"><code>create_head</code></a> function will give us the head that is usually used in fastai's transfer learning models.</p> <p>We also need to define the number of outputs of our head <code>n_out</code>, in our case it's 2: One for predicting both images are from the same class, and the other, to predict the contrary.</p> <div class="language-python extra-class"><pre class="language-python"><code>head <span class="token operator">=</span> create_head<span class="token punctuation">(</span><span class="token number">512</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> ps<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
model <span class="token operator">=</span> SiameseModel<span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> head<span class="token punctuation">)</span>
</code></pre></div><p>Let's have a look at the generated head:</p> <div class="language-python extra-class"><pre class="language-python"><code>head
</code></pre></div><div class="language- extra-class"><pre><code>Sequential(
  (0): AdaptiveConcatPool2d(
    (ap): AdaptiveAvgPool2d(output_size=1)
    (mp): AdaptiveMaxPool2d(output_size=1)
  )
  (1): Flatten(full=False)
  (2): BatchNorm1d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (3): Dropout(p=0.25, inplace=False)
  (4): Linear(in_features=2048, out_features=512, bias=False)
  (5): ReLU(inplace=True)
  (6): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (7): Dropout(p=0.5, inplace=False)
  (8): Linear(in_features=512, out_features=2, bias=False)
)
</code></pre></div><h3 id="train-the-model"><a href="#train-the-model" class="header-anchor">#</a> Train the model</h3> <p>We are almost ready to train our model. The last piece missing is a custom splitter: in order to use transfer learning efficiently, we will want to freeze the pretrained model at first, and train only the head. A splitter is a function that takes a model and returns lists of parameters. The <a href="/fastai/torch_core.html#params"><code>params</code></a> function is useful to return all parameters of the model, so we can create a simple splitter like so:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">siamese_splitter</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>params<span class="token punctuation">(</span>model<span class="token punctuation">.</span>encoder<span class="token punctuation">)</span><span class="token punctuation">,</span> params<span class="token punctuation">(</span>model<span class="token punctuation">.</span>head<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p>Then we use the traditional <a href="/fastai/layers.html#CrossEntropyLossFlat"><code>CrossEntropyLossFlat</code></a> loss function from fastai (the same as <code>nn.CrossEntropyLoss</code>, but flattened). The only thing is, if using the data built by the mid-level API, we have a tensor of bools for our targets, so we need to convert it to integers otherwise PyTorch will throw an error.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">loss_func</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> targ<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> CrossEntropyLossFlat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> targ<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Let's grab the data as built by the mid-level API:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SiameseTransform</span><span class="token punctuation">(</span>Transform<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> files<span class="token punctuation">,</span> splits<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token punctuation">{</span>f<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_draw<span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> files<span class="token punctuation">[</span>splits<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        
    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        f2<span class="token punctuation">,</span>t <span class="token operator">=</span> self<span class="token punctuation">.</span>valid<span class="token punctuation">.</span>get<span class="token punctuation">(</span>f<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_draw<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span>
        img1<span class="token punctuation">,</span>img2 <span class="token operator">=</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>f2<span class="token punctuation">)</span>
        <span class="token keyword">return</span> SiameseImage<span class="token punctuation">(</span>img1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">_draw</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        same <span class="token operator">=</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span>
        cls <span class="token operator">=</span> label_func<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> same<span class="token punctuation">:</span> cls <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>L<span class="token punctuation">(</span>l <span class="token keyword">for</span> l <span class="token keyword">in</span> labels <span class="token keyword">if</span> l <span class="token operator">!=</span> cls<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>lbl2files<span class="token punctuation">[</span>cls<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>same
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>splits <span class="token operator">=</span> RandomSplitter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>
tfm <span class="token operator">=</span> SiameseTransform<span class="token punctuation">(</span>files<span class="token punctuation">,</span> splits<span class="token punctuation">)</span>
tls <span class="token operator">=</span> TfmdLists<span class="token punctuation">(</span>files<span class="token punctuation">,</span> tfm<span class="token punctuation">,</span> splits<span class="token operator">=</span>splits<span class="token punctuation">)</span>
dls <span class="token operator">=</span> tls<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>after_item<span class="token operator">=</span><span class="token punctuation">[</span>Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">]</span><span class="token punctuation">,</span> 
                      after_batch<span class="token operator">=</span><span class="token punctuation">[</span>IntToFloatTensor<span class="token punctuation">,</span> Normalize<span class="token punctuation">.</span>from_stats<span class="token punctuation">(</span><span class="token operator">*</span>imagenet_stats<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>We can then create our <a href="/fastai/learner.html#Learner"><code>Learner</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> Learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_func<span class="token operator">=</span>CrossEntropyLossFlat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> splitter<span class="token operator">=</span>siamese_splitter<span class="token punctuation">,</span> metrics<span class="token operator">=</span>accuracy<span class="token punctuation">)</span>
</code></pre></div><p>Since we are not using a convenience function that directly creates the <a href="/fastai/learner.html#Learner"><code>Learner</code></a> for us, we need to <code>freeze</code> it manually:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>freeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Then we can use the learning rate finder:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>lr_find<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>SuggestedLRs(lr_min=0.002754228748381138, lr_steep=7.585775847473997e-07)
</code></pre></div><p><img src="output_124_2.png" alt="png"></p> <p>Train for a bit the head:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>fit_one_cycle<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.550977</td> <td>0.351593</td> <td>0.850474</td> <td>00:45</td></tr> <tr><td>1</td> <td>0.378934</td> <td>0.222842</td> <td>0.915426</td> <td>00:45</td></tr> <tr><td>2</td> <td>0.306278</td> <td>0.184933</td> <td>0.937754</td> <td>00:45</td></tr> <tr><td>3</td> <td>0.248138</td> <td>0.157665</td> <td>0.943166</td> <td>00:45</td></tr></tbody></table> <p>Unfreeze and train the full model for a little more:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>unfreeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>fit_one_cycle<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.230968</td> <td>0.148749</td> <td>0.941137</td> <td>00:59</td></tr> <tr><td>1</td> <td>0.219091</td> <td>0.144396</td> <td>0.943843</td> <td>00:59</td></tr> <tr><td>2</td> <td>0.223325</td> <td>0.146520</td> <td>0.944520</td> <td>00:59</td></tr> <tr><td>3</td> <td>0.217614</td> <td>0.143189</td> <td>0.945873</td> <td>00:59</td></tr></tbody></table> <h3 id="making-show-results-work"><a href="#making-show-results-work" class="header-anchor">#</a> Making show_results work</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@typedispatch</span>
<span class="token keyword">def</span> <span class="token function">show_results</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span>SiameseImage<span class="token punctuation">,</span> y<span class="token punctuation">,</span> samples<span class="token punctuation">,</span> outs<span class="token punctuation">,</span> ctxs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> max_n<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> nrows<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> ncols<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> figsize <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> figsize <span class="token operator">=</span> <span class="token punctuation">(</span>ncols<span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span> max_n<span class="token operator">//</span>ncols <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ctxs <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> ctxs <span class="token operator">=</span> get_grid<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> max_n<span class="token punctuation">)</span><span class="token punctuation">,</span> nrows<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> ncols<span class="token operator">=</span>ncols<span class="token punctuation">,</span> figsize<span class="token operator">=</span>figsize<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span>ctx <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>ctxs<span class="token punctuation">)</span><span class="token punctuation">:</span> 
        title <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'Actual: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token string">&quot;Not similar&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Similar&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> \n Prediction: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token string">&quot;Not similar&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Similar&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>
        SiameseImage<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span>ctx<span class="token operator">=</span>ctx<span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>show_results<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_132_1.png" alt="png"></p> <h3 id="patch-in-a-siampredict-method-to-learner-to-automatically-show-images-and-prediction"><a href="#patch-in-a-siampredict-method-to-learner-to-automatically-show-images-and-prediction" class="header-anchor">#</a> Patch in a <code>siampredict</code> method to <a href="/fastai/learner.html#Learner"><code>Learner</code></a>, to automatically show images and prediction</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@patch</span>
<span class="token keyword">def</span> <span class="token function">siampredict</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span>Learner<span class="token punctuation">,</span> item<span class="token punctuation">,</span> rm_type_tfms<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> with_input<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> self<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>item<span class="token punctuation">,</span> rm_type_tfms<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> with_input<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> tensor<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        SiameseImage<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'Prediction: Not similar'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        SiameseImage<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'Prediction: Similar'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>imgtest <span class="token operator">=</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
imgval <span class="token operator">=</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
siamtest <span class="token operator">=</span> SiameseImage<span class="token punctuation">(</span>imgval<span class="token punctuation">,</span> imgtest<span class="token punctuation">)</span>
siamtest<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="output_135_0.png" alt="png"></p> <div class="language-python extra-class"><pre class="language-python"><code>res <span class="token operator">=</span> learn<span class="token punctuation">.</span>siampredict<span class="token punctuation">(</span>siamtest<span class="token punctuation">)</span>
</code></pre></div><p><img src="output_136_1.png" alt="png"></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/fastai/assets/js/app.f17b0f11.js" defer></script><script src="/fastai/assets/js/3.7e8af7b4.js" defer></script><script src="/fastai/assets/js/61.d6a10937.js" defer></script>
  </body>
</html>
