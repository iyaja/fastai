<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Computer vision</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="Welcome to fastai">
    <link rel="preload" href="/fastai/assets/css/0.styles.d03aadf4.css" as="style"><link rel="preload" href="/fastai/assets/js/app.f17b0f11.js" as="script"><link rel="preload" href="/fastai/assets/js/3.7e8af7b4.js" as="script"><link rel="preload" href="/fastai/assets/js/65.f1204af6.js" as="script"><link rel="prefetch" href="/fastai/assets/js/10.8521128e.js"><link rel="prefetch" href="/fastai/assets/js/11.287f40d6.js"><link rel="prefetch" href="/fastai/assets/js/12.12842fbd.js"><link rel="prefetch" href="/fastai/assets/js/13.b531fd0e.js"><link rel="prefetch" href="/fastai/assets/js/14.3b85f440.js"><link rel="prefetch" href="/fastai/assets/js/15.015d175e.js"><link rel="prefetch" href="/fastai/assets/js/16.744581ff.js"><link rel="prefetch" href="/fastai/assets/js/17.5ea8f7a5.js"><link rel="prefetch" href="/fastai/assets/js/18.6325a7a3.js"><link rel="prefetch" href="/fastai/assets/js/19.12895d2e.js"><link rel="prefetch" href="/fastai/assets/js/20.421dab5c.js"><link rel="prefetch" href="/fastai/assets/js/21.d0965317.js"><link rel="prefetch" href="/fastai/assets/js/22.d4da69f5.js"><link rel="prefetch" href="/fastai/assets/js/23.eb6f27d0.js"><link rel="prefetch" href="/fastai/assets/js/24.7b39000f.js"><link rel="prefetch" href="/fastai/assets/js/25.4b2ae256.js"><link rel="prefetch" href="/fastai/assets/js/26.ed68ed51.js"><link rel="prefetch" href="/fastai/assets/js/27.fbc2137b.js"><link rel="prefetch" href="/fastai/assets/js/28.6c32e1f5.js"><link rel="prefetch" href="/fastai/assets/js/29.e8f4d3b8.js"><link rel="prefetch" href="/fastai/assets/js/30.f9987fa2.js"><link rel="prefetch" href="/fastai/assets/js/31.10dfab48.js"><link rel="prefetch" href="/fastai/assets/js/32.51ffa228.js"><link rel="prefetch" href="/fastai/assets/js/33.58064d56.js"><link rel="prefetch" href="/fastai/assets/js/34.ee932158.js"><link rel="prefetch" href="/fastai/assets/js/35.13e4d738.js"><link rel="prefetch" href="/fastai/assets/js/36.04e592b7.js"><link rel="prefetch" href="/fastai/assets/js/37.7cafae24.js"><link rel="prefetch" href="/fastai/assets/js/38.29b7b3ca.js"><link rel="prefetch" href="/fastai/assets/js/39.60cf076c.js"><link rel="prefetch" href="/fastai/assets/js/4.6279c390.js"><link rel="prefetch" href="/fastai/assets/js/40.ae925aa6.js"><link rel="prefetch" href="/fastai/assets/js/41.6f007865.js"><link rel="prefetch" href="/fastai/assets/js/42.ccc13ed7.js"><link rel="prefetch" href="/fastai/assets/js/43.2429f884.js"><link rel="prefetch" href="/fastai/assets/js/44.2d4ccb85.js"><link rel="prefetch" href="/fastai/assets/js/45.3c017ace.js"><link rel="prefetch" href="/fastai/assets/js/46.3caf88b0.js"><link rel="prefetch" href="/fastai/assets/js/47.a13286d5.js"><link rel="prefetch" href="/fastai/assets/js/48.551a5021.js"><link rel="prefetch" href="/fastai/assets/js/49.61f2131a.js"><link rel="prefetch" href="/fastai/assets/js/5.93fc1ade.js"><link rel="prefetch" href="/fastai/assets/js/50.372d1f7d.js"><link rel="prefetch" href="/fastai/assets/js/51.ed721b06.js"><link rel="prefetch" href="/fastai/assets/js/52.60718eb7.js"><link rel="prefetch" href="/fastai/assets/js/53.f65e2a2a.js"><link rel="prefetch" href="/fastai/assets/js/54.f9f76813.js"><link rel="prefetch" href="/fastai/assets/js/55.020bc688.js"><link rel="prefetch" href="/fastai/assets/js/56.c4856fc6.js"><link rel="prefetch" href="/fastai/assets/js/57.e115d83b.js"><link rel="prefetch" href="/fastai/assets/js/58.e58e0027.js"><link rel="prefetch" href="/fastai/assets/js/59.886eb077.js"><link rel="prefetch" href="/fastai/assets/js/6.5fa76b7a.js"><link rel="prefetch" href="/fastai/assets/js/60.c377d394.js"><link rel="prefetch" href="/fastai/assets/js/61.d6a10937.js"><link rel="prefetch" href="/fastai/assets/js/62.3f1bbe72.js"><link rel="prefetch" href="/fastai/assets/js/63.ea143add.js"><link rel="prefetch" href="/fastai/assets/js/64.4abe956e.js"><link rel="prefetch" href="/fastai/assets/js/66.e5904312.js"><link rel="prefetch" href="/fastai/assets/js/67.72451568.js"><link rel="prefetch" href="/fastai/assets/js/68.f4b4d8e2.js"><link rel="prefetch" href="/fastai/assets/js/69.2ef62d06.js"><link rel="prefetch" href="/fastai/assets/js/7.3e251b44.js"><link rel="prefetch" href="/fastai/assets/js/70.892242aa.js"><link rel="prefetch" href="/fastai/assets/js/71.348a11dd.js"><link rel="prefetch" href="/fastai/assets/js/72.735683a9.js"><link rel="prefetch" href="/fastai/assets/js/73.61a8ce4c.js"><link rel="prefetch" href="/fastai/assets/js/74.cec16c32.js"><link rel="prefetch" href="/fastai/assets/js/75.c261240c.js"><link rel="prefetch" href="/fastai/assets/js/76.d69068d6.js"><link rel="prefetch" href="/fastai/assets/js/8.c3d5d69d.js"><link rel="prefetch" href="/fastai/assets/js/9.ffbd18f1.js"><link rel="prefetch" href="/fastai/assets/js/vendors~docsearch.f5584d80.js">
    <link rel="stylesheet" href="/fastai/assets/css/0.styles.d03aadf4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fastai/" class="home-link router-link-active"><img src="https://images.exxactcorp.com/CMS/landing-page/resource-center/supported-software/logo/Deep-Learning/fastai-logo.png" alt="" class="logo"> <!----></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow down"></span></button> <button type="button" aria-label="Getting Started" class="mobile-dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><!----> <a href="/fastai/quick_start.html" class="nav-link">
  Quick Start
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tutorials" class="dropdown-title"><span class="title">Tutorials</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tutorials" class="mobile-dropdown-title"><span class="title">Tutorials</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tutorial/overview.html" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><h4>
          Beginners
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/vision.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Vision Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/text.html" class="nav-link">
  Text Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/tabular.html" class="nav-link">
  Tabular Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/colab.html" class="nav-link">
  Colab Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Intermediate
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/datablock.html" class="nav-link">
  Data Block Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/imagenette.html" class="nav-link">
  Imagenette Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/pets.html" class="nav-link">
  Pets Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/transformers.html" class="nav-link">
  Transformers Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/wikitext.html" class="nav-link">
  Wikitext Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Advanced
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/siamese.html" class="nav-link">
  Siamese Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/dev-setup.html" class="nav-link">
  Developer Guide
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Training" class="dropdown-title"><span class="title">Training</span> <span class="arrow down"></span></button> <button type="button" aria-label="Training" class="mobile-dropdown-title"><span class="title">Training</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/training/learner.html" class="nav-link">
  Training Loop
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/optimizer.html" class="nav-link">
  Optimizer
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/metrics.html" class="nav-link">
  Metrics
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/interpret.html" class="nav-link">
  Interpretation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/distributed.html" class="nav-link">
  Distributed
</a></li><li class="dropdown-item"><h4>
          Callbacks
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/callback/core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/schedule.html" class="nav-link">
  Schedulers
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/hook.html" class="nav-link">
  Hooks and callbacks
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/fp16.html" class="nav-link">
  Mixed precision
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/mixup.html" class="nav-link">
  Mixup
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/cutmix.html" class="nav-link">
  Cutmix
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/tracker.html" class="nav-link">
  Tracker
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/training.html" class="nav-link">
  Training
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/rnn.html" class="nav-link">
  RNN
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/data.html" class="nav-link">
  Data
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/progress.html" class="nav-link">
  Progress
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Data" class="dropdown-title"><span class="title">Data</span> <span class="arrow down"></span></button> <button type="button" aria-label="Data" class="mobile-dropdown-title"><span class="title">Data</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/data/block.html" class="nav-link">
  Data Blocks
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/transforms.html" class="nav-link">
  Data Transforms
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/external.html" class="nav-link">
  Data External
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/core.html" class="nav-link">
  Data Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/load.html" class="nav-link">
  DataLoaders
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Core" class="dropdown-title"><span class="title">Core</span> <span class="arrow down"></span></button> <button type="button" aria-label="Core" class="mobile-dropdown-title"><span class="title">Core</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/torch_core.html" class="nav-link">
  PyTorch Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/layers.html" class="nav-link">
  Layers
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/vision/learner.html" class="nav-link">
  Vision Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/augment.html" class="nav-link">
  Vision Data Augmentation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/data.html" class="nav-link">
  Vision Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/core.html" class="nav-link">
  Vision Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/utils.html" class="nav-link">
  Vision Utils
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/widgets.html" class="nav-link">
  Vision Widgets
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/vision/models.xresnet.html" class="nav-link">
  XResNet
</a></li><li class="dropdown-subitem"><a href="/fastai/vision/models.unet.html" class="nav-link">
  UNet
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Text" class="dropdown-title"><span class="title">Text</span> <span class="arrow down"></span></button> <button type="button" aria-label="Text" class="mobile-dropdown-title"><span class="title">Text</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/text/core.html" class="nav-link">
  Text Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/data.html" class="nav-link">
  Text Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/learner.html" class="nav-link">
  Text Learner
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/text/models.core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.awdlstm.html" class="nav-link">
  AWD LSTM
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.qrnn.html" class="nav-link">
  QRNN
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tabular/core.html" class="nav-link">
  Tabular Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/data.html" class="nav-link">
  Tabular Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/learner.html" class="nav-link">
  Tabular Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/model.html" class="nav-link">
  Tabular Model
</a></li><li class="dropdown-item"><!----> <a href="/fastai/collab.html" class="nav-link">
  Collab
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Medical" class="dropdown-title"><span class="title">Medical</span> <span class="arrow down"></span></button> <button type="button" aria-label="Medical" class="mobile-dropdown-title"><span class="title">Medical</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/medical/imaging.html" class="nav-link">
  Medical imagery
</a></li><li class="dropdown-item"><!----> <a href="/fastai/medical/text.html" class="nav-link">
  Medical text
</a></li></ul></div></div> <a href="https://github.com/fastai/fastai" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow down"></span></button> <button type="button" aria-label="Getting Started" class="mobile-dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><!----> <a href="/fastai/quick_start.html" class="nav-link">
  Quick Start
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tutorials" class="dropdown-title"><span class="title">Tutorials</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tutorials" class="mobile-dropdown-title"><span class="title">Tutorials</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tutorial/overview.html" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><h4>
          Beginners
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/vision.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Vision Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/text.html" class="nav-link">
  Text Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/tabular.html" class="nav-link">
  Tabular Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/colab.html" class="nav-link">
  Colab Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Intermediate
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/datablock.html" class="nav-link">
  Data Block Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/imagenette.html" class="nav-link">
  Imagenette Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/pets.html" class="nav-link">
  Pets Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/transformers.html" class="nav-link">
  Transformers Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/wikitext.html" class="nav-link">
  Wikitext Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Advanced
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/siamese.html" class="nav-link">
  Siamese Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/dev-setup.html" class="nav-link">
  Developer Guide
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Training" class="dropdown-title"><span class="title">Training</span> <span class="arrow down"></span></button> <button type="button" aria-label="Training" class="mobile-dropdown-title"><span class="title">Training</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/training/learner.html" class="nav-link">
  Training Loop
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/optimizer.html" class="nav-link">
  Optimizer
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/metrics.html" class="nav-link">
  Metrics
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/interpret.html" class="nav-link">
  Interpretation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/distributed.html" class="nav-link">
  Distributed
</a></li><li class="dropdown-item"><h4>
          Callbacks
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/callback/core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/schedule.html" class="nav-link">
  Schedulers
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/hook.html" class="nav-link">
  Hooks and callbacks
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/fp16.html" class="nav-link">
  Mixed precision
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/mixup.html" class="nav-link">
  Mixup
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/cutmix.html" class="nav-link">
  Cutmix
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/tracker.html" class="nav-link">
  Tracker
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/training.html" class="nav-link">
  Training
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/rnn.html" class="nav-link">
  RNN
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/data.html" class="nav-link">
  Data
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/progress.html" class="nav-link">
  Progress
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Data" class="dropdown-title"><span class="title">Data</span> <span class="arrow down"></span></button> <button type="button" aria-label="Data" class="mobile-dropdown-title"><span class="title">Data</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/data/block.html" class="nav-link">
  Data Blocks
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/transforms.html" class="nav-link">
  Data Transforms
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/external.html" class="nav-link">
  Data External
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/core.html" class="nav-link">
  Data Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/load.html" class="nav-link">
  DataLoaders
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Core" class="dropdown-title"><span class="title">Core</span> <span class="arrow down"></span></button> <button type="button" aria-label="Core" class="mobile-dropdown-title"><span class="title">Core</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/torch_core.html" class="nav-link">
  PyTorch Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/layers.html" class="nav-link">
  Layers
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/vision/learner.html" class="nav-link">
  Vision Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/augment.html" class="nav-link">
  Vision Data Augmentation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/data.html" class="nav-link">
  Vision Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/core.html" class="nav-link">
  Vision Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/utils.html" class="nav-link">
  Vision Utils
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/widgets.html" class="nav-link">
  Vision Widgets
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/vision/models.xresnet.html" class="nav-link">
  XResNet
</a></li><li class="dropdown-subitem"><a href="/fastai/vision/models.unet.html" class="nav-link">
  UNet
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Text" class="dropdown-title"><span class="title">Text</span> <span class="arrow down"></span></button> <button type="button" aria-label="Text" class="mobile-dropdown-title"><span class="title">Text</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/text/core.html" class="nav-link">
  Text Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/data.html" class="nav-link">
  Text Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/learner.html" class="nav-link">
  Text Learner
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/text/models.core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.awdlstm.html" class="nav-link">
  AWD LSTM
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.qrnn.html" class="nav-link">
  QRNN
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tabular/core.html" class="nav-link">
  Tabular Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/data.html" class="nav-link">
  Tabular Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/learner.html" class="nav-link">
  Tabular Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/model.html" class="nav-link">
  Tabular Model
</a></li><li class="dropdown-item"><!----> <a href="/fastai/collab.html" class="nav-link">
  Collab
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Medical" class="dropdown-title"><span class="title">Medical</span> <span class="arrow down"></span></button> <button type="button" aria-label="Medical" class="mobile-dropdown-title"><span class="title">Medical</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/medical/imaging.html" class="nav-link">
  Medical imagery
</a></li><li class="dropdown-item"><!----> <a href="/fastai/medical/text.html" class="nav-link">
  Medical text
</a></li></ul></div></div> <a href="https://github.com/fastai/fastai" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Computer vision</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fastai/tutorial/vision.html#single-label-classification" class="sidebar-link">Single-label classification</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fastai/tutorial/vision.html#cats-vs-dogs" class="sidebar-link">Cats vs dogs</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/vision.html#classifying-breeds" class="sidebar-link">Classifying breeds</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/vision.html#with-the-data-block-api" class="sidebar-link">With the data block API</a></li></ul></li><li><a href="/fastai/tutorial/vision.html#multi-label-classification" class="sidebar-link">Multi-label classification</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fastai/tutorial/vision.html#using-the-high-level-api" class="sidebar-link">Using the high-level API</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/vision.html#with-the-data-block-api-2" class="sidebar-link">With the data block API</a></li></ul></li><li><a href="/fastai/tutorial/vision.html#segmentation" class="sidebar-link">Segmentation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fastai/tutorial/vision.html#using-the-high-level-api-2" class="sidebar-link">Using the high-level API</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/vision.html#with-the-data-block-api-3" class="sidebar-link">With the data block API</a></li></ul></li><li><a href="/fastai/tutorial/vision.html#points" class="sidebar-link">Points</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="computer-vision"><a href="#computer-vision" class="header-anchor">#</a> Computer vision</h1> <blockquote><p>Using the fastai library in computer vision.</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastai<span class="token punctuation">.</span>vision<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
</code></pre></div><p>This tutorial highlights on how to quickly build a <a href="/fastai/learner.html#Learner"><code>Learner</code></a> and fine tune a pretrained model on most computer vision tasks.</p> <h2 id="single-label-classification"><a href="#single-label-classification" class="header-anchor">#</a> Single-label classification</h2> <p>For this task, we will use the <a href="https://www.robots.ox.ac.uk/~vgg/data/pets/" target="_blank" rel="noopener noreferrer">Oxford-IIIT Pet Dataset<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that contains images of cats and dogs of 37 different breeds. We will first show how to build a simple cat-vs-dog classifier, then a little bit more advanced model that can classify all breeds.</p> <p>The dataset can be downloaded and decompressed with this line of code:</p> <div class="language-python extra-class"><pre class="language-python"><code>path <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>PETS<span class="token punctuation">)</span>
</code></pre></div><p>It will only do this download once, and return the location of the decompressed archive. We can check what is inside with the <code>.ls()</code> method.</p> <div class="language-python extra-class"><pre class="language-python"><code>path<span class="token punctuation">.</span>ls<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>(#3) [Path('/home/ashwin/.fastai/data/oxford-iiit-pet/images'),Path('/home/ashwin/.fastai/data/oxford-iiit-pet/models'),Path('/home/ashwin/.fastai/data/oxford-iiit-pet/annotations')]
</code></pre></div><p>We will ignore the annotations folder for now, and focus on the images one. <a href="/fastai/data.transforms.html#get_image_files"><code>get_image_files</code></a> is a fastai function that helps us grab all the image files (recursively) in one folder.</p> <div class="language-python extra-class"><pre class="language-python"><code>files <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">&quot;images&quot;</span><span class="token punctuation">)</span>
<span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>7390
</code></pre></div><h3 id="cats-vs-dogs"><a href="#cats-vs-dogs" class="header-anchor">#</a> Cats vs dogs</h3> <p>To label our data for the cats vs dogs problem, we need to know which filenames are of dog pictures and which ones are of cat pictures. There is an easy way to distinguish: the name of the file begins with a capital for cats, and a lowercased letter for dogs:</p> <div class="language-python extra-class"><pre class="language-python"><code>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>files<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>(Path('/home/ashwin/.fastai/data/oxford-iiit-pet/images/yorkshire_terrier_102.jpg'),
 Path('/home/ashwin/.fastai/data/oxford-iiit-pet/images/great_pyrenees_102.jpg'))
</code></pre></div><p>We can then define an easy label function:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">label_func</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isupper<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>To get our data ready for a model, we need to put it in a <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> object. Here we have a function that labels using the file names, so we will use <a href="/fastai/vision.data.html#ImageDataLoaders.from_name_func"><code>ImageDataLoaders.from_name_func</code></a>. There are other factory methods of <a href="/fastai/vision.data.html#ImageDataLoaders"><code>ImageDataLoaders</code></a> that could be more suitable for your problem, so make sure to check them all in <a href="/fastai/vision.data.html"><code>vision.data</code></a>.</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> ImageDataLoaders<span class="token punctuation">.</span>from_name_func<span class="token punctuation">(</span>path<span class="token punctuation">,</span> files<span class="token punctuation">,</span> label_func<span class="token punctuation">,</span> item_tfms<span class="token operator">=</span>Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>We have passed to this function the directory we're working in, the <code>files</code> we grabbed, our <code>label_func</code> and one last piece as <code>item_tfms</code>: this is a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> applied on all items of our dataset that will resize each imge to 224 by 224, by using a random crop on the largest dimension to make it a square, then resizing to 224 by 224. If we didn't pass this, we would get an error later as it would be impossible to batch the items together.</p> <p>We can then check if everything looks okay with the <code>show_batch</code> method (<code>True</code> is for cat, <code>False</code> is for dog):</p> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_18_0.png" alt="png"></p> <p>Then we can create a <a href="/fastai/learner.html#Learner"><code>Learner</code></a>, which is a fastai object that combines the data and a model for training, and uses transfer learning to fine tune a pretrained model in just two lines of code:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> cnn_learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> resnet34<span class="token punctuation">,</span> metrics<span class="token operator">=</span>error_rate<span class="token punctuation">)</span>
learn<span class="token punctuation">.</span>fine_tune<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>error_rate</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.138543</td> <td>0.023240</td> <td>0.008119</td> <td>00:18</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>error_rate</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.055319</td> <td>0.017367</td> <td>0.004736</td> <td>00:24</td></tr></tbody></table> <p>The first line downloaded a model called ResNet34, pretrained on <a href="http://www.image-net.org/" target="_blank" rel="noopener noreferrer">ImageNet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, and adapted it to our specific problem. It then fine tuned that model and in a relatively short time, we get a model with an error rate of 0.3%... amazing!</p> <p>If you want to make a prediction on a new image, you can use <code>learn.predict</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>('False', tensor(0), tensor([9.9970e-01, 2.9784e-04]))
</code></pre></div><p>The predict method returns three things: the decoded prediction (here <code>False</code> for dog), the index of the predicted class and the tensor of probabilities that our image is one of a dog (here the model is quite confident!) This method accepts a filename, a PIL image or a tensor directly in this case.</p> <p>We can also have a look at some predictions with the <code>show_results</code> method:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>show_results<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_24_1.png" alt="png"></p> <p>Check out the other applications like text or tabular, or the other problems covered in this tutorial, and you will see they all share a consistent API for gathering the data and look at it, create a <a href="/fastai/learner.html#Learner"><code>Learner</code></a>, train the model and look at some predictions.</p> <h3 id="classifying-breeds"><a href="#classifying-breeds" class="header-anchor">#</a> Classifying breeds</h3> <p>To label our data with the breed name, we will use a regular expression to extract it from the filename. Looking back at a filename, we have:</p> <div class="language-python extra-class"><pre class="language-python"><code>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name
</code></pre></div><div class="language- extra-class"><pre><code>'yorkshire_terrier_187.jpg'
</code></pre></div><p>so the class is everything before the last <code>_</code> followed by some digits. A regular expression that will catch the name is thus:</p> <div class="language-python extra-class"><pre class="language-python"><code>pat <span class="token operator">=</span> <span class="token string">r'^(.*)_\d+.jpg'</span>
</code></pre></div><p>Since it's pretty common to use regular expressions to label the data (often, labels are hidden in the file names), there is a factory method to do just that:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> ImageDataLoaders<span class="token punctuation">.</span>from_name_re<span class="token punctuation">(</span>path<span class="token punctuation">,</span> files<span class="token punctuation">,</span> pat<span class="token punctuation">,</span> item_tfms<span class="token operator">=</span>Resize<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Like before, we can then use <code>show_batch</code> to have a look at our data:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_34_0.png" alt="png"></p> <p>Since classifying the exact breed of cats or dogs amongst 37 different breeds is a harder problem, we will slightly change the definition of our <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> to use data augmentation:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> ImageDataLoaders<span class="token punctuation">.</span>from_name_re<span class="token punctuation">(</span>path<span class="token punctuation">,</span> files<span class="token punctuation">,</span> pat<span class="token punctuation">,</span> item_tfms<span class="token operator">=</span>Resize<span class="token punctuation">(</span><span class="token number">460</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    batch_tfms<span class="token operator">=</span>aug_transforms<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>This time we resized to a larger size before batching, and we add <code>batch_tfms</code>. <a href="/fastai/vision.augment.html#aug_transforms"><code>aug_transforms</code></a> is a function that provides a collection of data augmentation transforms with defaults we found worked very well on most datasets (you can customize each one by passing the right arguments).</p> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_38_0.png" alt="png"></p> <p>We can then create our <a href="/fastai/learner.html#Learner"><code>Learner</code></a> exactly as before and train our model.</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> cnn_learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> resnet34<span class="token punctuation">,</span> metrics<span class="token operator">=</span>error_rate<span class="token punctuation">)</span>
</code></pre></div><p>We used the default learning rate before, but we might want to find the best one possible. For this, we can use the learning rate finder:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>lr_find<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>(0.010000000149011612, 0.00363078061491251)
</code></pre></div><p><img src="output_42_2.png" alt="png"></p> <p>It plots the graph of the learning rate finder and gives us two suggestions (minimum divided by 10 and steepest gradient). Let's use <code>3e-3</code> here. We will also do a bit more epochs:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>fine_tune<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>error_rate</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>1.282734</td> <td>0.274779</td> <td>0.085250</td> <td>00:14</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>error_rate</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.464303</td> <td>0.334058</td> <td>0.102165</td> <td>00:17</td></tr> <tr><td>1</td> <td>0.433266</td> <td>0.319324</td> <td>0.094723</td> <td>00:17</td></tr> <tr><td>2</td> <td>0.259503</td> <td>0.202348</td> <td>0.066306</td> <td>00:17</td></tr> <tr><td>3</td> <td>0.145520</td> <td>0.183488</td> <td>0.060217</td> <td>00:17</td></tr></tbody></table> <p>Again, we can have a look at some predictions with <code>show_results</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>show_results<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_46_1.png" alt="png"></p> <p>Another thing that is useful is an interpretation object, it can show us where the model made the worse predictions:</p> <div class="language-python extra-class"><pre class="language-python"><code>interp <span class="token operator">=</span> Interpretation<span class="token punctuation">.</span>from_learner<span class="token punctuation">(</span>learn<span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>interp<span class="token punctuation">.</span>plot_top_losses<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_49_0.png" alt="png"></p> <h3 id="with-the-data-block-api"><a href="#with-the-data-block-api" class="header-anchor">#</a> With the data block API</h3> <p>We can also use the data block API to get our data in a <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a>. This is a bit more advanced, so fell free to skip this part if you are not comfortable with learning new API's just yet.</p> <p>A datablock is built by giving the fastai library a bunch of informations:</p> <ul><li>the types used, through an argument called <code>blocks</code>: here we have images and categories, so we pass <a href="/fastai/vision.data.html#ImageBlock"><code>ImageBlock</code></a> and <a href="/fastai/data.block.html#CategoryBlock"><code>CategoryBlock</code></a>.</li> <li>how to get the raw items, here our function <a href="/fastai/data.transforms.html#get_image_files"><code>get_image_files</code></a>.</li> <li>how to label those items, here with the same regular expression as before.</li> <li>how to split those items, here with a random splitter.</li> <li>the <code>item_tfms</code> and <code>batch_tfms</code> like before.</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>pets <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>blocks<span class="token operator">=</span><span class="token punctuation">(</span>ImageBlock<span class="token punctuation">,</span> CategoryBlock<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                 get_items<span class="token operator">=</span>get_image_files<span class="token punctuation">,</span> 
                 splitter<span class="token operator">=</span>RandomSplitter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 get_y<span class="token operator">=</span>using_attr<span class="token punctuation">(</span>RegexLabeller<span class="token punctuation">(</span><span class="token string">r'(.+)_\d+.jpg$'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 item_tfms<span class="token operator">=</span>Resize<span class="token punctuation">(</span><span class="token number">460</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 batch_tfms<span class="token operator">=</span>aug_transforms<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>The pets object by itself is empty: it only containes the functions that will help us gather the data. We have to call <code>dataloaders</code> method to get a <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a>. We pass it the source of the data:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> pets<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>PETS<span class="token punctuation">)</span><span class="token operator">/</span><span class="token string">&quot;images&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Then we can look at some of our pictures with <code>dls.show_batch()</code></p> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span>max_n<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_56_0.png" alt="png"></p> <h2 id="multi-label-classification"><a href="#multi-label-classification" class="header-anchor">#</a> Multi-label classification</h2> <p>For this task, we will use the <a href="http://host.robots.ox.ac.uk/pascal/VOC/" target="_blank" rel="noopener noreferrer">Pascal Dataset<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that contains images with different kinds of objects/persons. It's orginally a dataset for object detection, meaning the task is not only to detect if there is an instance of one class of an image, but to also draw a bounding box around it. Here we will just try to predict all the classes in one given image.</p> <p>Multi-label classification defers from before in the sense each image does not belong to one category. An image could have a person <em>and</em> a horse inside it for instance. Or have none of the categories we study.</p> <p>As before, we can download the dataset pretty easily:</p> <div class="language-python extra-class"><pre class="language-python"><code>path <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>PASCAL_2007<span class="token punctuation">)</span>
path<span class="token punctuation">.</span>ls<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>(#9) [Path('/home/ashwin/.fastai/data/pascal_2007/valid.json'),Path('/home/ashwin/.fastai/data/pascal_2007/segmentation'),Path('/home/ashwin/.fastai/data/pascal_2007/train.csv'),Path('/home/ashwin/.fastai/data/pascal_2007/test.csv'),Path('/home/ashwin/.fastai/data/pascal_2007/models'),Path('/home/ashwin/.fastai/data/pascal_2007/test'),Path('/home/ashwin/.fastai/data/pascal_2007/train.json'),Path('/home/ashwin/.fastai/data/pascal_2007/train'),Path('/home/ashwin/.fastai/data/pascal_2007/test.json')]
</code></pre></div><p>The information about the labels of each image is in the file named <code>train.csv</code>. We load it using pandas:</p> <div class="language-python extra-class"><pre class="language-python"><code>df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">'train.csv'</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div><style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&lt;!--beforebegin--&gt;&lt;div class=&quot;language- extra-class&quot;&gt;&lt;!--afterbegin--&gt;&lt;pre&gt;&lt;code&gt;.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;!--beforeend--&gt;&lt;/div&gt;&lt;!--afterend--&gt;</style> <table border="1" class="dataframe"><thead><tr style="text-align:right;"><th></th> <th>fname</th> <th>labels</th> <th>is_valid</th></tr></thead> <tbody><tr><th>0</th> <td>000005.jpg</td> <td>chair</td> <td>True</td></tr> <tr><th>1</th> <td>000007.jpg</td> <td>car</td> <td>True</td></tr> <tr><th>2</th> <td>000009.jpg</td> <td>horse person</td> <td>True</td></tr> <tr><th>3</th> <td>000012.jpg</td> <td>car</td> <td>False</td></tr> <tr><th>4</th> <td>000016.jpg</td> <td>bicycle</td> <td>True</td></tr></tbody></table></div> <h3 id="using-the-high-level-api"><a href="#using-the-high-level-api" class="header-anchor">#</a> Using the high-level API</h3> <p>That's pretty straightforward: for each filename, we get the different labels (separated by space) and the last column tells if it's in the validation set or not. To get this in <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> quickly, we have a factory method, <code>from_df</code>. We can specify the underlying path where all the images are, an additional folder to add between the base path and the filenames (here <code>train</code>), the <code>valid_col</code> to consider for the validation set (if we don't specify this, we take a random subset), a <code>label_delim</code> to split the labels and, as before, <code>item_tfms</code> and <code>batch_tfms</code>.</p> <p>Note that we don't have to specify the <code>fn_col</code> and the <code>label_col</code> because they default to the first and second column respectively.</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> ImageDataLoaders<span class="token punctuation">.</span>from_df<span class="token punctuation">(</span>df<span class="token punctuation">,</span> path<span class="token punctuation">,</span> folder<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">,</span> valid_col<span class="token operator">=</span><span class="token string">'is_valid'</span><span class="token punctuation">,</span> label_delim<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">,</span>
                               item_tfms<span class="token operator">=</span>Resize<span class="token punctuation">(</span><span class="token number">460</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_tfms<span class="token operator">=</span>aug_transforms<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>As before, we can then have a look at the data with the <code>show_batch</code> method.</p> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_66_0.png" alt="png"></p> <p>Training a model is as easy as before: the same functions can be applied and the fastai library will automatically detect that we are in a multi-label problem, thus picking the right loss function. The only difference is in the metric we pass: <a href="/fastai/metrics.html#error_rate"><code>error_rate</code></a> will not work for a multi-label problem, but we can use <code>accuracy_thresh</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> cnn_learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> resnet50<span class="token punctuation">,</span> metrics<span class="token operator">=</span>partial<span class="token punctuation">(</span>accuracy_multi<span class="token punctuation">,</span> thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>As before, we can use <code>learn.lr_find</code> to pick a good learning rate:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>lr_find<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>(0.025118863582611083, 0.033113110810518265)
</code></pre></div><p><img src="output_70_2.png" alt="png"></p> <p>We can pick the suggested learning rate and fine-tune our pretrained model:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>fine_tune<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3e</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy_multi</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.429346</td> <td>0.128341</td> <td>0.958785</td> <td>00:15</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy_multi</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.161289</td> <td>0.466793</td> <td>0.925856</td> <td>00:17</td></tr> <tr><td>1</td> <td>0.167091</td> <td>0.269290</td> <td>0.945757</td> <td>00:16</td></tr> <tr><td>2</td> <td>0.145694</td> <td>0.121434</td> <td>0.956355</td> <td>00:17</td></tr> <tr><td>3</td> <td>0.118979</td> <td>0.105355</td> <td>0.962570</td> <td>00:17</td></tr></tbody></table> <p>Like before, we can easily have a look at the results:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>show_results<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_74_1.png" alt="png"></p> <p>Or get the predictions on a given image:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">'train/000005.jpg'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>((#1) ['chair'],
 tensor([False, False, False, False, False, False, False, False,  True, False,
         False, False, False, False, False, False, False, False, False, False]),
 tensor([6.0259e-05, 6.2471e-04, 2.9542e-04, 3.7423e-04, 3.9715e-02, 1.9572e-03,
         7.3608e-04, 1.7575e-02, 9.2661e-01, 6.8919e-04, 4.9777e-01, 1.2133e-02,
         1.1415e-03, 1.6763e-03, 1.2275e-01, 7.3525e-02, 5.6224e-04, 2.1502e-01,
         1.7034e-03, 1.4736e-01]))
</code></pre></div><p>As for the single classification predictions, we get three things. The last one is the prediction of the model on each class (going from 0 to 1). The second to last cooresponds to a one-hot encoded targets (you get <code>True</code> for all predicted classes, the ones that get a probability &gt; 0.5) and the first is the decoded, readable version.</p> <p>And like before, we can check where the model did its worse:</p> <div class="language-python extra-class"><pre class="language-python"><code>interp <span class="token operator">=</span> Interpretation<span class="token punctuation">.</span>from_learner<span class="token punctuation">(</span>learn<span class="token punctuation">)</span>
interp<span class="token punctuation">.</span>plot_top_losses<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:right;"><th></th> <th>target</th> <th>predicted</th> <th>probabilities</th> <th>loss</th></tr></thead> <tbody><tr><th>0</th> <td>chair;diningtable;person;pottedplant</td> <td>person</td> <td>tensor([1.3859e-07, 2.0057e-05, 1.3330e-05, 4.4968e-05, 2.4639e-05, 3.7735e-06,\n        8.4346e-04, 2.1878e-04, 1.1218e-03, 4.2916e-08, 1.4975e-03, 2.5902e-03,\n        2.4724e-05, 1.0664e-05, 9.9991e-01, 3.4751e-03, 1.5933e-05, 5.5496e-04,\n        3.3906e-05, 3.2141e-02])</td> <td>0.9498050808906555</td></tr> <tr><th>1</th> <td>bottle;person</td> <td>person</td> <td>tensor([1.7861e-12, 2.4931e-09, 1.8502e-09, 1.2212e-09, 1.9618e-08, 1.3690e-11,\n        3.2873e-06, 5.8404e-08, 2.5140e-07, 2.7120e-14, 7.0966e-07, 6.9432e-04,\n        1.1541e-09, 1.0451e-09, 1.0000e+00, 6.0462e-07, 3.4618e-08, 4.7445e-06,\n        4.1124e-09, 9.9111e-04])</td> <td>0.8874256014823914</td></tr> <tr><th>2</th> <td>bus;car;person</td> <td>person</td> <td>tensor([4.9122e-08, 5.5848e-06, 2.1049e-06, 8.9707e-06, 5.6819e-06, 1.3298e-05,\n        1.4959e-03, 5.9346e-05, 5.3715e-05, 2.1142e-09, 2.5905e-05, 6.1096e-03,\n        5.5608e-06, 3.3048e-06, 9.9968e-01, 5.6836e-05, 6.0220e-06, 2.0087e-04,\n        2.4676e-05, 3.3325e-03])</td> <td>0.8871580362319946</td></tr> <tr><th>3</th> <td>bottle;person</td> <td>person</td> <td>tensor([5.2528e-13, 1.7562e-09, 3.2824e-10, 1.1594e-09, 2.1161e-08, 1.3134e-11,\n        2.4606e-06, 3.8796e-08, 8.5993e-07, 3.3807e-15, 1.6779e-06, 1.5134e-04,\n        1.5394e-10, 5.9556e-10, 1.0000e+00, 3.3567e-06, 9.9627e-09, 8.0715e-06,\n        2.5843e-09, 4.6214e-03])</td> <td>0.8837955594062805</td></tr> <tr><th>4</th> <td>bottle;person</td> <td>person</td> <td>tensor([1.8547e-12, 2.8884e-09, 1.6598e-09, 2.4114e-09, 2.3059e-08, 6.5701e-11,\n        3.9855e-06, 4.8739e-08, 8.4072e-07, 1.9686e-14, 2.4176e-06, 3.3824e-04,\n        2.4855e-09, 1.2725e-09, 1.0000e+00, 1.8027e-06, 2.5171e-08, 6.1435e-06,\n        1.4883e-08, 3.2184e-03])</td> <td>0.8794390559196472</td></tr> <tr><th>5</th> <td>bottle;person</td> <td>person</td> <td>tensor([4.1999e-11, 1.2264e-08, 2.6133e-08, 2.0119e-08, 1.3637e-07, 6.2015e-10,\n        1.6232e-05, 1.7808e-07, 6.3830e-07, 1.1085e-12, 9.6746e-07, 4.1021e-04,\n        1.1263e-08, 1.4854e-08, 9.9999e-01, 2.1052e-06, 1.7178e-07, 8.3955e-06,\n        7.8824e-08, 1.1336e-03])</td> <td>0.7904742360115051</td></tr> <tr><th>6</th> <td>chair;diningtable;person</td> <td>person</td> <td>tensor([3.2536e-08, 5.8821e-06, 4.8512e-06, 1.5012e-05, 4.5857e-04, 1.0428e-06,\n        2.9736e-04, 4.4146e-05, 4.0318e-04, 3.7364e-09, 4.8184e-04, 1.9579e-03,\n        8.3174e-07, 3.4988e-06, 9.9994e-01, 1.4466e-03, 7.1675e-06, 4.5994e-04,\n        9.3516e-06, 2.8538e-02])</td> <td>0.774388313293457</td></tr> <tr><th>7</th> <td>bus;person</td> <td>person</td> <td>tensor([3.3093e-08, 3.1500e-06, 5.7413e-06, 3.6701e-06, 2.1493e-05, 3.8484e-07,\n        2.8466e-04, 2.2827e-05, 9.6937e-05, 1.6873e-09, 6.1497e-05, 5.1155e-03,\n        1.3798e-06, 2.3416e-06, 9.9984e-01, 8.3490e-05, 6.5483e-06, 3.6999e-04,\n        5.8180e-06, 8.0087e-03])</td> <td>0.7392368316650391</td></tr> <tr><th>8</th> <td>bus;car</td> <td>train</td> <td>tensor([1.6565e-03, 4.2173e-04, 3.1245e-04, 1.5796e-03, 2.6684e-04, 9.8883e-03,\n        1.2766e-02, 1.8388e-04, 4.5448e-03, 6.0582e-04, 1.0346e-03, 5.2797e-04,\n        1.3014e-03, 1.6428e-03, 5.4353e-02, 5.3857e-04, 8.4819e-04, 3.2369e-04,\n        9.8810e-01, 6.4698e-04])</td> <td>0.674037516117096</td></tr></tbody></table> <p><img src="output_79_1.png" alt="png"></p> <h3 id="with-the-data-block-api-2"><a href="#with-the-data-block-api-2" class="header-anchor">#</a> With the data block API</h3> <p>We can also use the data block API to get our data in a <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a>. Like we said before, feel free to skip this part if you are not comfortable with learning new APIs just yet.</p> <p>Remember how the data is structured in our dataframe:</p> <div class="language-python extra-class"><pre class="language-python"><code>df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div><style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&lt;!--beforebegin--&gt;&lt;div class=&quot;language- extra-class&quot;&gt;&lt;!--afterbegin--&gt;&lt;pre&gt;&lt;code&gt;.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;!--beforeend--&gt;&lt;/div&gt;&lt;!--afterend--&gt;</style> <table border="1" class="dataframe"><thead><tr style="text-align:right;"><th></th> <th>fname</th> <th>labels</th> <th>is_valid</th></tr></thead> <tbody><tr><th>0</th> <td>000005.jpg</td> <td>chair</td> <td>True</td></tr> <tr><th>1</th> <td>000007.jpg</td> <td>car</td> <td>True</td></tr> <tr><th>2</th> <td>000009.jpg</td> <td>horse person</td> <td>True</td></tr> <tr><th>3</th> <td>000012.jpg</td> <td>car</td> <td>False</td></tr> <tr><th>4</th> <td>000016.jpg</td> <td>bicycle</td> <td>True</td></tr></tbody></table></div> <p>In this case we build the data block by providing:</p> <ul><li>the types used: <a href="/fastai/vision.data.html#ImageBlock"><code>ImageBlock</code></a> and <a href="/fastai/data.block.html#MultiCategoryBlock"><code>MultiCategoryBlock</code></a>.</li> <li>how to get the input items from our dataframe: here we read the column <code>fname</code> and need to add path/train/ at the beginning to get proper filenames.</li> <li>how to get the targets from our dataframe: here we read the column <code>labels</code> and need to split by space.</li> <li>how to split the items, here by using the column <code>is_valid</code>.</li> <li>the <code>item_tfms</code> and <code>batch_tfms</code> like before.</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>pascal <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>blocks<span class="token operator">=</span><span class="token punctuation">(</span>ImageBlock<span class="token punctuation">,</span> MultiCategoryBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   splitter<span class="token operator">=</span>ColSplitter<span class="token punctuation">(</span><span class="token string">'is_valid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   get_x<span class="token operator">=</span>ColReader<span class="token punctuation">(</span><span class="token string">'fname'</span><span class="token punctuation">,</span> pref<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">'train'</span><span class="token punctuation">)</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   get_y<span class="token operator">=</span>ColReader<span class="token punctuation">(</span><span class="token string">'labels'</span><span class="token punctuation">,</span> label_delim<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   item_tfms <span class="token operator">=</span> Resize<span class="token punctuation">(</span><span class="token number">460</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   batch_tfms<span class="token operator">=</span>aug_transforms<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>This block is slightly different than before: we don't need to pass a function to gather all our items as the dataframe we will give already has them all. However, we do need to preprocess the row of that dataframe to get out inputs, which is why we pass a <code>get_x</code>. It defaults to the fastai function <code>noop</code>, which is why we didn't need to pass it along before.</p> <p>Like before, <code>pascal</code> is just a blueprint. We need to pass it the source of our data to be able to get <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> pascal<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
</code></pre></div><p>Then we can look at some of our pictures with <code>dls.show_batch()</code></p> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span>max_n<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_88_0.png" alt="png"></p> <h2 id="segmentation"><a href="#segmentation" class="header-anchor">#</a> Segmentation</h2> <p>Segmentation is a problem where we have to predict a category for each pixel of the image. For this task, we will use the <a href="http://mi.eng.cam.ac.uk/research/projects/VideoRec/CamVid/" target="_blank" rel="noopener noreferrer">Camvid dataset<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, a dataset of screenshots from cameras in cars. Each pixel of the image has a label such as &quot;road&quot;, &quot;car&quot; or &quot;pedestrian&quot;.</p> <p>As usual, we can download the data with our <a href="/fastai/data.external.html#untar_data"><code>untar_data</code></a> function.</p> <div class="language-python extra-class"><pre class="language-python"><code>path <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>CAMVID_TINY<span class="token punctuation">)</span>
path<span class="token punctuation">.</span>ls<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>(#5) [Path('/home/sgugger/.fastai/data/camvid_tiny/codes.txt'),Path('/home/sgugger/.fastai/data/camvid_tiny/labels'),Path('/home/sgugger/.fastai/data/camvid_tiny/models'),Path('/home/sgugger/.fastai/data/camvid_tiny/export.pkl'),Path('/home/sgugger/.fastai/data/camvid_tiny/images')]
</code></pre></div><p>The <code>images</code> folder contains the images, and the corresponding segmentation masks of labels are in the <code>labels</code> folder. The <code>codes</code> file contains the corresponding integer to class (the masks have an int value for each pixel).</p> <div class="language-python extra-class"><pre class="language-python"><code>codes <span class="token operator">=</span> np<span class="token punctuation">.</span>loadtxt<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">'codes.txt'</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span>
codes
</code></pre></div><div class="language- extra-class"><pre><code>array(['Animal', 'Archway', 'Bicyclist', 'Bridge', 'Building', 'Car',
       'CartLuggagePram', 'Child', 'Column_Pole', 'Fence', 'LaneMkgsDriv',
       'LaneMkgsNonDriv', 'Misc_Text', 'MotorcycleScooter', 'OtherMoving',
       'ParkingBlock', 'Pedestrian', 'Road', 'RoadShoulder', 'Sidewalk',
       'SignSymbol', 'Sky', 'SUVPickupTruck', 'TrafficCone',
       'TrafficLight', 'Train', 'Tree', 'Truck_Bus', 'Tunnel',
       'VegetationMisc', 'Void', 'Wall'], dtype='&lt;U17')
</code></pre></div><h3 id="using-the-high-level-api-2"><a href="#using-the-high-level-api-2" class="header-anchor">#</a> Using the high-level API</h3> <p>As before, the <a href="/fastai/data.transforms.html#get_image_files"><code>get_image_files</code></a> function helps us grab all the image filenames:</p> <div class="language-python extra-class"><pre class="language-python"><code>fnames <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">&quot;images&quot;</span><span class="token punctuation">)</span>
fnames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>Path('/home/sgugger/.fastai/data/camvid_tiny/images/0016E5_05310.png')
</code></pre></div><p>Let's have a look in the labels folder:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">&quot;labels&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ls<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>Path('/home/sgugger/.fastai/data/camvid_tiny/labels/0016E5_00840_P.png')
</code></pre></div><p>It seems the segmentation masks have the same base names as the images but with an extra <code>_P</code>, so we can define a label function:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">label_func</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> path<span class="token operator">/</span><span class="token string">&quot;labels&quot;</span><span class="token operator">/</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>fn<span class="token punctuation">.</span>stem<span class="token punctuation">}</span></span><span class="token string">_P</span><span class="token interpolation"><span class="token punctuation">{</span>fn<span class="token punctuation">.</span>suffix<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
</code></pre></div><p>We can then gather our data using <a href="/fastai/vision.data.html#SegmentationDataLoaders"><code>SegmentationDataLoaders</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> SegmentationDataLoaders<span class="token punctuation">.</span>from_label_func<span class="token punctuation">(</span>
    path<span class="token punctuation">,</span> bs<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> fnames <span class="token operator">=</span> fnames<span class="token punctuation">,</span> label_func <span class="token operator">=</span> label_func<span class="token punctuation">,</span> codes <span class="token operator">=</span> codes
<span class="token punctuation">)</span>
</code></pre></div><p>We do not need to pass <code>item_tfms</code> to resize our images here because they already are all of the same size.</p> <p>As usual, we can have a look at our data with the <code>show_batch</code> method. In this instance, the fastai library is superimposing the masks with one specific color per pixel:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span>max_n<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_104_0.png" alt="png"></p> <p>A traditional CNN won't work for segmentation, we have to use a special kind of model called a UNet, so we use <a href="/fastai/vision.learner.html#unet_learner"><code>unet_learner</code></a> to define our <a href="/fastai/learner.html#Learner"><code>Learner</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> unet_learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> resnet34<span class="token punctuation">)</span>
learn<span class="token punctuation">.</span>fine_tune<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>3.227327</td> <td>2.570531</td> <td>00:05</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>1.845436</td> <td>1.761499</td> <td>00:02</td></tr> <tr><td>1</td> <td>1.595670</td> <td>1.565473</td> <td>00:02</td></tr> <tr><td>2</td> <td>1.409528</td> <td>1.209965</td> <td>00:02</td></tr> <tr><td>3</td> <td>1.283140</td> <td>1.103817</td> <td>00:02</td></tr> <tr><td>4</td> <td>1.147777</td> <td>0.933692</td> <td>00:02</td></tr> <tr><td>5</td> <td>1.030369</td> <td>0.924723</td> <td>00:02</td></tr> <tr><td>6</td> <td>0.932455</td> <td>0.882634</td> <td>00:02</td></tr> <tr><td>7</td> <td>0.855784</td> <td>0.881755</td> <td>00:02</td></tr></tbody></table> <p>And as before, we can get some idea of the predicted results with <code>show_results</code></p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>show_results<span class="token punctuation">(</span>max_n<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_108_1.png" alt="png"></p> <h3 id="with-the-data-block-api-3"><a href="#with-the-data-block-api-3" class="header-anchor">#</a> With the data block API</h3> <p>We can also use the data block API to get our data in a <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a>. Like it's been said before, feel free to skip this part if you are not comfortable with learning new APIs just yet.</p> <p>In this case we build the data block by providing:</p> <ul><li>the types used: <a href="/fastai/vision.data.html#ImageBlock"><code>ImageBlock</code></a> and <a href="/fastai/vision.data.html#MaskBlock"><code>MaskBlock</code></a>. We provide the <code>codes</code> to <a href="/fastai/vision.data.html#MaskBlock"><code>MaskBlock</code></a> as there is no way to guess them from the data.</li> <li>how to gather our items, here by using <a href="/fastai/data.transforms.html#get_image_files"><code>get_image_files</code></a>.</li> <li>how to get the targets from our items: by using <code>label_func</code>.</li> <li>how to split the items, here randomly.</li> <li><code>batch_tfms</code> for data augmentation.</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>camvid <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>blocks<span class="token operator">=</span><span class="token punctuation">(</span>ImageBlock<span class="token punctuation">,</span> MaskBlock<span class="token punctuation">(</span>codes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   get_items <span class="token operator">=</span> get_image_files<span class="token punctuation">,</span>
                   get_y <span class="token operator">=</span> label_func<span class="token punctuation">,</span>
                   splitter<span class="token operator">=</span>RandomSplitter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   batch_tfms<span class="token operator">=</span>aug_transforms<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">160</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> camvid<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">&quot;images&quot;</span><span class="token punctuation">,</span> path<span class="token operator">=</span>path<span class="token punctuation">,</span> bs<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span>max_n<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_113_0.png" alt="png"></p> <h2 id="points"><a href="#points" class="header-anchor">#</a> Points</h2> <p>This section uses the data block API, so if you skipped it before, we recommend you skip this section as well.</p> <p>We will now look at a task where we want to predict points in a picture. For this, we will use the <a href="https://data.vision.ee.ethz.ch/cvl/gfanelli/head_pose/head_forest.html#db" target="_blank" rel="noopener noreferrer">Biwi Kinect Head Pose Dataset<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. First thing first, let's begin by downloading the dataset as usual.</p> <div class="language-python extra-class"><pre class="language-python"><code>path <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>BIWI_HEAD_POSE<span class="token punctuation">)</span>
</code></pre></div><p>Let's see what we've got!</p> <div class="language-python extra-class"><pre class="language-python"><code>path<span class="token punctuation">.</span>ls<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>(#50) [Path('/home/sgugger/.fastai/data/biwi_head_pose/01.obj'),Path('/home/sgugger/.fastai/data/biwi_head_pose/18.obj'),Path('/home/sgugger/.fastai/data/biwi_head_pose/04'),Path('/home/sgugger/.fastai/data/biwi_head_pose/10.obj'),Path('/home/sgugger/.fastai/data/biwi_head_pose/24'),Path('/home/sgugger/.fastai/data/biwi_head_pose/14.obj'),Path('/home/sgugger/.fastai/data/biwi_head_pose/20.obj'),Path('/home/sgugger/.fastai/data/biwi_head_pose/11.obj'),Path('/home/sgugger/.fastai/data/biwi_head_pose/02.obj'),Path('/home/sgugger/.fastai/data/biwi_head_pose/07')...]
</code></pre></div><p>There are 24 directories numbered from 01 to 24 (they correspond to the different persons photographed) and a corresponding .obj file (we won't need them here). We'll take a look inside one of these directories:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">'01'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ls<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>(#1000) [Path('01/frame_00087_pose.txt'),Path('01/frame_00079_pose.txt'),Path('01/frame_00114_pose.txt'),Path('01/frame_00084_rgb.jpg'),Path('01/frame_00433_pose.txt'),Path('01/frame_00323_rgb.jpg'),Path('01/frame_00428_rgb.jpg'),Path('01/frame_00373_pose.txt'),Path('01/frame_00188_rgb.jpg'),Path('01/frame_00354_rgb.jpg')...]
</code></pre></div><p>Inside the subdirectories, we have different frames, each of them come with an image (<code>\_rgb.jpg</code>) and a pose file (<code>\_pose.txt</code>). We can easily get all the image files recursively with <a href="/fastai/data.transforms.html#get_image_files"><code>get_image_files</code></a>, then write a function that converts an image filename to its associated pose file.</p> <div class="language-python extra-class"><pre class="language-python"><code>img_files <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">img2pose</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> Path<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">-7]</span><span class="token punctuation">}</span></span><span class="token string">pose.txt'</span></span><span class="token punctuation">)</span>
img2pose<span class="token punctuation">(</span>img_files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>Path('04/frame_00084_pose.txt')
</code></pre></div><p>We can have a look at our first image:</p> <div class="language-python extra-class"><pre class="language-python"><code>im <span class="token operator">=</span> PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>img_files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
im<span class="token punctuation">.</span>shape
</code></pre></div><div class="language- extra-class"><pre><code>(480, 640)
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>im<span class="token punctuation">.</span>to_thumb<span class="token punctuation">(</span><span class="token number">160</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_125_0.png" alt="png"></p> <p>The Biwi dataset web site explains the format of the pose text file associated with each image, which shows the location of the center of the head. The details of this aren't important for our purposes, so we'll just show the function we use to extract the head center point:</p> <div class="language-python extra-class"><pre class="language-python"><code>cal <span class="token operator">=</span> np<span class="token punctuation">.</span>genfromtxt<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">'01'</span><span class="token operator">/</span><span class="token string">'rgb.cal'</span><span class="token punctuation">,</span> skip_footer<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_ctr</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ctr <span class="token operator">=</span> np<span class="token punctuation">.</span>genfromtxt<span class="token punctuation">(</span>img2pose<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> skip_header<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    c1 <span class="token operator">=</span> ctr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> cal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span>ctr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> cal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    c2 <span class="token operator">=</span> ctr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> cal<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">/</span>ctr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> cal<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>c1<span class="token punctuation">,</span>c2<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>This function returns the coordinates as a tensor of two items:</p> <div class="language-python extra-class"><pre class="language-python"><code>get_ctr<span class="token punctuation">(</span>img_files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>tensor([372.4046, 245.8602])
</code></pre></div><p>We can pass this function to <a href="/fastai/data.block.html#DataBlock"><code>DataBlock</code></a> as <code>get_y</code>, since it is responsible for labeling each item. We'll resize the images to half their input size, just to speed up training a bit.</p> <p>One important point to note is that we should not just use a random splitter. The reason for this is that the same person appears in multiple images in this dataset  but we want to ensure that our model can generalise to people that it hasn't seen yet. Each folder in the dataset contains the images for one person. Therefore, we can create a splitter function which returns true for just one person, resulting in a validation set containing just that person's images.</p> <p>The only other difference to previous data block examples is that the second block is a <a href="/fastai/vision.data.html#PointBlock"><code>PointBlock</code></a>. This is necessary so that fastai knows that the labels represent coordinates; that way, it knows that when doing data augmentation, it should do the same augmentation to these coordinates as it does to the images.</p> <div class="language-python extra-class"><pre class="language-python"><code>biwi <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>
    blocks<span class="token operator">=</span><span class="token punctuation">(</span>ImageBlock<span class="token punctuation">,</span> PointBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_items<span class="token operator">=</span>get_image_files<span class="token punctuation">,</span>
    get_y<span class="token operator">=</span>get_ctr<span class="token punctuation">,</span>
    splitter<span class="token operator">=</span>FuncSplitter<span class="token punctuation">(</span><span class="token keyword">lambda</span> o<span class="token punctuation">:</span> o<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>name<span class="token operator">==</span><span class="token string">'13'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    batch_tfms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">*</span>aug_transforms<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token number">320</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                Normalize<span class="token punctuation">.</span>from_stats<span class="token punctuation">(</span><span class="token operator">*</span>imagenet_stats<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> biwi<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span>max_n<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_132_0.png" alt="png"></p> <p>Now that we have assembled our data, we can use the rest of the fastai API as usual. <a href="/fastai/vision.learner.html#cnn_learner"><code>cnn_learner</code></a> works perfectly in this case, and the library will infer the proper loss function from the data:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> cnn_learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> resnet18<span class="token punctuation">,</span> y_range<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>lr_find<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>(0.005754399299621582, 3.6307804407442745e-07)
</code></pre></div><p><img src="output_135_2.png" alt="png"></p> <p>Then we can train our model:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>fine_tune<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.057434</td> <td>0.002171</td> <td>00:31</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.005320</td> <td>0.005426</td> <td>00:39</td></tr> <tr><td>1</td> <td>0.003624</td> <td>0.000698</td> <td>00:39</td></tr> <tr><td>2</td> <td>0.002163</td> <td>0.000099</td> <td>00:39</td></tr> <tr><td>3</td> <td>0.001325</td> <td>0.000233</td> <td>00:39</td></tr></tbody></table> <p>The loss is the mean squared error, so that means we make on average an error of</p> <div class="language-python extra-class"><pre class="language-python"><code>math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">0.0001</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>0.01
</code></pre></div><p>percent when predicting our points! And we can look at those results as usual:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>show_results<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_141_1.png" alt="png"></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/fastai/assets/js/app.f17b0f11.js" defer></script><script src="/fastai/assets/js/3.7e8af7b4.js" defer></script><script src="/fastai/assets/js/65.f1204af6.js" defer></script>
  </body>
</html>
