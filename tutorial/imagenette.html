<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tutorial - Training a model on Imagenette</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="Welcome to fastai">
    <link rel="preload" href="/fastai/assets/css/0.styles.24b54ae9.css" as="style"><link rel="preload" href="/fastai/assets/js/app.e4c088e4.js" as="script"><link rel="preload" href="/fastai/assets/js/2.f1c4f916.js" as="script"><link rel="preload" href="/fastai/assets/js/56.5f3c1da5.js" as="script"><link rel="prefetch" href="/fastai/assets/js/10.99994145.js"><link rel="prefetch" href="/fastai/assets/js/11.08687312.js"><link rel="prefetch" href="/fastai/assets/js/12.40b88a98.js"><link rel="prefetch" href="/fastai/assets/js/13.83861397.js"><link rel="prefetch" href="/fastai/assets/js/14.3a1586b8.js"><link rel="prefetch" href="/fastai/assets/js/15.1cbd093c.js"><link rel="prefetch" href="/fastai/assets/js/16.c850565b.js"><link rel="prefetch" href="/fastai/assets/js/17.9c3f07b2.js"><link rel="prefetch" href="/fastai/assets/js/18.db37b5bb.js"><link rel="prefetch" href="/fastai/assets/js/19.c91272fe.js"><link rel="prefetch" href="/fastai/assets/js/20.a9c5f90d.js"><link rel="prefetch" href="/fastai/assets/js/21.e40307f7.js"><link rel="prefetch" href="/fastai/assets/js/22.8fcdc465.js"><link rel="prefetch" href="/fastai/assets/js/23.14fb4a2d.js"><link rel="prefetch" href="/fastai/assets/js/24.720b52ea.js"><link rel="prefetch" href="/fastai/assets/js/25.7912d1b1.js"><link rel="prefetch" href="/fastai/assets/js/26.366239e0.js"><link rel="prefetch" href="/fastai/assets/js/27.6db2df9e.js"><link rel="prefetch" href="/fastai/assets/js/28.ffbcb114.js"><link rel="prefetch" href="/fastai/assets/js/29.7b21b9fd.js"><link rel="prefetch" href="/fastai/assets/js/3.6e2ab6c3.js"><link rel="prefetch" href="/fastai/assets/js/30.248393fd.js"><link rel="prefetch" href="/fastai/assets/js/31.b22a56a0.js"><link rel="prefetch" href="/fastai/assets/js/32.85f7da41.js"><link rel="prefetch" href="/fastai/assets/js/33.e44ef8ee.js"><link rel="prefetch" href="/fastai/assets/js/34.9ce56e10.js"><link rel="prefetch" href="/fastai/assets/js/35.4bdc5816.js"><link rel="prefetch" href="/fastai/assets/js/36.67e5f7d9.js"><link rel="prefetch" href="/fastai/assets/js/37.36c20575.js"><link rel="prefetch" href="/fastai/assets/js/38.06c462ff.js"><link rel="prefetch" href="/fastai/assets/js/39.749b6672.js"><link rel="prefetch" href="/fastai/assets/js/4.a083dd6e.js"><link rel="prefetch" href="/fastai/assets/js/40.c732859b.js"><link rel="prefetch" href="/fastai/assets/js/41.4474ab47.js"><link rel="prefetch" href="/fastai/assets/js/42.5ee2fc2f.js"><link rel="prefetch" href="/fastai/assets/js/43.cc635513.js"><link rel="prefetch" href="/fastai/assets/js/44.152c8da5.js"><link rel="prefetch" href="/fastai/assets/js/45.4cff1d71.js"><link rel="prefetch" href="/fastai/assets/js/46.85dce95d.js"><link rel="prefetch" href="/fastai/assets/js/47.59fb5617.js"><link rel="prefetch" href="/fastai/assets/js/48.f20ef06e.js"><link rel="prefetch" href="/fastai/assets/js/49.9625880a.js"><link rel="prefetch" href="/fastai/assets/js/5.bb68e855.js"><link rel="prefetch" href="/fastai/assets/js/50.b2e6dee9.js"><link rel="prefetch" href="/fastai/assets/js/51.267442e2.js"><link rel="prefetch" href="/fastai/assets/js/52.10494ddd.js"><link rel="prefetch" href="/fastai/assets/js/53.093941a1.js"><link rel="prefetch" href="/fastai/assets/js/54.fbc03694.js"><link rel="prefetch" href="/fastai/assets/js/55.0b1efc19.js"><link rel="prefetch" href="/fastai/assets/js/57.a3e942a9.js"><link rel="prefetch" href="/fastai/assets/js/58.d3ded5e3.js"><link rel="prefetch" href="/fastai/assets/js/59.ec1d3156.js"><link rel="prefetch" href="/fastai/assets/js/6.f6c9602c.js"><link rel="prefetch" href="/fastai/assets/js/60.37aa0b8a.js"><link rel="prefetch" href="/fastai/assets/js/61.ef622343.js"><link rel="prefetch" href="/fastai/assets/js/62.e733d0f9.js"><link rel="prefetch" href="/fastai/assets/js/63.a3aa571a.js"><link rel="prefetch" href="/fastai/assets/js/64.8b06642f.js"><link rel="prefetch" href="/fastai/assets/js/65.97cf2dfa.js"><link rel="prefetch" href="/fastai/assets/js/66.7f97711c.js"><link rel="prefetch" href="/fastai/assets/js/67.31ee059f.js"><link rel="prefetch" href="/fastai/assets/js/68.d013d2de.js"><link rel="prefetch" href="/fastai/assets/js/69.50b9f11d.js"><link rel="prefetch" href="/fastai/assets/js/7.c1cdf251.js"><link rel="prefetch" href="/fastai/assets/js/70.1b6f8370.js"><link rel="prefetch" href="/fastai/assets/js/71.8c3557b5.js"><link rel="prefetch" href="/fastai/assets/js/72.2d857b7b.js"><link rel="prefetch" href="/fastai/assets/js/73.0be86c71.js"><link rel="prefetch" href="/fastai/assets/js/74.a9279ff6.js"><link rel="prefetch" href="/fastai/assets/js/75.f6ce5fb3.js"><link rel="prefetch" href="/fastai/assets/js/8.be08f3ee.js"><link rel="prefetch" href="/fastai/assets/js/9.209ff10c.js">
    <link rel="stylesheet" href="/fastai/assets/css/0.styles.24b54ae9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fastai/" class="home-link router-link-active"><img src="https://images.exxactcorp.com/CMS/landing-page/resource-center/supported-software/logo/Deep-Learning/fastai-logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow down"></span></button> <button type="button" aria-label="Getting Started" class="mobile-dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><!----> <a href="/fastai/quick_start.html" class="nav-link">
  Quick Start
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tutorials" class="dropdown-title"><span class="title">Tutorials</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tutorials" class="mobile-dropdown-title"><span class="title">Tutorials</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tutorial/overview.html" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><h4>
          Beginners
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/vision.html" class="nav-link">
  Vision Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/text.html" class="nav-link">
  Text Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/tabular.html" class="nav-link">
  Tabular Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/colab.html" class="nav-link">
  Colab Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Intermediate
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/datablock.html" class="nav-link">
  Data Block Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/imagenette.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Imagenette Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/pets.html" class="nav-link">
  Pets Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/transformers.html" class="nav-link">
  Transformers Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/wikitext.html" class="nav-link">
  Wikitext Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Advanced
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/siamese.html" class="nav-link">
  Siamese Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/dev-setup.html" class="nav-link">
  Developer Guide
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Training" class="dropdown-title"><span class="title">Training</span> <span class="arrow down"></span></button> <button type="button" aria-label="Training" class="mobile-dropdown-title"><span class="title">Training</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/training/learner.html" class="nav-link">
  Training Loop
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/optimizer.html" class="nav-link">
  Optimizer
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/metrics.html" class="nav-link">
  Metrics
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/interpret.html" class="nav-link">
  Interpretation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/distributed.html" class="nav-link">
  Distributed
</a></li><li class="dropdown-item"><h4>
          Callbacks
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/callback/core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/schedule.html" class="nav-link">
  Schedulers
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/hook.html" class="nav-link">
  Hooks and callbacks
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/fp16.html" class="nav-link">
  Mixed precision
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/mixup.html" class="nav-link">
  Mixup
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/cutmix.html" class="nav-link">
  Cutmix
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/tracker.html" class="nav-link">
  Tracker
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/training.html" class="nav-link">
  Training
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/rnn.html" class="nav-link">
  RNN
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/data.html" class="nav-link">
  Data
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/progress.html" class="nav-link">
  Progress
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Data" class="dropdown-title"><span class="title">Data</span> <span class="arrow down"></span></button> <button type="button" aria-label="Data" class="mobile-dropdown-title"><span class="title">Data</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/data/block.html" class="nav-link">
  Data Blocks
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/transforms.html" class="nav-link">
  Data Transforms
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/external.html" class="nav-link">
  Data External
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/core.html" class="nav-link">
  Data Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/load.html" class="nav-link">
  DataLoaders
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Core" class="dropdown-title"><span class="title">Core</span> <span class="arrow down"></span></button> <button type="button" aria-label="Core" class="mobile-dropdown-title"><span class="title">Core</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/torch_core.html" class="nav-link">
  PyTorch Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/layers.html" class="nav-link">
  Layers
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/vision/learner.html" class="nav-link">
  Vision Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/augment.html" class="nav-link">
  Vision Data Augmentation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/data.html" class="nav-link">
  Vision Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/core.html" class="nav-link">
  Vision Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/utils.html" class="nav-link">
  Vision Utils
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/widgets.html" class="nav-link">
  Vision Widgets
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/vision/models.xresnet.html" class="nav-link">
  XResNet
</a></li><li class="dropdown-subitem"><a href="/fastai/vision/models.unet.html" class="nav-link">
  UNet
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Text" class="dropdown-title"><span class="title">Text</span> <span class="arrow down"></span></button> <button type="button" aria-label="Text" class="mobile-dropdown-title"><span class="title">Text</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/text/core.html" class="nav-link">
  Text Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/data.html" class="nav-link">
  Text Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/learner.html" class="nav-link">
  Text Learner
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/text/models.core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.awdlstm.html" class="nav-link">
  AWD LSTM
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.qrnn.html" class="nav-link">
  QRNN
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tabular/core.html" class="nav-link">
  Tabular Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/data.html" class="nav-link">
  Tabular Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/learner.html" class="nav-link">
  Tabular Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/model.html" class="nav-link">
  Tabular Model
</a></li><li class="dropdown-item"><!----> <a href="/fastai/collab.html" class="nav-link">
  Collab
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Medical" class="dropdown-title"><span class="title">Medical</span> <span class="arrow down"></span></button> <button type="button" aria-label="Medical" class="mobile-dropdown-title"><span class="title">Medical</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/medical/imaging.html" class="nav-link">
  Medical imagery
</a></li><li class="dropdown-item"><!----> <a href="/fastai/medical/text.html" class="nav-link">
  Medical text
</a></li></ul></div></div> <a href="https://github.com/fastai/fastai" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow down"></span></button> <button type="button" aria-label="Getting Started" class="mobile-dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><!----> <a href="/fastai/quick_start.html" class="nav-link">
  Quick Start
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tutorials" class="dropdown-title"><span class="title">Tutorials</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tutorials" class="mobile-dropdown-title"><span class="title">Tutorials</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tutorial/overview.html" class="nav-link">
  Overview
</a></li><li class="dropdown-item"><h4>
          Beginners
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/vision.html" class="nav-link">
  Vision Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/text.html" class="nav-link">
  Text Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/tabular.html" class="nav-link">
  Tabular Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/colab.html" class="nav-link">
  Colab Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Intermediate
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/datablock.html" class="nav-link">
  Data Block Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/imagenette.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Imagenette Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/pets.html" class="nav-link">
  Pets Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/transformers.html" class="nav-link">
  Transformers Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/tutorial/wikitext.html" class="nav-link">
  Wikitext Tutorial
</a></li></ul></li><li class="dropdown-item"><h4>
          Advanced
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/tutorial/siamese.html" class="nav-link">
  Siamese Tutorial
</a></li><li class="dropdown-subitem"><a href="/fastai/dev-setup.html" class="nav-link">
  Developer Guide
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Training" class="dropdown-title"><span class="title">Training</span> <span class="arrow down"></span></button> <button type="button" aria-label="Training" class="mobile-dropdown-title"><span class="title">Training</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/training/learner.html" class="nav-link">
  Training Loop
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/optimizer.html" class="nav-link">
  Optimizer
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/metrics.html" class="nav-link">
  Metrics
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/interpret.html" class="nav-link">
  Interpretation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/training/distributed.html" class="nav-link">
  Distributed
</a></li><li class="dropdown-item"><h4>
          Callbacks
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/callback/core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/schedule.html" class="nav-link">
  Schedulers
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/hook.html" class="nav-link">
  Hooks and callbacks
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/fp16.html" class="nav-link">
  Mixed precision
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/mixup.html" class="nav-link">
  Mixup
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/cutmix.html" class="nav-link">
  Cutmix
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/tracker.html" class="nav-link">
  Tracker
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/training.html" class="nav-link">
  Training
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/rnn.html" class="nav-link">
  RNN
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/data.html" class="nav-link">
  Data
</a></li><li class="dropdown-subitem"><a href="/fastai/callback/progress.html" class="nav-link">
  Progress
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Data" class="dropdown-title"><span class="title">Data</span> <span class="arrow down"></span></button> <button type="button" aria-label="Data" class="mobile-dropdown-title"><span class="title">Data</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/data/block.html" class="nav-link">
  Data Blocks
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/transforms.html" class="nav-link">
  Data Transforms
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/external.html" class="nav-link">
  Data External
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/core.html" class="nav-link">
  Data Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/data/load.html" class="nav-link">
  DataLoaders
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Core" class="dropdown-title"><span class="title">Core</span> <span class="arrow down"></span></button> <button type="button" aria-label="Core" class="mobile-dropdown-title"><span class="title">Core</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/torch_core.html" class="nav-link">
  PyTorch Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/layers.html" class="nav-link">
  Layers
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/vision/learner.html" class="nav-link">
  Vision Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/augment.html" class="nav-link">
  Vision Data Augmentation
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/data.html" class="nav-link">
  Vision Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/core.html" class="nav-link">
  Vision Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/utils.html" class="nav-link">
  Vision Utils
</a></li><li class="dropdown-item"><!----> <a href="/fastai/vision/widgets.html" class="nav-link">
  Vision Widgets
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/vision/models.xresnet.html" class="nav-link">
  XResNet
</a></li><li class="dropdown-subitem"><a href="/fastai/vision/models.unet.html" class="nav-link">
  UNet
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Text" class="dropdown-title"><span class="title">Text</span> <span class="arrow down"></span></button> <button type="button" aria-label="Text" class="mobile-dropdown-title"><span class="title">Text</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/text/core.html" class="nav-link">
  Text Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/data.html" class="nav-link">
  Text Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/text/learner.html" class="nav-link">
  Text Learner
</a></li><li class="dropdown-item"><h4>
          Models
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fastai/text/models.core.html" class="nav-link">
  Core
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.awdlstm.html" class="nav-link">
  AWD LSTM
</a></li><li class="dropdown-subitem"><a href="/fastai/text/models.qrnn.html" class="nav-link">
  QRNN
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/tabular/core.html" class="nav-link">
  Tabular Core
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/data.html" class="nav-link">
  Tabular Data
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/learner.html" class="nav-link">
  Tabular Learner
</a></li><li class="dropdown-item"><!----> <a href="/fastai/tabular/model.html" class="nav-link">
  Tabular Model
</a></li><li class="dropdown-item"><!----> <a href="/fastai/collab.html" class="nav-link">
  Collab
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Medical" class="dropdown-title"><span class="title">Medical</span> <span class="arrow down"></span></button> <button type="button" aria-label="Medical" class="mobile-dropdown-title"><span class="title">Medical</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fastai/medical/imaging.html" class="nav-link">
  Medical imagery
</a></li><li class="dropdown-item"><!----> <a href="/fastai/medical/text.html" class="nav-link">
  Medical text
</a></li></ul></div></div> <a href="https://github.com/fastai/fastai" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Tutorial - Training a model on Imagenette</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fastai/tutorial/imagenette.html#assemble-the-data" class="sidebar-link">Assemble the data</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fastai/tutorial/imagenette.html#loading-the-data-with-a-factory-method" class="sidebar-link">Loading the data with a factory method</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/imagenette.html#loading-the-data-with-the-data-block-api" class="sidebar-link">Loading the data with the data block API</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/imagenette.html#loading-the-data-with-the-mid-level-api" class="sidebar-link">Loading the data with the mid-level API</a></li></ul></li><li><a href="/fastai/tutorial/imagenette.html#training" class="sidebar-link">Training</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fastai/tutorial/imagenette.html#building-a-learner" class="sidebar-link">Building a Learner</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/imagenette.html#changing-the-loss-function" class="sidebar-link">Changing the loss function</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/imagenette.html#changing-the-optimizer" class="sidebar-link">Changing the optimizer</a></li><li class="sidebar-sub-header"><a href="/fastai/tutorial/imagenette.html#changing-the-training-loop-with-a-callback" class="sidebar-link">Changing the training loop with a Callback</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tutorial-training-a-model-on-imagenette"><a href="#tutorial-training-a-model-on-imagenette" class="header-anchor">#</a> Tutorial - Training a model on Imagenette</h1> <blockquote><p>A dive into the layered API of fastai in computer vision</p></blockquote> <p>The fastai library as a layered API as summarized by this graph:</p> <p><img src="/images/layered.png" alt="A layered API"></p> <p>If you are following this tutorial, you are probably already familiar with the applications, here we will see how they are powered by the high-level and mid-level API.</p> <p><a href="https://github.com/fastai/imagenette" target="_blank" rel="noopener noreferrer">Imagenette<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a subset of ImageNet with 10 very different classes. It's great to quickly experiment before trying a fleshed-out technique on the full ImageNet dataset. We will show in this tutorial how to train a model on it, using the usual high-level APIs, then delving inside the fastai library to show you how to use the mid-level APIs we designed. This way you'll be able to customize your own data collection or trainings as needed.</p> <h2 id="assemble-the-data"><a href="#assemble-the-data" class="header-anchor">#</a> Assemble the data</h2> <p>We will look at several ways to get our data in <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a>: first we will use <a href="/fastai/vision.data.html#ImageDataLoaders"><code>ImageDataLoaders</code></a> factory methods (application layer), then the data block API (high level API) and lastly, how to do the same thing with the mid-level API.</p> <h3 id="loading-the-data-with-a-factory-method"><a href="#loading-the-data-with-a-factory-method" class="header-anchor">#</a> Loading the data with a factory method</h3> <p>This is the most basic way of assembling the data that we have presented in all the beginner tutorials, so hopefully it should be familiar to you by now.</p> <p>First, we import everything inside the vision application:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastai<span class="token punctuation">.</span>vision<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
</code></pre></div><p>Then we download the dataset and decompress it (if needed) and get its location:</p> <div class="language-python extra-class"><pre class="language-python"><code>path <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>IMAGENETTE_160<span class="token punctuation">)</span>
</code></pre></div><p>We use <a href="/fastai/vision.data.html#ImageDataLoaders.from_folder"><code>ImageDataLoaders.from_folder</code></a> to get everything (since our data is organized in an imageNet-style format):</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> ImageDataLoaders<span class="token punctuation">.</span>from_folder<span class="token punctuation">(</span>path<span class="token punctuation">,</span> valid<span class="token operator">=</span><span class="token string">'val'</span><span class="token punctuation">,</span> 
    item_tfms<span class="token operator">=</span>RandomResizedCrop<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> min_scale<span class="token operator">=</span><span class="token number">0.35</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_tfms<span class="token operator">=</span>Normalize<span class="token punctuation">.</span>from_stats<span class="token punctuation">(</span><span class="token operator">*</span>imagenet_stats<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>And we can have a look at our data:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_12_0.png" alt="png"></p> <h3 id="loading-the-data-with-the-data-block-api"><a href="#loading-the-data-with-the-data-block-api" class="header-anchor">#</a> Loading the data with the data block API</h3> <p>And as we saw in previous tutorials, the <a href="/fastai/data.transforms.html#get_image_files"><code>get_image_files</code></a> function helps get all the images in subfolders:</p> <div class="language-python extra-class"><pre class="language-python"><code>fnames <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
</code></pre></div><p>Let's begin with an empty <a href="/fastai/data.block.html#DataBlock"><code>DataBlock</code></a>.</p> <div class="language-python extra-class"><pre class="language-python"><code>dblock <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>By itself, a <a href="/fastai/data.block.html#DataBlock"><code>DataBlock</code></a> is just a blue print on how to assemble your data. It does not do anything until you pass it a source. You can choose to then convert that source into a <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a> or a <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> by using the <a href="/fastai/data.block.html#DataBlock.datasets"><code>DataBlock.datasets</code></a> or <a href="/fastai/data.block.html#DataBlock.dataloaders"><code>DataBlock.dataloaders</code></a> method. Since we haven't done anything to get our data ready for batches, the <code>dataloaders</code> method will fail here, but we can have a look at how it gets converted in <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a>. This is where we pass the source of our data, here all of our filenames:</p> <div class="language-python extra-class"><pre class="language-python"><code>dsets <span class="token operator">=</span> dblock<span class="token punctuation">.</span>datasets<span class="token punctuation">(</span>fnames<span class="token punctuation">)</span>
dsets<span class="token punctuation">.</span>train<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>(Path('/home/sgugger/.fastai/data/imagenette2-160/train/n03000684/n03000684_14453.JPEG'),
 Path('/home/sgugger/.fastai/data/imagenette2-160/train/n03000684/n03000684_14453.JPEG'))
</code></pre></div><p>By default, the data block API assumes we have an input and a target, which is why we see our filename repeated twice.</p> <p>The first thing we can do is to use a <code>get_items</code> function to actually assemble our items inside the data block:</p> <div class="language-python extra-class"><pre class="language-python"><code>dblock <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>get_items <span class="token operator">=</span> get_image_files<span class="token punctuation">)</span>
</code></pre></div><p>The difference is that you then pass as a source the folder with the images and not all the filenames:</p> <div class="language-python extra-class"><pre class="language-python"><code>dsets <span class="token operator">=</span> dblock<span class="token punctuation">.</span>datasets<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
dsets<span class="token punctuation">.</span>train<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>(Path('/home/sgugger/.fastai/data/imagenette2-160/train/n03425413/n03425413_16978.JPEG'),
 Path('/home/sgugger/.fastai/data/imagenette2-160/train/n03425413/n03425413_16978.JPEG'))
</code></pre></div><p>Our inputs are ready to be processed as images (since images can be built from filenames), but our target is not. We need to convert that filename to a class name. For this, fastai provides <a href="/fastai/data.transforms.html#parent_label"><code>parent_label</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>parent_label<span class="token punctuation">(</span>fnames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>'n03425413'
</code></pre></div><p>This is not very readable, so since we can actually make the function we want, let's convert those obscure labels to something we can read:</p> <div class="language-python extra-class"><pre class="language-python"><code>lbl_dict <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    n01440764<span class="token operator">=</span><span class="token string">'tench'</span><span class="token punctuation">,</span>
    n02102040<span class="token operator">=</span><span class="token string">'English springer'</span><span class="token punctuation">,</span>
    n02979186<span class="token operator">=</span><span class="token string">'cassette player'</span><span class="token punctuation">,</span>
    n03000684<span class="token operator">=</span><span class="token string">'chain saw'</span><span class="token punctuation">,</span>
    n03028079<span class="token operator">=</span><span class="token string">'church'</span><span class="token punctuation">,</span>
    n03394916<span class="token operator">=</span><span class="token string">'French horn'</span><span class="token punctuation">,</span>
    n03417042<span class="token operator">=</span><span class="token string">'garbage truck'</span><span class="token punctuation">,</span>
    n03425413<span class="token operator">=</span><span class="token string">'gas pump'</span><span class="token punctuation">,</span>
    n03445777<span class="token operator">=</span><span class="token string">'golf ball'</span><span class="token punctuation">,</span>
    n03888257<span class="token operator">=</span><span class="token string">'parachute'</span>
<span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">label_func</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> lbl_dict<span class="token punctuation">[</span>parent_label<span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p>We can then tell our data block to use it to label our target by passing it as <code>get_y</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>dblock <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>get_items <span class="token operator">=</span> get_image_files<span class="token punctuation">,</span>
                   get_y     <span class="token operator">=</span> label_func<span class="token punctuation">)</span>

dsets <span class="token operator">=</span> dblock<span class="token punctuation">.</span>datasets<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
dsets<span class="token punctuation">.</span>train<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>(Path('/home/sgugger/.fastai/data/imagenette2-160/val/n01440764/n01440764_9931.JPEG'),
 'tench')
</code></pre></div><p>Now that our inputs and targets are ready, we can specify types to tell the data block API that our inputs are images and our targets are categories. Types are represented by blocks in the data block API, here we use <a href="/fastai/vision.data.html#ImageBlock"><code>ImageBlock</code></a> and <a href="/fastai/data.block.html#CategoryBlock"><code>CategoryBlock</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>dblock <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>blocks    <span class="token operator">=</span> <span class="token punctuation">(</span>ImageBlock<span class="token punctuation">,</span> CategoryBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   get_items <span class="token operator">=</span> get_image_files<span class="token punctuation">,</span>
                   get_y     <span class="token operator">=</span> label_func<span class="token punctuation">)</span>

dsets <span class="token operator">=</span> dblock<span class="token punctuation">.</span>datasets<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
dsets<span class="token punctuation">.</span>train<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>(PILImage mode=RGB size=240x160, TensorCategory(0))
</code></pre></div><p>We can see how the <a href="/fastai/data.block.html#DataBlock"><code>DataBlock</code></a> automatically added the transforms necessary to open the image, or how it changed the name &quot;cat&quot; to an index (with a special tensor type). To do this, it created a mapping from categories to index called &quot;vocab&quot; that we can access this way:</p> <div class="language-python extra-class"><pre class="language-python"><code>dsets<span class="token punctuation">.</span>vocab
</code></pre></div><div class="language- extra-class"><pre><code>(#10) ['English springer','French horn','cassette player','chain saw','church','garbage truck','gas pump','golf ball','parachute','tench']
</code></pre></div><p>Note that you can mix and match any block for input and targets, which is why the API is named data block API. You can also have more than two blocks (if you have multiple inputs and/or targets), you would just need to pass <code>n_inp</code> to the <a href="/fastai/data.block.html#DataBlock"><code>DataBlock</code></a> to tell the library how many inputs there are (the rest would be targets) and pass a list of functions to <code>get_x</code> and/or <code>get_y</code> (to explain how to process each item to be ready for its type). See the object detection below for such an example.</p> <p>The next step is to control how our validation set is created. We do this by passing a <code>splitter</code> to <a href="/fastai/data.block.html#DataBlock"><code>DataBlock</code></a>. For instance, here is how we split by grandparent folder.</p> <div class="language-python extra-class"><pre class="language-python"><code>dblock <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>blocks    <span class="token operator">=</span> <span class="token punctuation">(</span>ImageBlock<span class="token punctuation">,</span> CategoryBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   get_items <span class="token operator">=</span> get_image_files<span class="token punctuation">,</span>
                   get_y     <span class="token operator">=</span> label_func<span class="token punctuation">,</span>
                   splitter  <span class="token operator">=</span> GrandparentSplitter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

dsets <span class="token operator">=</span> dblock<span class="token punctuation">.</span>datasets<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
dsets<span class="token punctuation">.</span>train<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>(PILImage mode=RGB size=160x357, TensorCategory(6))
</code></pre></div><p>The last step is to specify item transforms and batch transforms (the same way as we do it in <a href="/fastai/vision.data.html#ImageDataLoaders"><code>ImageDataLoaders</code></a> factory methods):</p> <div class="language-python extra-class"><pre class="language-python"><code>dblock <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>blocks    <span class="token operator">=</span> <span class="token punctuation">(</span>ImageBlock<span class="token punctuation">,</span> CategoryBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   get_items <span class="token operator">=</span> get_image_files<span class="token punctuation">,</span>
                   get_y     <span class="token operator">=</span> label_func<span class="token punctuation">,</span>
                   splitter  <span class="token operator">=</span> GrandparentSplitter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   item_tfms <span class="token operator">=</span> RandomResizedCrop<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> min_scale<span class="token operator">=</span><span class="token number">0.35</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                   batch_tfms<span class="token operator">=</span>Normalize<span class="token punctuation">.</span>from_stats<span class="token punctuation">(</span><span class="token operator">*</span>imagenet_stats<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>With that resize, we are now able to batch items together and can finally call <code>dataloaders</code> to convert our <a href="/fastai/data.block.html#DataBlock"><code>DataBlock</code></a> to a <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> object:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> dblock<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_40_0.png" alt="png"></p> <p>Another way to compose several functions for <code>get_y</code> is to put them in a <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>imagenette <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>blocks <span class="token operator">=</span> <span class="token punctuation">(</span>ImageBlock<span class="token punctuation">,</span> CategoryBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
                       get_items <span class="token operator">=</span> get_image_files<span class="token punctuation">,</span>
                       get_y <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span>parent_label<span class="token punctuation">,</span> lbl_dict<span class="token punctuation">.</span>__getitem__<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       splitter <span class="token operator">=</span> GrandparentSplitter<span class="token punctuation">(</span>valid_name<span class="token operator">=</span><span class="token string">'val'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       item_tfms <span class="token operator">=</span> RandomResizedCrop<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> min_scale<span class="token operator">=</span><span class="token number">0.35</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       batch_tfms <span class="token operator">=</span> Normalize<span class="token punctuation">.</span>from_stats<span class="token punctuation">(</span><span class="token operator">*</span>imagenet_stats<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> imagenette<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_43_0.png" alt="png"></p> <p>To learn more about the data block API, checkout the <a href="http://docs.fast.ai/tutorial.datablock" target="_blank" rel="noopener noreferrer">data block tutorial<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>!</p> <h3 id="loading-the-data-with-the-mid-level-api"><a href="#loading-the-data-with-the-mid-level-api" class="header-anchor">#</a> Loading the data with the mid-level API</h3> <p>Now let's see how we can load the data with the medium-level API: we will learn about <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s and <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a>. The beginning is the same as before: we download our data and get all our filenames:</p> <div class="language-python extra-class"><pre class="language-python"><code>source <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>IMAGENETTE_160<span class="token punctuation">)</span>
fnames <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>source<span class="token punctuation">)</span>
</code></pre></div><p>Every bit of transformation we apply to our raw items (here the filenames) is called a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> in fastai. It's basically a function with a bit of added functionality:</p> <ul><li>it can have different behavior depending on the type it receives (this is called type dispatch)</li> <li>it will generally be applied on each element of a tuple</li></ul> <p>This way, when you have a <a href="https://fastcore.fast.ai/transform#Transform" target="_blank" rel="noopener noreferrer"><code>Transform</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> like resize, you can apply it on a tuple (image, label) and it will resize the image but not the categorical label (since there is no implementation of resize for categories). The exact same transform applied on a tuple (image, mask) will resize the image and the target, using bilinear interpolation on the image and nearest neighbor on the mask. This is how the library manages to always apply data augmentation transforms on every computer vision application (segmentation, point localization or object detection).</p> <p>Aditionnaly, a transform can have</p> <ul><li>a setup executed on the whole set (or the whole training set). This is how <a href="/fastai/data.transforms.html#Categorize"><code>Categorize</code></a> builds it vocabulary automatically.</li> <li>a decodes that can undo what the transform does for showing purposes (for instance <a href="/fastai/data.transforms.html#Categorize"><code>Categorize</code></a> will convert back an index into a category).</li></ul> <p>We won't delve into those bits of the low level API here, but you can check out the <a href="http://docs.fast.ai/tutorial.pets" target="_blank" rel="noopener noreferrer">pets tutorial<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or the more advanced <a href="http://docs.fast.ai/tutorial.siamese" target="_blank" rel="noopener noreferrer">siamese tutorial<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for more information.</p> <p>To open an image, we use the <a href="/fastai/vision.core.html#PILImage.create"><code>PILImage.create</code></a> transform. It will open the image and make it of the fastai type <a href="/fastai/vision.core.html#PILImage"><code>PILImage</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">(</span>fnames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_50_0.png" alt="png"></p> <p>In parallel, we have already seen how to get the label of our image, using <a href="/fastai/data.transforms.html#parent_label"><code>parent_label</code></a> and <code>lbl_dict</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>lbl_dict<span class="token punctuation">[</span>parent_label<span class="token punctuation">(</span>fnames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>'gas pump'
</code></pre></div><p>To make them proper categories that are mapped to an index before being fed to the model, we need to add the <a href="/fastai/data.transforms.html#Categorize"><code>Categorize</code></a> transform. If we want to apply it directly, we need to give it a vocab (so that it knows how to associate a string with an int). We already saw that we can compose several transforms by using a <a href="https://fastcore.fast.ai/transform#Pipeline" target="_blank" rel="noopener noreferrer"><code>Pipeline</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>tfm <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span>parent_label<span class="token punctuation">,</span> lbl_dict<span class="token punctuation">.</span>__getitem__<span class="token punctuation">,</span> Categorize<span class="token punctuation">(</span>vocab <span class="token operator">=</span> lbl_dict<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
tfm<span class="token punctuation">(</span>fnames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>TensorCategory(6)
</code></pre></div><p>Now to build our <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a> object, we need to specify:</p> <ul><li>our raw items</li> <li>the list of transforms that builds our inputs from the raw items</li> <li>the list of transforms that builds our targets from the raw items</li> <li>the split for training and validation</li></ul> <p>We have everything apart from the split right now, which we can build this way:</p> <div class="language-python extra-class"><pre class="language-python"><code>splits <span class="token operator">=</span> GrandparentSplitter<span class="token punctuation">(</span>valid_name<span class="token operator">=</span><span class="token string">'val'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fnames<span class="token punctuation">)</span>
</code></pre></div><p>We can then pass all of this information to <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a>.</p> <div class="language-python extra-class"><pre class="language-python"><code>dsets <span class="token operator">=</span> Datasets<span class="token punctuation">(</span>fnames<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>PILImage<span class="token punctuation">.</span>create<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>parent_label<span class="token punctuation">,</span> lbl_dict<span class="token punctuation">.</span>__getitem__<span class="token punctuation">,</span> Categorize<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> splits<span class="token operator">=</span>splits<span class="token punctuation">)</span>
</code></pre></div><p>The main difference with what we had before is that we can just pass along <a href="/fastai/data.transforms.html#Categorize"><code>Categorize</code></a> without passing it the vocab: it will build it from the training data (which it knows from <code>items</code> and <code>splits</code>) during its setup phase. Let's have a look at the first element:</p> <div class="language-python extra-class"><pre class="language-python"><code>dsets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>(PILImage mode=RGB size=213x160, TensorCategory(6))
</code></pre></div><p>We can also use our <a href="/fastai/data.core.html#Datasets"><code>Datasets</code></a> object to represent it:</p> <div class="language-python extra-class"><pre class="language-python"><code>dsets<span class="token punctuation">.</span>show<span class="token punctuation">(</span>dsets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="output_62_0.png" alt="png"></p> <p>Now if we want to build a <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> from this object, we need to add a few transforms that will be applied at the item level&gt; As we saw before, those transforms will be applied separately on the inputs and targets, using the appropriate implementation for each type (which can very well be don't do anything).</p> <p>Here we need to:</p> <ul><li>resize our images</li> <li>convert them to tensors</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>item_tfms <span class="token operator">=</span> <span class="token punctuation">[</span>ToTensor<span class="token punctuation">,</span> RandomResizedCrop<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> min_scale<span class="token operator">=</span><span class="token number">0.35</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p>Additionally we will need to apply a few transforms on the batch level, namely:</p> <ul><li>convert the int tensors from images to floats, and divide every pixel by 255</li> <li>normalize using the imagenet statistics</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>batch_tfms <span class="token operator">=</span> <span class="token punctuation">[</span>IntToFloatTensor<span class="token punctuation">,</span> Normalize<span class="token punctuation">.</span>from_stats<span class="token punctuation">(</span><span class="token operator">*</span>imagenet_stats<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p>Those two bits could be done per item as well, but it's way more efficient to do it on a full batch.</p> <p>Note that we have more transforms than in the data block API: there was no need to think of <a href="/fastai/data.transforms.html#ToTensor"><code>ToTensor</code></a> or <a href="/fastai/data.transforms.html#IntToFloatTensor"><code>IntToFloatTensor</code></a> there. This is because data blocks come with default item transforms and batch transforms when it concerns transforms you will always need with that type.</p> <p>When passing those transforms to the <code>.dataloaders</code> method, the corresponding arguments have a slightly different name: the <code>item_tfms</code> are passed to <code>after_item</code> (because they are applied after the item has been formed) and the <code>batch_tfms</code> are passed to <code>after_batch</code> (because they are applied after the batch has been formed).</p> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> dsets<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>after_item<span class="token operator">=</span>item_tfms<span class="token punctuation">,</span> after_batch<span class="token operator">=</span>batch_tfms<span class="token punctuation">,</span> bs<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>
</code></pre></div><p>We can then use the traditional <code>show_batch</code> method:</p> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_70_0.png" alt="png"></p> <h2 id="training"><a href="#training" class="header-anchor">#</a> Training</h2> <p>We will start with the usual <a href="/fastai/vision.learner.html#cnn_learner"><code>cnn_learner</code></a> function we used in the <a href="http://docs.fast.ai/tutorial.vision" target="_blank" rel="noopener noreferrer">vision tutorial<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, we will see how one can build a <a href="/fastai/learner.html#Learner"><code>Learner</code></a> object in fastai. Then we will learn how to customize</p> <ul><li>the loss function and how to write one that works fully with fastai,</li> <li>the optimizer function and how to use PyTorch optimizers,</li> <li>the training loop and how to write a basic <a href="/fastai/callback.core.html#Callback"><code>Callback</code></a>.</li></ul> <h3 id="building-a-learner"><a href="#building-a-learner" class="header-anchor">#</a> Building a <a href="/fastai/learner.html#Learner"><code>Learner</code></a></h3> <p>The easiest way to build a <a href="/fastai/learner.html#Learner"><code>Learner</code></a> for image classification, as we have seen, is to use <a href="/fastai/vision.learner.html#cnn_learner"><code>cnn_learner</code></a>. We can specify that we don't want a pretrained model by passing <code>pretrained=False</code> (here the goal is to train a model from scratch):</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> cnn_learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> resnet34<span class="token punctuation">,</span> metrics<span class="token operator">=</span>accuracy<span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre></div><p>And we can fit our model as usual:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>fit_one_cycle<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>2.465585</td> <td>2.208060</td> <td>0.294777</td> <td>00:11</td></tr> <tr><td>1</td> <td>2.404608</td> <td>2.001794</td> <td>0.298854</td> <td>00:11</td></tr> <tr><td>2</td> <td>2.034411</td> <td>2.155173</td> <td>0.370191</td> <td>00:10</td></tr> <tr><td>3</td> <td>1.763775</td> <td>1.583585</td> <td>0.487643</td> <td>00:11</td></tr> <tr><td>4</td> <td>1.543254</td> <td>1.421870</td> <td>0.528408</td> <td>00:13</td></tr></tbody></table> <p>That's a start. But since we are not using a pretrained model, why not use a different architecture? fastai comes with a version of the resnets models that have all the tricks from modern research incorporated. While there is no pretrained model using those at the time of writing this tutorial, we can certainly use them here. For this, we just need to use the <a href="/fastai/learner.html#Learner"><code>Learner</code></a> class. It takes our <a href="/fastai/data.core.html#DataLoaders"><code>DataLoaders</code></a> and a PyTorch model, at the minimum. Here we can use <a href="/fastai/vision.models.xresnet.html#xresnet34"><code>xresnet34</code></a> and since we have 10 classes, we specify <code>n_out=10</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> Learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> xresnet34<span class="token punctuation">(</span>n_out<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metrics<span class="token operator">=</span>accuracy<span class="token punctuation">)</span>
</code></pre></div><p>We can find a good learning rate with the learning rate finder:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>lr_find<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>SuggestedLRs(lr_min=0.0013182567432522773, lr_steep=0.0010000000474974513)
</code></pre></div><p><img src="output_81_2.png" alt="png"></p> <p>Then fit our model:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>fit_one_cycle<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>1.563880</td> <td>1.668477</td> <td>0.480764</td> <td>00:11</td></tr> <tr><td>1</td> <td>1.187707</td> <td>1.145329</td> <td>0.622930</td> <td>00:12</td></tr> <tr><td>2</td> <td>0.969200</td> <td>0.961843</td> <td>0.692229</td> <td>00:11</td></tr> <tr><td>3</td> <td>0.777063</td> <td>0.785314</td> <td>0.748280</td> <td>00:11</td></tr> <tr><td>4</td> <td>0.673000</td> <td>0.715555</td> <td>0.767134</td> <td>00:12</td></tr></tbody></table> <p>Wow this is a huge improvement! As we saw in all the application tutorials, we can then look at some results with:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>show_results<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_85_1.png" alt="png"></p> <p>Now let's see how to customize each bit of the training.</p> <h3 id="changing-the-loss-function"><a href="#changing-the-loss-function" class="header-anchor">#</a> Changing the loss function</h3> <p>The loss function you pass to a <a href="/fastai/learner.html#Learner"><code>Learner</code></a> is expected to take an output and target, then return the loss. It can be any regular PyTorch function and the training loop will work without any problem. What may cause problems is when you use fastai functions like <a href="/fastai/learner.html#Learner.get_preds"><code>Learner.get_preds</code></a>, <a href="/fastai/learner.html#Learner.predict"><code>Learner.predict</code></a> or <a href="/fastai/learner.html#Learner.show_results"><code>Learner.show_results</code></a>.</p> <p>If you want <a href="/fastai/learner.html#Learner.get_preds"><code>Learner.get_preds</code></a> to work with the argument <code>with_loss=True</code> (which is also used when you run<a href="/fastai/interpret.html#ClassificationInterpretation.plot_top_losses"><code>ClassificationInterpretation.plot_top_losses</code></a> for instance), your loss function will need a <code>reduction</code> attribute (or argument) that you can set to &quot;none&quot; (this is standard for all PyTorch loss functions or classes). With a reduction of &quot;none&quot;, the loss function does not return a single number (like a mean or sum) but something the same size as the target.</p> <p>As for <a href="/fastai/learner.html#Learner.predict"><code>Learner.predict</code></a> or <a href="/fastai/learner.html#Learner.show_results"><code>Learner.show_results</code></a>, they internally rely on two methods your loss function should have:</p> <ul><li>if you have a loss that combines activation and loss function (such as <code>nn.CrossEntropyLoss</code>), an <code>activation</code> function.</li> <li>a <code>decodes</code> function that converts your predictions to the same format your targets are: for instance in the case of <code>nn.CrossEntropyLoss</code>, the <code>decodes</code> function should take the argmax.it's</li></ul> <p>As an example, let's look at how to implement a custom loss function doing label smoothing (this is already in fastai as <a href="/fastai/layers.html#LabelSmoothingCrossEntropy"><code>LabelSmoothingCrossEntropy</code></a>).</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">LabelSmoothingCE</span><span class="token punctuation">(</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">'mean'</span><span class="token punctuation">)</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>eps<span class="token punctuation">,</span>self<span class="token punctuation">.</span>reduction <span class="token operator">=</span> eps<span class="token punctuation">,</span>reduction

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> output<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
        c <span class="token operator">=</span> output<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        log_preds <span class="token operator">=</span> F<span class="token punctuation">.</span>log_softmax<span class="token punctuation">(</span>output<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>reduction<span class="token operator">==</span><span class="token string">'sum'</span><span class="token punctuation">:</span> loss <span class="token operator">=</span> <span class="token operator">-</span>log_preds<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            loss <span class="token operator">=</span> <span class="token operator">-</span>log_preds<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#We divide by that size at the return line so sum and not mean</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>reduction<span class="token operator">==</span><span class="token string">'mean'</span><span class="token punctuation">:</span>  loss <span class="token operator">=</span> loss<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> loss<span class="token operator">*</span>self<span class="token punctuation">.</span>eps<span class="token operator">/</span>c <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>self<span class="token punctuation">.</span>eps<span class="token punctuation">)</span> <span class="token operator">*</span> F<span class="token punctuation">.</span>nll_loss<span class="token punctuation">(</span>log_preds<span class="token punctuation">,</span> target<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reduction<span class="token operator">=</span>self<span class="token punctuation">.</span>reduction<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">activation</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>out<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">decodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> out<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>We won't comment on the <code>forward</code> pass that just implements the loss in itself. What is important is to notice how the <code>reduction</code> attribute plays in how the final result is computed.</p> <p>Then since this loss function combines activation (softmax) with the actual loss, we implement <code>activation</code> that take the softmax of the output. This is what will make <a href="/fastai/learner.html#Learner.get_preds"><code>Learner.get_preds</code></a> or <a href="/fastai/learner.html#Learner.predict"><code>Learner.predict</code></a> return the actual predictions instead of the final activations.</p> <p>Lastly, <code>decodes</code> changes the outputs of the model to put them in the same format as the targets (one int for each sample in the batch size) by taking the argmax of the predictions. We can pass this loss function to <a href="/fastai/learner.html#Learner"><code>Learner</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> Learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> xresnet34<span class="token punctuation">(</span>n_out<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loss_func<span class="token operator">=</span>LabelSmoothingCE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metrics<span class="token operator">=</span>accuracy<span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>fit_one_cycle<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>1.752499</td> <td>1.620845</td> <td>0.535796</td> <td>00:11</td></tr> <tr><td>1</td> <td>1.427922</td> <td>1.445637</td> <td>0.610701</td> <td>00:11</td></tr> <tr><td>2</td> <td>1.253892</td> <td>1.305840</td> <td>0.666242</td> <td>00:11</td></tr> <tr><td>3</td> <td>1.116652</td> <td>1.121115</td> <td>0.752102</td> <td>00:12</td></tr> <tr><td>4</td> <td>1.037727</td> <td>1.076632</td> <td>0.769427</td> <td>00:12</td></tr></tbody></table> <p>It's not training as well as before because label smoothing is a regularizing technique, so it needs more epochs to really kick in and give better results.</p> <p>After training our model, we can indeed use <code>predict</code> and <code>show_results</code> and get proper results:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>fnames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>('gas pump',
 tensor(6),
 tensor([0.0110, 0.0205, 0.0441, 0.0137, 0.0504, 0.0360, 0.7745, 0.0230, 0.0195,
         0.0072]))
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>show_results<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_95_1.png" alt="png"></p> <h3 id="changing-the-optimizer"><a href="#changing-the-optimizer" class="header-anchor">#</a> Changing the optimizer</h3> <p>fastai uses its own class of <a href="/fastai/optimizer.html#Optimizer"><code>Optimizer</code></a> built with various callbacks to refactor common functionality and provide a unique naming of hyperparameters playing the same role (like momentum in SGD, which is the same as alpha in RMSProp and beta0 in Adam) which makes it easier to schedule them (such as in <a href="/fastai/callback.schedule.html#Learner.fit_one_cycle"><code>Learner.fit_one_cycle</code></a>).</p> <p>It implements all optimizers supported by PyTorch (and much more) so you should never need to use one coming from PyTorch. Checkout the <a href="/fastai/optimizer.html"><code>optimizer</code></a> module to see all the optimizers natively available.</p> <p>However in some circumstances, you might need to use an optimizer that is not in fastai (if for instance it's a new one only implemented in PyTorch). Before learning how to port the code to our internal <a href="/fastai/optimizer.html#Optimizer"><code>Optimizer</code></a> (checkout the <a href="/fastai/optimizer.html"><code>optimizer</code></a> module to discover how), you can use the <a href="/fastai/optimizer.html#OptimWrapper"><code>OptimWrapper</code></a> class to wrap your PyTorch optimizer and train with it:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@delegates</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>AdamW<span class="token punctuation">.</span>__init__<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pytorch_adamw</span><span class="token punctuation">(</span>param_groups<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> OptimWrapper<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>AdamW<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'params'</span><span class="token punctuation">:</span> ps<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">}</span> <span class="token keyword">for</span> ps <span class="token keyword">in</span> param_groups<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>We write an optimizer function that expects <code>param_groups</code>, which is a list of list of parameters. Then we pass those to the PyTorch optimizer we want to use.</p> <p>We can use this function and pass it to the <code>opt_func</code> argument of <a href="/fastai/learner.html#Learner"><code>Learner</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> Learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> xresnet18<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> metrics<span class="token operator">=</span>accuracy<span class="token punctuation">,</span>
                loss_func<span class="token operator">=</span>LabelSmoothingCrossEntropy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                opt_func<span class="token operator">=</span>partial<span class="token punctuation">(</span>pytorch_adamw<span class="token punctuation">,</span> wd<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>We can then use the usual learning rate finder:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>lr_find<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>SuggestedLRs(lr_min=0.09120108485221863, lr_steep=0.004365158267319202)
</code></pre></div><p><img src="output_102_2.png" alt="png"></p> <p>Or <code>fit_one_cycle</code> (and thanks to the wrapper, fastai will properly schedule the beta0 of AdamW).</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>fit_one_cycle<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>3.222441</td> <td>2.555031</td> <td>0.419108</td> <td>00:09</td></tr> <tr><td>1</td> <td>2.290207</td> <td>2.202564</td> <td>0.575796</td> <td>00:08</td></tr> <tr><td>2</td> <td>2.075831</td> <td>2.144120</td> <td>0.603567</td> <td>00:08</td></tr> <tr><td>3</td> <td>1.925448</td> <td>1.902397</td> <td>0.704713</td> <td>00:08</td></tr> <tr><td>4</td> <td>1.881001</td> <td>1.880926</td> <td>0.713121</td> <td>00:09</td></tr></tbody></table> <h3 id="changing-the-training-loop-with-a-callback"><a href="#changing-the-training-loop-with-a-callback" class="header-anchor">#</a> Changing the training loop with a <a href="/fastai/callback.core.html#Callback"><code>Callback</code></a></h3> <p>The base training loop in fastai is the same as PyTorch's:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> xb<span class="token punctuation">,</span>yb <span class="token keyword">in</span> dl<span class="token punctuation">:</span>
    pred <span class="token operator">=</span> model<span class="token punctuation">(</span>xb<span class="token punctuation">)</span>
    loss <span class="token operator">=</span> loss_func<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> yb<span class="token punctuation">)</span>
    loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
    opt<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
    opt<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>where <code>model</code>, <code>loss_func</code> and <code>opt</code> are all attributes of our <a href="/fastai/learner.html#Learner"><code>Learner</code></a>. To easily allow you to add new behavior in that training loop without needing to rewrite it yourself (along with all the fastai pieces you might want like mixed precision, 1cycle schedule, distributed training...), you can customize what happens in the training loop by writing a callback.</p> <p><a href="/fastai/callback.core.html#Callback"><code>Callback</code></a>s will be fully explained in an upcoming tutorial, but the basics are that:</p> <ul><li>a <a href="/fastai/callback.core.html#Callback"><code>Callback</code></a> can read every piece of a <a href="/fastai/learner.html#Learner"><code>Learner</code></a>, hence knowing everything happening in the training loop</li> <li>a <a href="/fastai/callback.core.html#Callback"><code>Callback</code></a> can change any piece of the <a href="/fastai/learner.html#Learner"><code>Learner</code></a>, allowing it to alter the behavior of the training loop</li> <li>a <a href="/fastai/callback.core.html#Callback"><code>Callback</code></a> can even raise special exceptions that will allow breaking points (skipping a step, a validation phase, an epoch or even cancelling training entirely)</li></ul> <p>Here we will write a simple <a href="/fastai/callback.core.html#Callback"><code>Callback</code></a> applying <a href="https://arxiv.org/abs/1710.09412" target="_blank" rel="noopener noreferrer">mixup<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to our training (the version we will write is specific to our problem, use fastai's <a href="/fastai/callback.mixup.html#MixUp"><code>MixUp</code></a> in other settings).</p> <p>Mixup consists in changing the inputs by mixing two different inputs and making a linear combination of them:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token builtin">input</span> <span class="token operator">=</span> x1 <span class="token operator">*</span> t <span class="token operator">+</span> x2 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t<span class="token punctuation">)</span>
</code></pre></div><p>Where <code>t</code> is a random number between 0 and 1. Then, if the targets are one-hot encoded, we change the target to be</p> <div class="language-python extra-class"><pre class="language-python"><code>target <span class="token operator">=</span> y1 <span class="token operator">*</span> t <span class="token operator">+</span> y2 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t<span class="token punctuation">)</span>
</code></pre></div><p>In practice though, targets are not one-hot encoded in PyTorch, but it's equivalent to change the part of the loss dealing with <code>y1</code> and <code>y2</code> by</p> <div class="language-python extra-class"><pre class="language-python"><code>loss <span class="token operator">=</span> loss_func<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> y1<span class="token punctuation">)</span> <span class="token operator">*</span> t <span class="token operator">+</span> loss_func<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> y2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>t<span class="token punctuation">)</span>
</code></pre></div><p>because the loss function used is linear with respect to y.</p> <p>We just need to use the version with <code>reduction='none'</code> of the loss to do this linear combination, then take the mean.</p> <p>Here is how we write mixup in a <a href="/fastai/callback.core.html#Callback"><code>Callback</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> torch<span class="token punctuation">.</span>distributions<span class="token punctuation">.</span>beta <span class="token keyword">import</span> Beta
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Mixup</span><span class="token punctuation">(</span>Callback<span class="token punctuation">)</span><span class="token punctuation">:</span>
    run_valid <span class="token operator">=</span> <span class="token boolean">False</span>
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>distrib <span class="token operator">=</span> Beta<span class="token punctuation">(</span>tensor<span class="token punctuation">(</span>alpha<span class="token punctuation">)</span><span class="token punctuation">,</span> tensor<span class="token punctuation">(</span>alpha<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">before_batch</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>t <span class="token operator">=</span> self<span class="token punctuation">.</span>distrib<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>y<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>x<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        shuffle <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span>self<span class="token punctuation">.</span>y<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>x<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        x1<span class="token punctuation">,</span>self<span class="token punctuation">.</span>y1 <span class="token operator">=</span> self<span class="token punctuation">.</span>x<span class="token punctuation">[</span>shuffle<span class="token punctuation">]</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>y<span class="token punctuation">[</span>shuffle<span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>xb <span class="token operator">=</span> <span class="token punctuation">(</span>x1 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>self<span class="token punctuation">.</span>t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>x <span class="token operator">*</span> self<span class="token punctuation">.</span>t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">after_loss</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> NoneReduce<span class="token punctuation">(</span>self<span class="token punctuation">.</span>loss_func<span class="token punctuation">)</span> <span class="token keyword">as</span> lf<span class="token punctuation">:</span>
            loss <span class="token operator">=</span> lf<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pred<span class="token punctuation">,</span>self<span class="token punctuation">.</span>y1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>self<span class="token punctuation">.</span>t<span class="token punctuation">)</span> <span class="token operator">+</span> lf<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pred<span class="token punctuation">,</span>self<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>t
        self<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>loss <span class="token operator">=</span> loss<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>We can see we write two events:</p> <ul><li><code>before_batch</code> is executed just after drawing a batch and before the model is run on the input. We first draw our random numbers <code>t</code>, following a beta distribution (like advised in the paper) and get a shuffled version of the batch (instead of drawing a second version of the batch, we mix one batch with a shuffled version of itself). Then we set <code>self.learn.xb</code> to the new input, which will be the on fed to the model.</li> <li><code>after_loss</code> is executed just after the loss is computed and before the backward pass. We replace <code>self.learn.loss</code> by the correct value. <a href="/fastai/layers.html#NoneReduce"><code>NoneReduce</code></a> is a context manager that temporarily sets the reduction attribute of a loss to 'none'.</li></ul> <p>Also, we tell the <a href="/fastai/callback.core.html#Callback"><code>Callback</code></a> it should not run during the validation phase with <code>run_valid=False</code>.</p> <p>To pass a <a href="/fastai/callback.core.html#Callback"><code>Callback</code></a> to a <a href="/fastai/learner.html#Learner"><code>Learner</code></a>, we use <code>cbs=</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> Learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> xresnet18<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> metrics<span class="token operator">=</span>accuracy<span class="token punctuation">,</span>
                loss_func<span class="token operator">=</span>LabelSmoothingCrossEntropy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cbs<span class="token operator">=</span>Mixup<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                opt_func<span class="token operator">=</span>partial<span class="token punctuation">(</span>pytorch_adamw<span class="token punctuation">,</span> wd<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Then we can combine this new callback with the learning rate finder:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>lr_find<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>SuggestedLRs(lr_min=0.07585775852203369, lr_steep=0.005248074419796467)
</code></pre></div><p><img src="output_114_2.png" alt="png"></p> <p>And combine it with <code>fit_one_cycle</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>fit_one_cycle<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>2.987924</td> <td>2.508427</td> <td>0.451465</td> <td>00:09</td></tr> <tr><td>1</td> <td>2.480293</td> <td>2.232779</td> <td>0.593885</td> <td>00:08</td></tr> <tr><td>2</td> <td>2.286732</td> <td>2.082053</td> <td>0.635159</td> <td>00:10</td></tr> <tr><td>3</td> <td>2.162914</td> <td>1.828538</td> <td>0.726115</td> <td>00:09</td></tr> <tr><td>4</td> <td>2.101327</td> <td>1.752887</td> <td>0.762293</td> <td>00:09</td></tr></tbody></table> <p>Like label smoothing, this is a callback that provides more regularization, so you need to run more epochs before seeing any benefit. Also, our simple implementation does not have all the tricks of the fastai's implementation, so make sure to check the official one in <a href="/fastai/callback.mixup.html"><code>callback.mixup</code></a>!</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/fastai/assets/js/app.e4c088e4.js" defer></script><script src="/fastai/assets/js/2.f1c4f916.js" defer></script><script src="/fastai/assets/js/56.5f3c1da5.js" defer></script>
  </body>
</html>
